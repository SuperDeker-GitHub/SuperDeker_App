<!DOCTYPE html>

<!-- VERSION 1.35
	Corrige un problema de los PDFS que cuando se cargan muchos se guinda..
	Faltaba un pdf.destroy cuando se carga de un archivo.

	<!-- VERSION 1.34
	Cuando solo hay una opcion en un spin, se activa el mismo, si hay varios le muestra el 0 que es Selecciona...
	Corregido el cambio de spins con source en condicionales
	Los Checks o radios pueden tener un source para su creacion

<!-- VERSION 1.33
	Se volvio a programar toda la parte de muestra de dataclips en el Grid de Muuri.
	Se hizo un template de dataclip en Vuejs y luego se incluye en Muuri.
	Es mucho mas rapido porque todo el procesamiento de UI se hace localmente en javascript
	Ya los enters en los EditML no muestran los //n sino como debe ser (1.33.1)
	Se agrego la posibilidad de buscar no solo en los DC sino llamando un httpget desde el SrcTxt
	Cuando viene el json de retorno en DCFoto viene el filename y DCFotobase64 viene el codigo base64 de la foto jpeg
	Se paso el getDcData como un promise, para evitar carreras criticas
	Ya la camara no se queda nunca prendida al principio
	Si el tipo de un componente del dataclip es Date o Time le puedes poner al valor 'now' en el json para que se inicialice con el dia u hora actual
	Puedes imprimir reportes, graficos y Dataclips

<!-- VERSION 1.32
	Puedes buscar en varios dataclips a la vez
	Puedes indicar que la busqueda es requerida
	Puedes agregar que se bloqueen los campos que indiques cuando busques un DC y bajes la informacion
	Se define el atributo unique para los campos de los dataclips, si uno es unique no debe estar otro dataclip de ese tipo con el campo/valor
	Si hay un campo unique, al modificar el dataclip, no se puede editar ese campo/valor
	Se puede hacer una busqueda exacta o like, si se define en el SrcTxt typesearch como exact o like
	Cualquier DC puede ser NoShow, esto para permitir que DataClips que genera IOT u otro sistema, no se pueda incluir a mano, pero si en  un reporte


<!-- VERSION 1.31
	Se agrego el manejo de Perfiles de seguridad, cada usuario tiene capacidades o limitaciones.
	el codigo de los DataClips no importa el case (mayuscula o minuscula)
	corrige un cambio que hizo google del manejo de los headers en los data structures de los charts
	se agrega el tipo EdtAlert para mostrar en rojo cualquier texto que quieres que resalte, si el campo no tiene texto no aparece ni el texto ni el campo en blanco
	se agregan las solicitudes de aprobacion biometrica
	se agrega la seguridad a los reportes
	todos los script js estan locales en el servidor de Dossier salvo el de google maps

<!-- VERSION 1.30
	Se agrego el manejo de PDFs, se pueden agregar y revisar cuando se crea o modifica un dataclip
	Tambien puedes sacar reportes de activos o historicos
	Se elimina el arreglo iconosgrupo porque ya no hace falta
	Puedes cambiar el tama�o de los charts en estadisticas
	Los mensajes de error est�n un poco mas claros y espec�ficos

<!-- VERSION 1.29
	Se agrego el manejo de Historicos de manera tal que no aparece informacion sobre historicos en reportes ni sourcedc


<!-- VERSION 1.28
	Se agrego el reporte custom
	La funcionalidad de Sello se agrego y ahora se puede solicitar en los spin los Dc que tengan el sello(status) determinado
	Puedes solicitar en un spin de Dcs que solo te traiga los que no estan ya en el DC que incluye el spin, esto es util para evitar errores de spins que se cargan mas de una vez y eso no tiene sentido
	Ahora puedes borrar de los dataclips las fotos asociadas si te equivocaste.

<!-- VERSION 1.27
Se le agreg� la siguiente funcionalidad:
	Se integra el JWT para credenciales.
Esta version corrige 

<!-- VERSION 1.26
Se le agreg� la siguiente funcionalidad:
	Se integra el JWT para credenciales.
Esta version corrige cuando el valuetobe es un spin y tiene sourceof, se cargan los valores del sourceof en el dataclip
limpia los //n cuando se llama al arraytodom al jsontodom o cuando viene de un thisDossier.Dc.field

<!-- VERSION 1.25
Se le agreg� la siguiente funcionalidad:
	Graba dataclips de Totales cuando hay algun cambio que afecta al total segun el calculo.
	Si habia uno anteriormente lo pone como no valido y lo apunta al nuevo, como cualquier dataclip
	Agrega un tipo DCLink que permite grabar una copia de un DC a un rex sin necesidad de tener un spin con source.
	En el DCLink se debe indicar CopyToSource:true para que copie.
Esta version corrige el JsonToDom cuando el spin tiene el dclink asociado. Ahora lo selecciona correctamente

Esta version permite definir grupos de usuarios que comparten el calendario.
	
	
<!-- VERSION 1.24
Esta version corrige:
	Se muestran las fechas de vencimiento en rojo
	La primera vez que se selecciona un rex desde el calendario, traia un rex equivocado
	
	
Se le agreg� la siguiente funcionalidad:
	Se muestran las copias con fondo amarillo y se borra el sello y el editdc cuando son copias
	Ahora las citas tienen el campo Nombre (en lugar de contacto)
	Los nombres que aparecen en la cita ahora son los del comment en el DC en lugar de observacion de la cita
	El atributo de Autosave permite grabar directamente un dossier sin dejarlo en memoria
	Los campos basicos de una linea puedes agregarle el Source como si fuera un spin, pero limpia el dc(
	Puedes agregar Citas Custom

<-->


<!-- VERSION 1.23
Esta version corrige:
	cuando se creaban DCs sin TituloDossier definido, se modificaba el titulo de Dossier a "undefined"
	Cuando seleccionas un DC, y vas a cargar uno nuevo, te permite importar el seleccionado
	
	
Se le agreg� la siguiente funcionalidad:
	Se agrega el tipo EdtPR, que es para traer datos y que esten progegidos, no se pueden modificar
	Se incluye que cuando el rethead es "FechaVencimiento" es para indicar los vencimientos de documentos. En CUANDO se muestra los vencimientos en rojo

<-->

<html>
<title>Inteam dossier</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="assets/css/w3.css">
<link rel="stylesheet" href="assets/css/w3-theme-black.css">
<link rel="stylesheet" href="assets/css/font-awesome.min.css">
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
<script src="js/jquery.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/jquery-ui.js"></script> -->
<script src="js/jquery-ui.js"></script>
<link rel="stylesheet" href="assets/css/buscarexs.css">
<!-- <link rel="stylesheet" type="text/css" href="https://unpkg.com/vue-airbnb-style-datepicker@2.7.1/dist/vue-airbnb-style-datepicker.min.css"> -->
<link rel="stylesheet" type="text/css" href="assets/css/vue-airbnb-style-datepicker.min.css">
<link rel="stylesheet" href="assets/css/rex.css">
<link rel="stylesheet" href="assets/css/dcdetails.css">
<link rel="stylesheet" href="assets/css/muurigrid.css">
<!-- <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script> -->
<script src="js/signature_pad.min.js"></script>

<!-- <script src="https://unpkg.com/dexie/dist/dexie.js"></script> -->
<script src="js/dexie.js"></script>
<script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>
<!-- <script src="js/pdfjs-dist/build/pdf.js"></script> -->

<script src="js/CurrentLanguage.js"></script>

<!-- apple icons -->
<link rel="apple-touch-icon" href="touch-icon-iphone.png">
<link rel="apple-touch-icon" sizes="152x152" href="touch-icon-ipad.png">
<link rel="apple-touch-icon" sizes="180x180" href="touch-icon-iphone-retina.png">
<link rel="apple-touch-icon" sizes="167x167" href="touch-icon-ipad-retina.png">Notification   
<style>


.datepicker-container {
  margin-bottom: 0px;-- v
}

#datepicker-button-trigger,#datepicker-Chart-button-trigger {
  background: #ddd;
  border: 1px solid #ddd;
  color: black;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 15px;
  font-weight: bold;
  text-align: center;
  min-width: 100%;
}

</style>
<style>
.SearchForm{
width:350px;
background-color:rgb(255,255,255,0.75);
 border: 1px solid #000;
padding: 10px;
//max-height:400px; 
//overflow-x: scroll;
}

/* Style inputs, select elements and textareas */
input[type=text], select, textarea{
  width: 100%;
  padding: 2px;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
  resize: vertical;
}

/* Style the label to display next to the inputs */
label {
  padding: 2px 2px 2px 0;
  display: inline-block;
}

/* Style the submit button */
input[type=submit] {
  background-color: #4CAF50;
  color: white;
  padding: 2px 2px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  float: right;
}

/* Style the container */
/*.container {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 20px;
}*/

/* Floating column for labels: 25% width */
.col-25 {
  float: left;
  width: 25%;
  margin-top: 6px;
}

/* Floating column for inputs: 75% width */
.col-75 {
  float: left;
  width: 75%;
  margin-top: 6px;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .col-25ex, .col-75ex, input[type=submit] {
    width: 100%;
    margin-top: 0;
  }
  .asd__wrapper--datepicker-open {
	margin-left: 75px;
  }
  .asd__wrapper {
	margin-left: 75px;
  }
}
.is-collapsed {	
	display: none;
}
</style>
<style>
.editorcontainer {
  max-width: 100%;
  position: relative;
  margin: auto;
  height:490px;
  margin-left: auto;
  margin-right: auto;
  width: -webkit-fill-available;
  text-align: center;
}
.RexEdSlides {
	display: table-cell;
    height: 100%;
    text-align: center;
    width: 100%;
    vertical-align: middle;
}
.RexEdDcs {
	display: table-cell;
    height: 100%;
    text-align: center;
    width: 100%;
    vertical-align: middle;
}
.editorcontainer div {
	vertical-align: middle;
	width: 500px;
}
.RexEdSlides img {
	vertical-align: middle;
	height: -webkit-fill-available;
	max-width: 100%;
	max-height:-webkit-fill-available;
	width: auto;
	height: auto;
}


/* Slideshow container */
.slideshow-container {
  max-width: 100%;
  position: relative;
  margin: auto;
}

/* Next & previous buttons */
.rexedprev, .rexednext, .rexedprevDc, .rexednextDc {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -22px;
  color: white;
  font-weight: bold;
  font-size: 18px;
  transition: 0.6s ease;
  border-radius: 0 3px 3px 0;
}

/* Position the "next button" to the right */
.rexednext {
  right: 0;
  border-radius: 3px 0 0 3px;
	background-color: rgba(0,0,0,0.4);
}


/* Position the "next button" to the right */
.rexedprev {
  left: 0;
  border-radius: 3px 0 0 3px;
	background-color: rgba(0,0,0,0.4);
}


/* On hover, add a black background color with a little bit see-through */
.rexedprev:hover, .rexednext:hover {
  background-color: rgba(0,0,0,0.8);
}

.rexednextDc {
  display:none;

  right: 0;
  border-radius: 3px 0 0 3px;
	background-color: rgba(0,0,0,0.4);
}

.rexedprevDc{
  display:none;

  left: 0;
  border-radius: 3px 0 0 3px;
	background-color: rgba(0,0,0,0.4);
}
.rexedprevDc:hover, .rexednextDc:hover {
  background-color: rgba(0,0,0,0.8);
}


/* Caption text */
.rexedtext {
  color: #f2f2f2;
  font-size: 15px;
  padding: 8px 12px;
  position: absolute;
  bottom: 8px;
  width: 100%;
  text-align: center;
  background-color: rgba(0,0,0,0.4);
}

/* Number text (1/3 etc) */
.redexnumbertext {
  display:none;
  color: #f2f2f2;
  font-size: 12px;
  padding: 8px 12px;
  position: absolute;
  top: 0;
  background-color: rgba(0,0,0,0.4);
}
.dottonera{
	position:relative;
	text-align:
	center;top:-2em;
}


/* The dots/bullets/indicators */
.rexeddot {
  display:none;
  cursor: pointer;
  height: 15px;
  width: 15px;
  margin: 0 2px;
  background-color: #bbb;
  border-radius: 50%;
  display: inline-block;
  transition: background-color 0.6s ease;
}
.rexeddotDc {
  display:none;
  cursor: pointer;
  height: 15px;
  width: 15px;
  margin: 0 2px;
  background-color: #bbb;
  border-radius: 50%;
  display: inline-block;
  transition: background-color 0.6s ease;
}

.rexedactive, .rexeddot:hover, .rexeddotDc:hover {
  background-color: #717171;
}

/* Fading animation */
.fade {
  -webkit-animation-name: fade;
  -webkit-animation-duration: 1.5s;
  animation-name: fade;
  animation-duration: 1.5s;
}

@-webkit-keyframes fade {
  from {opacity: .4} 
  to {opacity: 1}
}

@keyframes fade {
  from {opacity: .4} 
  to {opacity: 1}
}

/* On smaller screens, decrease text size */
@media only screen and (max-width: 300px) {
  .rexedprev, .rexednext,.rexedtext, .rexedprevDc, .rexednextDc {font-size: 11px}
}
.tool-item{
	padding-left:4px;
	padding-right:3px;
	height:1em; 
	width:auto;
}
.tool-item:hover{
	background-color: #717171;
}
.allways-on-tools{
	padding-left:7px;
}
#SetMapPins{
	margin-left: 16px;
	padding:4px;
}

#SetMapPins:hover{
	background-color: #ccc;
}

.img-magnifier-container {
  position:relative;
  z-index:20;
}

.img-magnifier-glass {
  position: absolute;
  border: 3px solid #000;
  border-radius: 50%;
  cursor: none;
  /*Set the size of the magnifier glass:*/
  width: 100px;
  height: 100px;
  z-index:21;
}

#DCContainer hr{
    border-top: 1px solid #ff9800;
	margin: 0px;
}
</style>

<style>
#cameracontainer {
    margin: 0px auto;
    width: 520px;
    height: 450px;
    border: 10px #333 solid;
}
#videoElement2 {
    width: 500px;
    height: 375px;
    background-color: #ff98005c;
}
#cameracanvas2{width:500px;height:375px;}
#videoElement2 button{clear:both;margin:30px;}


#videoElement {
	display: block;
    width: 100%;
    height: auto;
    background-color: transparent;
    max-height: -webkit-fill-available;
	border-color:black;
	border-style: solid;
}

.videoCont {
			display:block;
			width:100%,
			height:auto;
			background-image: url(assets/silueta.png);
			background-repeat: no-repeat; 
			background-size: contain;
			background-position-y: top; 
			background-position-x: center; 
			max-height: -webkit-fill-available;
			border-color: black;
			border-style: solid;
}

#cameracanvas{
    width: 100%;
    height: auto;
    border-color: black;
	max-width: 20%;
	border-radius: 10%;
    border-style: solid;
}

.overlay {
	position:fixed;
    top: 75%;
    width: 100%;
    opacity: 1;
    transition: .3s ease;
	height:25%;
}
.close_overlay{
	position: fixed;
    top: 3%;
    width: 100%;
    opacity: 1;
    transition: .3s ease;
}

#container {
 width:100%;
 height:100%;
 left:0px;
 top: 0px;
 text-align:center;
 z-index:150;
 position:fixed;
 background-color:gray;
}
.overlay > div {
 width: 25%;  
 display: inline-block;
 vertical-align: text-bottom;
 text-align:left;
 margin:5px;    
 padding:5px;
 height:100%;
}


.close_overlay > div {
 width: 95%;  
 display: inline-block;
 vertical-align: text-top;
 margin:5px;    
 padding:5px;
}
button:focus { 
  border-color: transparent;
}

.DataClipInst{
	border: 1px solid black;
}

.DCSelected {
	border-color: black;
    border-style: solid;
    border-radius: 10px;
    border-width: thick;
}

.splash {
	display:block;
	z-index:300;
	left:0px;
	top:0px;
	width:100%;
	height:100%;
	position:absolute;
	text-align:-webkit-center;
	valign:middle;
	background-color:white;
    -webkit-transition: all 0.3s 0.3s ease-out; 
	transition: all 1s ease-in-out;
}
.splash > img {
	position: relative;
	top: 25%;
	transform: translateY(0%);
}

.hideSplash {
  visibility: hidden;
  opacity: 0;
  transition: visibility 0s 2s, opacity 2s linear;
}

</style>

    <!--Load the AJAX API-->
<!-- <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script> -->
<script type="text/javascript" src="js/loader.js"></script>
     <script type="text/javascript">
	//var langtext=[]; Esto esta definido en CurrentLanguage.js

      // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart','table']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(drawIt);

      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawIt() {

        // Create the data table.
        var data = new google.visualization.DataTable();
		data.addColumn('string', 'Data1');
		data.addColumn('number', langtext[0].Cantidad);
		
        data.addRows([
          ['Item1', 3],
          ['Item2', 1],
          ['Item3', 1],
          ['Item4', 1],
          ['Item5', 2]
        ]);

        // Set chart options
		var options = {'title':langtext[0].Ejemplo1,is3D:true};
		

        // Instantiate and draw our chart, passing in some options.
        //var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
        //chart.draw(data, options);
        chart = new google.visualization.PieChart(document.getElementById('chart_div1'));
		options = {'title':langtext[0].Ejemplo1,is3D:true};
		chart.draw(data, options);
		chart = new google.visualization.LineChart(document.getElementById('chart_div2'));
		options = {'title':langtext[0].Ejemplo2,curveType: 'function', legend: { position: 'none' }};
        chart.draw(data, options);
		chart = new google.visualization.ColumnChart(document.getElementById('chart_div3'));
		options = {'title':langtext[0].Ejemplo3};
        chart.draw(data, options);
      }
    </script>

<body id="myPage" onload="initRexs()">

<div id="splashscreen" class="splash">
	<img id="SplashLogo" src="assets/DossierSplashLogo.png" alt="Dossier" >
	<img id="loading" src="assets/loading.gif" alt="Loading..." >	
	<form id="LoginBox" class="w3-container w3-card-4 w3-center" style="width: 300px;margin-top:50px;display:none">
		<Table  width="100%">
			<tr>
			<td class="col-25">
			<label for="enTitulo">
				<i class="fa fa-user-circle-o" style="font-size:1.5em;color:grey;" id="IngresaId" title="Ingresa tu identificacion"></i>
			</label>
		  </td>
		  <td class="col-75">
			<span>
				<input id="Login_User" type="text" style="width:90%;" autofocus >				
			</span>
		  </td>
		  </tr>
	  </Table>
	  <TABLE width="100%">
		<tr>
		<td class="col-25">
		<label for="Pwd">
			<i class="fa fa-lock" style="font-size:1.5em;color:grey;" id="IngresaPwd" title="Ingresa tu Clave"></i>
		</label>
		</td>
		  <td class="col-75">
			<span>
				<input id="Login_PWD" type="password" style="width:90%;">				
			</span>
		  </td>
		  </tr>
	  </table>
	  <div class="col-25">
	  </div>			  
		<div class="col-75">
			<div class="btn-group btn-group-lg w3-right" id="busquedas">
				<button id="EnterButt" type="button" class="w3-button w3-custom w3-padding-large w3-hover-black" style="font-size: 12px" onclick="app.loginRex(document.getElementById('Login_User').value,document.getElementById('Login_PWD').value);">
					Ingresar
				</button>
			</div>
		</div>
	  
	  <div class="col-75">
		<span>
		<span style="font-size:10px;">V.1.35 Rev.6<span>
		</span>
	  </div>
	  <div class="col-25">
	  </div>			  
		<div class="col-75">
			
		</div>
		
		
	</form>
</div>


<div class="select" style="display:none;">
      <select id="videoSource"></select>
</div>

<div id="container" class="" style="display:none;" >
	<div class="videoCont">
		<video id="videoElement" style="opacity:0.8;"autoplay playsinline>    
		</video>
	</div>
	<div class="close_overlay" >
		<div><a class="w3-bar-item w3-button w3-left w3-custom" onclick="closeModalCamera();"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a></div>
	</div>
	<div class="overlay" >
			<div><button id="NextCamera" style="border-radius: 50%; border-style: solid; border-color: black;border-style: solid;background-color:white;height:70px;width:70px; position:absolute;bottom:20px;" onclick="NextCamera()"><img src="assets/flip.png" id="NextCameraIcon" alt="Otra Camara" width="40px" height="auto"></button></div>
			<div><button  style="border-radius: 50%;background-color:white;height:70px;width:70px;border-style: solid;border-color: black; position:absolute;bottom:20px;" onclick="TakeFoto()"><img src="assets/camara.png" width="40px" id="TakeFotoIcon" height="auto" alt="Toma Foto"></button></div>
			<div onclick="acceptImagefromVideo();closeModalCamera();" ><canvas id="cameracanvas" style="display:none; position:absolute;bottom:20px;"></canvas></div>
	</div>
</div>

 <div id="ModalCamera" class="w3-modal" style="z-index:200;">
	<div id="cameracontainer" class="w3-modal-content w3-card-4">
		<header class="w3-container w3-custom"> 
		  <span style="font-size:21px;">
			<a class="w3-bar-item w3-button w3-left" onclick="closeModalCamera();"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a>
			<span id="CameraTitle" style="font-size:18px;">Camara<span>
			<a class="w3-bar-item w3-button" onclick="video.pause();document.getElementById('camera_accept').style.visibility='visible';" style="font-size:1.5em;"><i class="fa fa-pause"></i></a>
			<a class="w3-bar-item w3-button" onclick="video.play();document.getElementById('camera_accept').style.visibility='hidden';" style="font-size:1.5em;"><i class="fa fa-play"></i></a>
			<a id="camera_accept" class="w3-bar-item w3-button w3-right" style="visibility:hidden;" onclick="acceptImagefromVideo();closeModalCamera();"><img src="drawable/ic_action_accept.png" style="height:2.3em; width:auto;"></a>
		  </span>
		</header>
		<video id="videoElement2" onclick="togglevideo()">    
		</video>
    </div>
 </div>

<!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script> -->
	<script src="js/vue.js"></script>
<!-- 	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/0.7.2/vue-resource.min.js"></script> -->
	<script src="js/vue-resource.min.js"></script>
<!--  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.29.0/date_fns.js"></script> -->
  <script src="js/date_fns.js"></script>
<!-- <script src="https://unpkg.com/vue-airbnb-style-datepicker@2.7.1/dist/vue-airbnb-style-datepicker.min.js"></script> -->
  <script src="js/vue-airbnb-style-datepicker.min.js"></script>

<script>
	Vue.component('rex',{
		props:['rexobj'],
		template:'#rexfolder'
	});
	Vue.component('rex_editor',{
		props:['rexobj'],		
		template:'#rex_ed'
	});
	Vue.component('dc_details',{
		props:['dcobj'],
		template:'#dc_dets'
	});
</script>
<template id="rexfolder">
	<div class ="rex" >
		<div class='container'>
			<img id="RexFolderPortada" class="portada" :src="rexobj.pict" alt="Cover" :onerror="'this.onerror=null;this.src=\'DCImages/default'+ rexobj.grupo + '.jpg\''" >
		</div>		
		<div class="slot-wrapper">
			<slot></slot>
		</div>
		<h3 class="titulo" :title="rexobj.titulo" align="center">{{rexobj.titulo.length<25 ? rexobj.titulo : rexobj.titulo.slice(0,25)+'...' }}</h3>
		<p class="vertical">{{rexobj.repciId}}</p>
		<p class="fecharex" >{{rexobj.when_date}}</p>
		<img class="rexicon item-drag-handle" :src="rexobj.ricon" alt="icon" :title="rexobj.name">
		<img class="authoricon w3-circle" :src="rexobj.aicon" onerror="this.src='aicons/default'+ randomNumber() + '.png'" alt="" :title="rexobj.creator">
		<a class="pin" href="javascript:void(0)" onclick="removeG(this,event)" alt="X" id="closepin" title="click 4 X"><i class="fa fa-remove w3-custom"></i></a>
		<div class="Rexlistcontainer" :items="rexobj.Dcs" ><ol style="list-style-type: disc;"><li v-for="Dc in rexobj.Dcs" :value="Dc.id" onclick="ShowDCinLink(this);" style="font-weight: bold;"><a>{{Dc.text}}</a></li></ol></div>
	</div>			
</template>
<template id="rex_ed">
<div class="w3-card-4 w3-animate-top w3-white" style="width:900px;text-align:-webkit-left;">
    <header class="w3-container w3-custom w3-display-container" style="width:900px"> 
      <span  v-on:click="hideModal();"  class="w3-button w3-custom w3-display-topright"><i class="fa fa-remove"></i></span>
      <h4 id="TituloDossierEditor" >{{rexobj.titulo}}</h4>
      <h5 id="SubTituloDossierEditor"><span id="SubTituloDossierEditorText">Grupo</span>:{{rexobj.nombreGrupo}}, Creador:{{rexobj.creator}}, Tipo Dossier: {{this.$root.GrupoJson.data.logs[rexobj.notift].Desc}}</i></h5>
    </header>
    <div class="w3-container" style="w3-row;min-width:900px">
		<div class ="rex w3-col" style="width:40%" >
			<div class='container'>
				<img id="FotoFachada" class="portada" :src="rexobj.pict" alt="Cover" onclick="ActivateSlides();" onerror="CargaDefault(this);" >
			</div>
			<div class="slot-wrapper">
				<slot></slot>
			</div>
			<h3 class="titulo" align="center">{{rexobj.titulo}}</h3>
			<p class="vertical">{{rexobj.repciId}}</p>
			<p class="fecharex" >{{rexobj.when_date}}</p>
			<img class="rexicon" :src="rexobj.ricon" alt="icon" :title="rexobj.name">
			<img class="authoricon w3-circle" :src="rexobj.aicon" onerror="this.src='aicons/default'+ randomNumber() + '.png'" alt="" :title="rexobj.creator">
			<div class="Rexlistcontainer" :items="rexobj.Dcs" ><ol><li v-for="Dc in rexobj.Dcs" style="font-weight:bold;"><a v-on:click="ShowDC(Dc.id);">{{Dc.text}}</a></li></ol></div>
		</div>
		
		<div id="FotoSlides" class="editorcontainer w3-col" style="width:60%;display:block">
			<div class="RexEdSlides fade" v-for="(foto,index) in rexobj.picfiles">
			  <div style="text-align:center;line-height: 485px;" >
				<img v-show="foto.substr(-3)!='.pdf'" :id="'Foto'+(index+1)" :src="'api/thumb.asp?path='+foto" onerror="CargaDefault(this);" onclick="magnify(this,3)" onmousemove="trackmouse(event)" >
				<div id ="'PdfButtonsM'+(index+1)" v-show="foto.substr(-3)=='.pdf'">
				  <button id="'prevPdfPageM'+(index+1)"><i class="fa fa-arrow-circle-left fa-2x"></i></button>
				  <button id="'nextPdfPageM'+(index+1)"><i class="fa fa-arrow-circle-right fa-2x"></i></button>
				  &nbsp; &nbsp;
				  <span><i class="fa fa-file-o fa-2x"></i>: <span id="'Pdf_page_numM'+(index+1)"></span> / <span id="'Pdf_page_countM'+(index+1)"></span></span>
				</div>
				<canvas v-show="foto.substr(-3)=='.pdf'" id="'Pdf-canvasM'+(index+1)" style="width:100%;height:auto;"></canvas>
			  </div>
			  <div class="redexnumbertext">{{index+1}} / {{rexobj.picfiles.length}}</div>
			</div>
				<a class="rexedprev" onclick="plusSlides(-1)">&#10094;</a>
				<a class="rexednext" onclick="plusSlides(1)">&#10095;</a>
			<div class="dottonera" >
			  <span v-for="(foto,index) in rexobj.picfiles" class="rexeddot" v-on:click="CurrentSlide(index)"></span> 
			</div>
		</div>
		<div id="DcSlides"  class="editorcontainer w3-col" style="width:60%;display:none;">
			<div class="RexEdDcs fade">
			  <div class="redexnumbertext">1 / 1</div>
			  <iframe id="DataClipFrame"  frameborder=0 width=100% height=490px;></iframe>
			</div>
				<a class="rexedprevDc" id="rexedprevDc">&#10094;</a>
				<a class="rexednextDc" id="rexednextDc">&#10095;</a>
			<div class="dottonera" >
			  <span class="rexeddotDc"></span> 
			</div>
		</div>
    </div>
    <footer class="w3-container w3-custom" style="width:900px">
      <div style="font-size:2em;text-align:center;padding: 10px;"><span><img src="drawable/TeamLog Logo 60.png" style="height:1em; width:auto;"><i class="fa fa-wrench" style="padding: 4px"></i>:<span id="tools"><img class="tool-item" src="assets/rot-left.png" id="iconRotateLeft" title="rota a la izq" onclick="rotateImgLeft()"><img class="tool-item" src="assets/rot-right.png" id="iconRotateRight" title="rota a la der" onclick="rotateImgRight()"><a onclick="ZoomIn();"><i class="fa fa-search-plus tool-item" ></i></a><a onclick="AddDataClip();" id="iconAddDC" title="Agregar DataClip"><i class="fa fa-paperclip tool-item"></i></a><a onclick="app.AgregaTarea();" id="iconAddTask" title="Agregar Tarea"><i class="fa fa-clipboard tool-item" ></i></a></span></div>
    </footer>
 </div>
	
</template>

<template id="dc_dets" >
	<div class="dccontainer">
		<div class="dccolumn DataClipInst" :id="'dccolum'+dcobj.id">
			<div class="post-module" id="PostModuleContent"> <!-- class="post-module" -->
			  <div class="thumbnail">
				<div class="fotoautor" id="fotoa">
					<img style="border-radius: 50%;border:black;border-style:solid;" :src="'aicons/user-'+dcobj.fromUser+'.jpg'" :title="dcobj.fromUser"  onerror="this.src='aicons/default0.png'"/> 
				</div>
				<img :id="'DcImg'+dcobj.id" class="dcimage" :src="'DCImages/'+dcobj.filepath" v-show="dcobj.filepath.substr(-4)=='.jpg' || dcobj.filepath.substr(-4)=='.png'" style="background-color:white;display: block;" onpeoerror="this.error=null;DCnoimage(this);" onmousemove="DCtrackmouse(event)" /> <!--v-show="(dcobj.filepath.substr(-4)=='.jpg'|| dcobj.filepath.substr(-4)=='.png'"-->
				<canvas :id="'Pdf-canvasDC'+dcobj.id" v-show="dcobj.filepath.substr(-4)=='.pdf'" style="width:100%;height:auto;"></canvas>
			  </div>
			  <div class="post-content" id="DcContent" style="display:block">
				<div class="category"  id="linkcarpeta"><i class="fa fa-folder-o" style="font-size:18px;" ></i> <span >{{dcobj.titulo}}</span></div> 
				<h1 class="dctitle">{{dcobj.comment}}</h1>
				<h2 class="dcsub_title" :id="'dctype'+dcobj.id">{{dcobj.DCType}}</h2>
				<p class="dcdescription novalido" >
					<Table id='DcTable' class="dctable" border='0' style='padding:4px' width="100%">
					<tr style='word-break: break-word;' v-for="(tupla,tpindex) in dcobj.tuplas" >
						<td style='word-break: initial;vertical-align: baseline;background-color: lightyellow;'>{{tupla.value1}}</td><td style="vertical-align: baseline;background-color: lightyellow;color: lightgrey;">:</td>
						<td :id="'Dc'+dcobj.id+'tuplas2'+tpindex"><div v-html="ShowMultLines(tupla.value2)"></div></td>
						<td>{{tupla.value3}}</td>
						<td>{{tupla.value4}}</td>
						<td>{{tupla.value5}}</td>
					</tr>	
					</Table>
				</p>		

				<div id="DcFooter" class="post-meta">
					<div><span class="comments"><i class="fa fa-user-circle-o"></i><a href="#">{{dcobj.fromUser}}</a></span><span class="timestamp"><i class="fa fa-clock-o"></i> {{dcobj.when_date}}</span></div>
					<div ><span class="comments"><i class="fa fa-map-marker"></i><a href="#">{{dcobj.LocationOrigin}}</a></span><span class="timestamp"><i class="fa fa-wifi"></i> {{dcobj.IP}}</span></div>
				</div>
			  </div>
			</div>
		</div>
  </div>
</template>

<script>
function DCrandomNumber(){
	return (Math.floor(Math.random() * 13));
}

function DCnoimage(image){
	//document.getElementById('DcImg').style.display = 'none';
	return;
	if ("fotoDc.jpg".slice(-3)=='pdf'){
		document.getElementById('DcPdf').src="fotoDc#toolbar=0&page=1&view=FitH";
		normalPdf();
		//document.getElementById('DcContent').style.height = '242px';
	}
	//else{
	//	document.getElementById('DcContent').style.height = '400px';
	//}
}

function DCnoPdf(image){
	document.getElementById('DcPdf').style.display = 'none';
	//if (document.getElementById('DcImg').style.display == 'none')
		//document.getElementById('DcContent').style.height = '400px';
	//else
		//document.getElementById('DcContent').style.height = '242px';
}
var ImageZoomed=false;
var ImageHeight=0;

function DCfullImage(){
	if (document.getElementById('DcImg').style.display=='none'){
		fullPdf();
	}
	else{
		if (!ImageZoomed){
			DcContentHeight = document.getElementById('DcContent').style.height;
			document.getElementById('DcTable').style.display='none';	
			document.getElementById('DcFooter').style.display='none';	
			document.getElementById('DcContent').style.height = '10px';	
			ImageHeight=document.getElementById('DcImg').height*2;
			document.getElementById('DcImg').style.width = '100%'; //200%
			ImageZoomed=true;
		}else{
			DCnormalImage();
		}
	}
}

function DCfullPdf(){
	if (document.getElementById('DcImg').style.display=='none'){
		if (!ImageZoomed){
			DcContentHeight = document.getElementById('DcContent').style.height;
			document.getElementById('DcTable').style.display='none';	
			document.getElementById('DcFooter').style.display='none';	
			document.getElementById('DcContent').style.height = '10px';	
			document.getElementById('DcPdf').style.height='400px';
			ImageHeight=document.getElementById('DcPdf').height;
			document.getElementById('DcPdf').style.width = '100%';
			ImageZoomed=true;
		}
		else{
			DCnormalPdf();
		}
	}
}
function DCtrackmouse(event){
			return;// esto funcionaba perfecto cuando el DcImage era 200% cuando zoom
	if (ImageZoomed){
		var x = event.clientX;
		var y = event.clientY;
		document.getElementById('DcImg').style.top = "-" + (ImageHeight-y)/400*y + "px";
		document.getElementById('DcImg').style.left =  "-" + (x-75) +"px";
	}
}
var DcContentHeight=-1;
function DCnormalImage(){
	if (document.getElementById('DcImg').style.display=='none')
		DCnormalPdf();	
	else{
		if (DcContentHeight==-1)
			DcContentHeight=document.getElementById('DcContent').style.height;
		document.getElementById('DcContent').style.height = DcContentHeight;	
		////document.getElementById('DcTable').style.display='';//'block';	
		document.getElementById('DcFooter').style.display='';//'block';	
			
		document.getElementById('DcImg').style.left = '0px';
		document.getElementById('DcImg').style.top = '0px';
		
		document.getElementById('DcImg').style.width = '100%';
		document.getElementById('DcImg').style.heigth = '100%';
		
		ImageHeight=document.getElementById('DcImg').height;
		ImageZoomed=false;
	}
}

function DCnormalPdf(){
	if (document.getElementById('DcImg').style.display=='none'){
		if (DcContentHeight==-1)
			DcContentHeight=document.getElementById('DcContent').style.height;
		document.getElementById('DcContent').style.height = DcContentHeight;	
		////document.getElementById('DcTable').style.display='';//'block';	
		document.getElementById('DcFooter').style.display='';//'block';	
			
		////document.getElementById('DcPdf').style.left = '0px';
		////document.getElementById('DcPdf').style.top = '0px';
		
		////document.getElementById('DcPdf').style.width = '100%';
		////document.getElementById('DcPdf').style.height = '400px';
		
		////ImageHeight=document.getElementById('DcPdf').height;
		ImageZoomed=false;
	}
}

function DCprevDC(DcId){
	alert ("Prev=>" + DcId);
}


function DCnextDC(DcId){
	alert ("Next=>" + DcId);
}

  
</script>

<div id="app"> <!-- Vuejs app -->

<!-- Sidebar on click -->
<!-- Navbar -->
<div class="w3-top">
 <div class="w3-bar w3-theme-d2 w3-left-align">
  <a class="w3-bar-item w3-button w3-left w3-hover-black w3-custom" href="javascript:void(0);" onclick='w3_open();'><i class="fa fa-bars"></i></a>
  <a onclick="ShowCarpetas()" class="w3-bar-item w3-button w3-hide-small w3-hover-custom logohov" onmouseover="document.getElementById('DossierLogo').src='drawable/TeamLog Logo 60.png'"  onmouseout="document.getElementById('DossierLogo').src='drawable/TeamLogLogo60White.png'"><img id='DossierLogo' src="drawable/TeamLogLogo60White.png" style="height:1em; width:auto;"> <i class="fa fa-folder-o fa-fw"></i> Dossiers</a>
  <a onclick="ShowCarpetas()" class="w3-bar-item w3-button  w3-hide-medium w3-hide-large w3-hover-custom"><i class="fa fa-folder-o fa-fw" style="font-size:1.4em"></i> </a>
  <a  href="#" onclick="ShowMapa()" class="w3-bar-item w3-button w3-hide-small w3-hover-custom"><i class="fa fa-map-marker fa-fw"></i><span id="Donde1">Donde</span></span></a>
  <a id='Donde2' href="#" onclick="ShowMapa()" class="w3-bar-item w3-button w3-hide-medium w3-hide-large w3-hover-custom"><i class="fa fa-map-marker fa-fw" style="font-size:1.4em"></i> </a>
  <a href="#" onclick="ShowCalendario()" class="w3-bar-item w3-button w3-hide-small w3-hover-custom"><i class="fa fa-calendar fa-fw"></i><span id="Cuando1"> Cuando</span></a>
  <a href="#" onclick="ShowCalendario()" class="w3-bar-item w3-button  w3-hide-medium w3-hide-large w3-hover-custom"><i class="fa fa-calendar fa-fw" style="font-size:1.4em"></i> </a>
  <a onclick="ShowDashBoard()" class="w3-bar-item w3-button w3-hide-small w3-hover-custom"><i class="fa fa-bar-chart fa-fw"></i><span id="Estadisticas1"> Estadisticas</span></a>  
  <a onclick="ShowDashBoard()" class="w3-bar-item w3-button  w3-hide-medium w3-hide-large w3-hover-custom"><i class="fa fa-bar-chart fa-fw" style="font-size:1.4em"></i> </a>
  <div class="w3-dropdown-hover w3-right">
    <a class="w3-button w3-hover-custom">
		<img id='aicon' title="menu de sesion" src="" height="24" width="24" class="w3-circle" style="border: 1px solid rgb(2, 26, 64);display:none;">
	</a>
    <div class="w3-dropdown-content w3-bar-block w3-border w3-display-topright">
      <a href="#" class="w3-bar-item w3-button w3-custom" ><img id="menuaicon" src="" height="24" width="24" class="w3-circle w3-right" style="border: 1px solid rgb(2, 26, 64);"></a>
      <a id="CerrarSesion" href="#" class="w3-bar-item w3-button" onclick="loggout(true);">cerrar sesion</a>
      <a id="CambioPwd" href="#" class="w3-bar-item w3-button" onclick="CleanPwds();document.getElementById('ModalCambioPwd').style.display='block';">cambiar clave</a>
    </div>
  </div>
  <!--<a onclick="alert('OK');" class="w3-bar-item w3-button w3-hover-custom w3-right">
	<img id='aicon' title="menu de sesion" src="" onerror="this.src='aicons/default'+ randomNumber() + '.png'" height="24" width="24" class="w3-circle" style="border: 1px solid rgb(2, 26, 64);display:none;">
  </a>-->
 <!--<a  class="w3-bar-item w3-button w3-right w3-hover-custom" title="Grafico" v-on:click="showGrafico();"><i class="fa fa-bar-chart-o"></i></a>
  <div class="w3-dropdown-hover w3-right">
    <button class="w3-button w3-hover-custom"><i class="fa fa-clipboard"></i></button>   
	<div class="w3-dropdown-content w3-card-4 w3-bar-block" style="right:0">
	  <a href="#" class="w3-bar-item w3-button" v-for="tr in Tareas" v-on:click="showRexDC(tr.repciId,tr.idDC)" >{{tr.DescTarea + '>' + tr.FechaTarea }}</a> 									
    </div>
  </div>-->
 
 </div>

  <!-- Navbar on small screens -->
  <div id="navDemo" class="w3-bar-block w3-theme-d2 w3-hide w3-hide-large w3-hide-medium">
    <a id='Donde3' onclick="ShowMapa()" class="w3-bar-item w3-button">Donde</a>
    <a onclick="ShowCarpetas()" class="w3-bar-item w3-button">Dossiers</a>
	<a id=Cuando3" onclick="ShowCalendario()" class="w3-bar-item w3-button">Cuando</a>
	<a id="Estadisticas3" onclick="ShowDashBoard()" class="w3-bar-item w3-button">Estadisticas</a>
	<a id="Graficos3" class="w3-bar-item w3-button" v-on:click="showGrafico();" >Grafico</a>
    <!--<a class="w3-bar-item w3-button" v-on:click="showBusqueda();" >Busqueda</a>-->
  </div>
</div>

<nav class="w3-sidebar w3-bar-block w3-white w3-animate-left w3-card" style="top:40px;display:none;z-index:120;transition: all .4s linear;" id="mySidebar">
  <!--<a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button w3-display-topright w3-text-custom">Cerrar
    <i class="fa fa-remove"></i>
  </a>-->
  <div>
  <form class="SearchForm" >
			<div class="row">
				<div class="col-25">
				<label for="enTitulo">
				<a v-on:click="TraeRexs('');" id="SearchRexButton"><i class="fa fa-search" style="font-size:1.5em;color:grey; hover:orange" id="BuscarEnDossiers" title="Buscar en el contenido de los Dossiers"></i></a>
				<span id="anigif" style="margin-left: 10px;"><img src="assets/cargando.gif" height="24" width="24" ></span>
				</label>
			  </div>
			  <div class="col-75">
				<span>
					<input id="enTitulo" placeholder="Buscar en Dossier" v-model="enTitulo" v-on:keyup="$event.keyCode == 13 ? TraeRexs('') : null" style="width:90%;">
					<a v-on:click="DetallesColapsados=!DetallesColapsados">
						<span v-show="!DetallesColapsados"><i class="fa fa-chevron-up" style="color:grey;"></i></span>
						<span v-show="DetallesColapsados"><i class="fa fa-chevron-down" style="color:grey;"></i></span>
					</a>
				</span>
			  </div>
			</div>
			
			<div class="row" v-show="!DetallesColapsados">
			  <div class="col-25">
				<label for="selgrupo"><i class="fa fa-group" style="font-size:1.5em;color:grey;" id="iconSelectGrupo" title="Para seleccionar el grupo"></i></label>
			  </div>
			  <div class="col-75">
				<select  id="selgrupo" v-model="gruposelected" v-on:change="gruposel()">
					<option id="FirstSelGrupoOption" value="0" >Todos</option>
					<option v-for="gr in grupos"  :value="gr.grupo" >{{gr.name}}</option> 									
				</select>
			  </div>
			</div>
			<div class="row" v-show="!DetallesColapsados">
			  <div class="col-25">
				<label for="selequipo"><i class="fa fa-user-circle-o" style="font-size:1.5em;color:grey;" id="iconSelEquipo" title="Para indicar un solo miembro del grupo"></i></label>
			  </div>
			  <div class="col-75">
				<select id="selequipo" v-model="usuarioselected">
					<option id="FirstSelEquipoOption" value="T" >Todos</option>					
					<option class="v-cloak" v-for="u in users" :value="u.userid">{{u.userid}}</option>
				</select>
			  </div>
			</div>
			<div class="row" v-show="!DetallesColapsados">
			  <div class="col-25">
				<label for="selstatus"><i class="fa fa-folder-o" style="font-size:1.5em;color:grey;" id="SelStatusTitle" title="Para indicar el estado del Dossier"></i></label>
			  </div>
			  <div class="col-75">
				<select id="selstatus" v-model="statusselected">
					<option id="SelStatus1" value="1" >Activos</option>					
					<option id="SelStatus2" value="2" >Historicos</option>
					<option id="SelStatus3" value="3" >Cerrados</option>					
					<option id="SelStatus0" value="0" >Borrados</option>
				</select>
			  </div>
			</div>

			
			<div class="row" v-show="!DetallesColapsados">
			  <div class="col-25">
				<label for="subject"><i class="fa fa-calendar" style="font-size:1.5em; color:grey;" id="iconRangoFecha" title="Indicar el rango de fecha a buscar"></i></label>
			  </div>
			  <div class="col-75">
				<div class="datepicker-container with-button">
								  <div class="datepicker-trigger">
									<button id="datepicker-button-trigger">{{ formatDates(buttonDateOne, buttonDateTwo) || 'Rango Fechas' }}</button>
									<airbnb-style-datepicker
									  :trigger-element-id="'datepicker-button-trigger'"
									  :mode="'range'"
									  :date-one="buttonDateOne"
									  :date-two="buttonDateTwo"
									  :min-date="'2014-08-01'"
									  :fullscreen-mobile="false"
									  :months-to-show="1"
									  :offset-y="10"
									  :offset-x="-50"
									  :trigger="trigger"
									  v-on:date-one-selected="function(val) { buttonDateOne = val }"
									  v-on:date-two-selected="function(val) { buttonDateTwo = val }"
									  v-on:closed="onClosed"
									  v-on:previous-month="onMonthChange"
									  v-on:next-month="onMonthChange"
									></airbnb-style-datepicker>
								  </div>
								  
								  
								  
			  </div>
			  </div>
			</div>
			<div class="row" v-show="!DetallesColapsados">
			<div class="col-25">
			  </div>			  
				<div class="col-75">
					<div class="btn-group btn-group-lg w3-right" id="busquedas" >
						<button type="button" id="BuscarButton" class="w3-button w3-custom w3-padding-large w3-hover-black" style='font-size: 12px' v-on:click="TraeRexs('');">
							<span class="glyphicon glyphicon-search"></span> Buscar
						</button>
					</div>
				</div>
			</div>
		  </form>
	  <div class="">
	   <a onclick="app.TraeRexs('Tareas');" class="w3-bar-item w3-button w3-hover-custom" v-show="Tareas.length>0" ><i class="fa fa-clipboard fa-fw" ></i><span id="CantTareasPend"> Tareas</span> ({{Tareas.length}})</a>
	  <a onclick="app.TraeRexs('Recordatorios');" class="w3-bar-item w3-button w3-hover-custom" v-show="Recordatorios.length>0"><img src="assets/reminder.png"  width="18px"><span id="CantRemindersPend"> Recordatorios</span> ({{Recordatorios.length}})</a>
	  <a onclick="app.TraeRexs('Citas');" class="w3-bar-item w3-button w3-hover-custom" v-show="Citas.length>0"><i class="fa fa-calendar fa-fw"></i><span id="CantDatesPend"> Citas</span> ({{Citas.length}})</a>
	  <a onclick="app.TraeRexs('Vencimientos');" class="w3-bar-item w3-button w3-hover-custom" v-show="Vencimientos.length>0"><i class="fa fa-calendar fa-fw"></i><span id="CantOtherPend"> Vencimientos</span> ({{Vencimientos.length}})</a>
	  <span  v-show="CantNoSyncs>0">
		<a id="enMemoriaButton" onclick="app.TraeNoSyncs();" class="w3-button w3-hover-custom"><i id="synclogo" class="fa fa-refresh fa-fw" style="font-size:1.3em;color:black;"></i><span id="CantEnMemoria"> En Memoria</span> ({{CantNoSyncs}})</a>
		<span style="width: -webkit-fill-available;"> </span>
		<span id='uploadrexs'><a v-on:click="syncDB();" id="ButSubirEnMemoria" title="Subir los Dossiers en memoria" ><span class="w3-button w3-hover-custom" style="width:130px;text-align: -webkit-right;"><i class="fa fa-cloud-upload" style="font-size:1.3em;color:black;"></i></span></a></span>
	  </span>
	  </div>
	<div  id="BusquedaItem" >
		 <div class="w3-custom" id="CantRexs"  align="center" valign="middle" ><span style="cursor:pointer;" v-show="CantRexs>0"><a v-on:click="loadSearchOnMap();" id ="butDondeBusqueda" title="Donde esta la Busqueda"><i id="SetMapPins" class="fa fa-map-pin w3-left" ></i></span></a>
			<span class="badge v-cloak" v-show="CantRexs>0"><span id="CantidadDossiers">Cantidad</span> :{{CantRexs}}</span>
				<span>
					<a v-on:click="ColapsaTodosLosGrupos()"> 
					<span v-show="!RexsColapsados"><i class="fa fa-chevron-up" style="color:black;"></i></span>
					<span v-show="RexsColapsados"><i class="fa fa-chevron-down" style="color:black;"></i></span></a></span>
			<div class="list-group w3-white" id="rexarr" v-show="!RexsColapsados"> <!--style="height:auto; overflow-y: auto;"-->
				<div style="padding-left:0px; padding-right:0px;" v-for="gr in grupos"  :id="'G'+gr.grupo" class="w3-white">
					<a v-on:click="showGrupo('G'+gr.grupo);" width="-webkit-fill-available" >
						<div class="grupoheader" height="4em">
							<div class="w3-row">
							  <div class="w3-col w3-container" style="width:10%;" ><img :src="'ricons/' + gr.grupo + '.png'" height="32" width="auto"></div>
							  <div class="w3-col w3-container" style="width:50%"><span class="grupoheadertext" align="left">{{gr.name}}</span></div>
							  <div class="w3-col w3-container" style="width:10%"><span v-show="GrupoCounter['G'+gr.grupo]>0" style="color:grey;"> ({{GrupoCounter['G'+gr.grupo]}})</span></div>
							  <div class="w3-col w3-container" style="width:10%"><span v-show="(GrupoCounter['G'+gr.grupo]>0) && !ShowGrupo['G'+gr.grupo]"><i class="fa fa-chevron-up" style="color:grey;"></i></span><span v-show="ShowGrupo['G'+gr.grupo]"><i class="fa fa-chevron-down" style="color:grey;"></i></span></div>
							  <div v-show="GrupoPerfil['G'+gr.grupo]>0" :id="'AddGrupo'+gr.grupo" class="w3-col w3-container" style="width:10%"><span  ><a v-on:click="CreateDossier(gr.grupo);nombreGrupo=gr.name;" style="font-size:1.5em;color:grey;"><i class="fa fa-plus-circle"></i></a></span></div>
							</div>
						</div>
					</a>
					<div style="padding-left:0px; padding-right:0px;" v-for="r in rexs" v-if="(r.grupo==gr.grupo)" href="#"  :id="'A' + r.repciId" class="'list-group-item v-cloak"  :Title="'#' + r.repciId + '-' + r.titulo" >
						<a v-on:click="seleccionRex(r);" width="-webkit-fill-available">
							<div class="rextable" v-show="!ShowGrupo['G'+r.grupo]">
								<div class="w3-row">
								  <div class="w3-col w3-container" style="width:70px;padding-left:35px"><img class="w3-circle" :title="r.creator" style="border:1px solid #021a40;" :src="'aicons/user-' + r.creator + '.jpg'" onerror="this.src='aicons/default'+ randomNumber() + '.png'" height="40" width="40"></div>
								  <div class="w3-col w3-container" style="width:70%;">
										<div class="w3-row">
											<span class="TituloRex">{{ r.titulo }}</span> 
										</div>
										<div class="w3-row">
											<span class="FechaHoraRex">{{ formateaFecha(r.when_date) }}</span>
										</div>				
								  </div>
								</div>
							</div>
						</a>
					</div>
				</div>
			</div>
		 </div>
		 </div>
		<a onclick="alert('config');" id="Config" align="left" valign="middle" class="w3-bar-item w3-button w3-border w3-border-black w3-custom"> 
			<span><span id="Version">Configuracion</span> V.1.35 Rev.6 <i class="fa fa-cog" style="color:black; font-size:18px"></i></span>
		</a>	
	</div>		
</nav>

<div id="MainWP" style="transition: all .4s linear;">
		
 <div id="ChartItem" v-bind:class="{'is-collapsed' : ChartColapsado }" style="position:fixed;z-index:7;left:12px; top:60px; background-color: white;border-color:black;border-width:1px;border-style:solid;resize: both;overflow: auto;height:450px;">
	<div id="ChartItemheader" class="w3-custom w3-border-black" style="position:relative;cursor:move;z-index:8;background-color:black; width:100%;height:1.5em;">
		<a><i class="fa fa-bar-chart-o w3-button w3-custom" style="padding: 4px" v-on:click="TipoChart='Bar';GraficoSelected(false);"></i></a>
		<a><i class="fa fa-pie-chart w3-button w3-custom" style="padding: 4px" v-on:click="TipoChart='Pie';GraficoSelected(false);"></i></a>
		<a><i class="fa fa-line-chart w3-button w3-custom" style="padding: 4px" v-on:click="TipoChart='Line';GraficoSelected(false);"></i></a>		
		<a><i class="fa fa-table w3-button w3-custom" style="padding: 4px" v-on:click="TipoChart='Table';GraficoSelected(false);"></i></a>		
		<a><i class="fa fa-refresh w3-button w3-custom" id="iconRefresh" title="refrescar" style="padding: 4px" v-on:click="GraficoSelected(true);"></i></a>
		<a><i class="fa fa-remove w3-button w3-custom w3-display-topright" style="padding: 4px" v-on:click="ChartColapsado=!ChartColapsado"></i></a>
		<span class="w3-display-topright">
			<span v-show="DetallesChartColapsados">
				<a class="w3-button w3-custom" style="padding: 4px" v-on:click="SaveChartDraw(1);"><b>1</b></a>
				<a class="w3-button w3-custom" style="padding: 4px" v-on:click="SaveChartDraw(2);"><b>2</b></a>
				<a class="w3-button w3-custom" style="padding: 4px" v-on:click="SaveChartDraw(3);"><b>3</b></a>
			</span>
			<a><i class="fa fa-remove w3-button w3-custom" style="padding: 4px" v-on:click="ChartColapsado=!ChartColapsado"></i></a>
		</span>
		
	</div>
	<div  class="w3-custom " style="position:relative;z-index:8;background-color:white; width:100%;height:1.5em;">
		<select  id="TipoGrafico" v-model="TipoGrafico" v-on:change="ReportePredeterminado()">
			<option value="1">Custom Report</option>
			<option value="2" >Custom Report</option>
		</select>
	</div>
	<Form id="ChartDetails" width="100%" style="padding:10px;min-height:370px;width:100%;height:-webkit-fill-available;">
			<div class="row">
			  <div class="col-25">				
				<label for="TextoChart">
					<span>
					<a v-on:click="alert('refresh');" id="SearchChartButton"><i class="fa fa-search" style="font-size:1.5em;color:grey; hover:orange" id="GraficarDossiers" title="Graficar Dossiers"></i></a>
					<span id="anigifChart"  style="margin-left: 10px;display:none;"><img src="assets/cargando.gif" height="24px" width="24px" ></span>
					<a id="ExportToCSV" v-show="DetallesChartColapsados" style="display:none;color:grey; hover:orange" id="iconExportaExcel" title="Exporta a Excel(csv)" >
						<i class="fa fa-table fa-2x"></i>
						<i class="fa fa-arrow-circle-down fa-1x" style="margin-left:-5px;"></i>
					</a>
					<a id="PrintChart" v-show="DetallesChartColapsados" style="display:none;color:grey; hover:orange" id="iconPrint" title="Imprimir" >
						<i class="fa fa-print fa-2x"></i>
					</a>
					</span>
				</label>				
			  </div>
			  <div class="col-75">
				<span>
					<input id="TextoChart" placeholder="Filtrar con este Texto" v-model="TextoChart" style="width:90%;">
					<a v-on:click="DetallesChartColapsados=!DetallesChartColapsados;resizechart()">
						<span v-show="!DetallesChartColapsados"><i class="fa fa-chevron-up" style="color:grey;"></i></span>
						<span v-show="DetallesChartColapsados"><i class="fa fa-chevron-down" style="color:grey;"></i></span>
					</a>
				</span>
			  </div>
			</div>			
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="Chartgrupo"><i class="fa fa-group" style="font-size:1.5em;color:grey;" id="iconChartSelectGroup" title="Para seleccionar el grupo"></i></label>
			  </div>
			  <div class="col-75">
				<select  id="Chartgrupo" v-model="grupochartselected" v-on:change="grupochartsel()">
					<option id="ChartFirstSelGrupoOption" value="0" >Todos</option>
					<option v-for="gr in grupos"  :value="gr.grupo" >{{gr.name}}</option> 									
				</select>
			  </div>
			</div>
			<div class="row" v-show="false">
			  <div class="col-25">
				<label for="Carpetas"><i class="fa fa-folder-o fa-fw" style="font-size:1.5em;color:grey;" id="iconTipoDossier" title="Selecciona la carpeta"></i></label>
			  </div>
			  <div class="col-75">
				<select id="Carpetas" v-model="CarpetaSeleccionada" v-on:change="LoadChartDCs();">
					<option id="ChartFirstSelDossierOption" value="T" >Todos</option>					
					<option class="v-cloak" v-for="tp in Carpetas" :value="tp.Id">{{tp.Desc}}</option>
				</select>
			  </div>
			</div>
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="ChartDC"><i class="fa fa-address-card-o fa-fw" style="font-size:1.5em;color:grey;" id="ChartIconSelDC" title="Selecciona un DataClip"></i></label>
			  </div>
			  <div class="col-75">
				<select id="ChartDC" v-model="ChartDCSeleccionado" v-on:change="LoadCamposDCs();">
					<option id="FirstChartDCOption" value="T" >Todos</option>					
					<option class="v-cloak" v-for="dc in ChartDcs" :value="dc.Code">{{dc.Desc}}</option>
				</select>
			  </div>
			</div>
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="ChartDCcampos"><i class="fa fa-database fa-fw" style="font-size:1.5em;color:grey;" id="iconSelCampoDC" title="Selecciona un campo del DC"></i></label>
			  </div>
			  <div class="col-75">
					<p id="SelCamposMostrar">Selecciona los campos a mostrar</p>
				  <div id="ChartDCcampos" v-for="fdc in CamposDcs" :key="fdc.rethead">
					<input type="checkbox" v-model="showCols" :value="fdc.rethead"/>
					<label>{{fdc.desc + '(' + fdc.type + ')'}}</label>
				  </div>
			  </div>
			</div>
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="Chartsello"><img class="tool-item selloDC" src="assets/stamp.png" id="iconChartSelectSello" title="Selecciona un sello" style="height: 1.3em; display: inline;" ></label>
			  </div>
			  <div class="col-75">
				<select  id="Chartsello" v-model="sellochartselected">
					<option id="ChartFirstSelloOption" value="0" >Sin Sello</option>
					<option v-for="sl in sellos"  :value="sl.valor" >{{sl.desc}}</option> 									
				</select>
			  </div>
			</div>
			
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="selchartstatus"><i class="fa fa-folder-o" style="font-size:1.5em;color:grey;" id="iconChartEstadoDossier" title="Para indicar el estado del Dossier"></i></label>
			  </div>
			  <div class="col-75">
				<select id="selchartstatus" v-model="selchartstatus">
					<option id="ChartStatusActivos" value="1" >Activos</option>					
					<option id="ChartStatusHistoricos" value="2" >Historicos</option>
					<option id="ChartStatusActHist" value="3" >Activos e Historicos</option>
				</select>
			  </div>
			</div>

			
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="Chartequipo"><i class="fa fa-user-circle-o" style="font-size:1.5em;color:grey;" id="iconChartMiembroEquipo" title="Para indicar un solo miembro del grupo"></i></label>
			  </div>
			  <div class="col-75">
				<select id="Chartequipo" v-model="usuariochartselected">
					<option id="FirstChartOptionEquipo" value="T" >Todos</option>					
					<option class="v-cloak" v-for="u in chartusers" :value="u.userid">{{u.userid}}</option>
				</select>
			  </div>
			</div>				
			<div class="row" v-show="!DetallesChartColapsados">
			  <div class="col-25">
				<label for="subject"><i class="fa fa-calendar fa-fw" style="font-size:1.5em; color:grey;" id="iconChartRangoFecha" title="Indicar el rango de fecha a buscar"></i></label>
			  </div>
			  <div class="col-75">
				<div class="datepicker-container with-button">
								  <div class="datepicker-trigger">
									<button id="datepicker-Chart-button-trigger">{{ formatDates(buttonChartDateOne, buttonChartDateTwo) || 'Rango Fechas' }}</button>
									<airbnb-style-datepicker
									  :trigger-element-id="'datepicker-Chart-button-trigger'"
									  :mode="'range'"
									  :date-one="buttonChartDateOne"
									  :date-two="buttonChartDateTwo"
									  :min-date="'2014-08-01'"
									  :fullscreen-mobile="false"
									  :months-to-show="1"
									  :offset-y="10"
									  :offset-x="-50"
									  :trigger="trigger"
									  v-on:date-one-selected="function(val) { buttonChartDateOne = val }"
									  v-on:date-two-selected="function(val) { buttonChartDateTwo = val }"
									  v-on:closed="onChartClosed"
									  v-on:previous-month="onMonthChange"
									  v-on:next-month="onMonthChange"
									></airbnb-style-datepicker>
								  </div>				  
			  </div>
			  </div>
			</div>
			<div class="row" v-show="!DetallesChartColapsados">
			<div class="col-25">
			  </div>			  
				<div class="col-75">
					<div class="btn-group btn-group-lg w3-right" id="busquedas" >
						<span style="display:none">Graficar: 
							<input type="radio" name="RBChart" value="fecha" style="display: inline;" selected>Por Fecha
							<input type="radio" name="RBChart" value="acumulado" style="display: inline;">Acumulado
							<input type="radio" name="RBChart" value="agrupado" style="display: inline;">Agrupado
						</span>
					</div>
				</div>
			</div>
			<div class="row" v-show="!DetallesChartColapsados">
			<div class="col-25">
			  </div>			  
				<div class="col-75">
					<div class="btn-group btn-group-lg w3-right" id="busquedas" >
						<button type="button" id="Buscar2Button" class="w3-button w3-custom w3-padding-large w3-hover-black" style='font-size: 1.5em;' v-on:click="GraficoSelected(false);">
							<i id="ChartButton" class="fa fa-bar-chart-o w3-button w3-custom" style="padding: 4px" ></i>
						</button>
					</div>
				</div>
			</div>
						
		  </form>
	<div id="chart_div" v-show="DetallesChartColapsados" style="width:100%;height:-webkit-fill-available;" ></div>
 </div>	  

<!-- Image Header -->
<div class="w3-display-container w3-animate-opacity" id="MapMain">
	  <div id="MapContainer" style="position:relative; top:2.5em;height:95vh;left:0px;right:12px;display:none">
		<div id="map_canvas" style="position:absolute; width:100%;height:100%;"></div>
		<div id="MenuMap" class="w3-bar w3-theme-d2" style="position:absolute; top:11px; left:210px; width:auto;z-index:6;">	
			<a href="#" class="w3-bar-item w3-button w3-custom w3-hide-small"><img src="drawable/TeamLog Logo 60.png" style="height:1em; width:auto;"> dossier </a>
			<a href="#" class="w3-bar-item w3-button w3-custom w3-hide-large w3-hide-medium"><img src="drawable/TeamLog Logo 60.png" style="height:1em; width:auto;"></a>
			<a v-show='CantMarkers>0' onclick="CleanMap();" class="w3-bar-item w3-button w3-hover-white" ><i class="fa fa-shower" ></i></a>
			<a v-show='CantMarkersDragged>0' onclick="rePositionMarkerArray();" class="w3-bar-item w3-button w3-hover-white" ><i class="fa fa-map-marker" ></i><i class="fa fa-frown-o" ></i></a>
		</div>
		</div> <!-- grid end -->
</div>

<!-- Modal -->
<div id="ModalRexEditor" class="w3-modal">
     <div style="text-align:-webkit-center;">
		<rex_editor ref="ModalRex"></rex_editor>
	 </div>
</div>
	
<div id="ModalDcDetails" class="w3-modal">
     <div style="text-align:-webkit-center;">
		<dc_details ref="DcDets"></dc_details>
	 </div>
</div>	
	
<div id="ModalGallery" class="w3-modal" style="z-index:200;display:none;">
	<div id="GalleryFileContainer" class="w3-modal-content w3-card-4" style="width: 500px;">
		<header class="w3-container w3-custom"> 
		  <span style="line-height:2;font-size:21px;">
			<a class="w3-bar-item w3-button w3-left" onclick="closeGallery();"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a>
			<span id="TextoArchivoGaleria" style="font-size:21px;line-height:2;">Archivo de Imagen</span>
			<a id="import_accept" class="w3-bar-item w3-button w3-right" style="visibility:hidden;" onclick="acceptImagefromDisk('fileElem');document.getElementById('ModalGallery').style.display='none';"><img src="drawable/ic_action_accept.png" style="height:2em; width:auto;"></a>
		  </span>
		</header>
		<input type="file" id="fileElem" accept="image/*" style="display:none" onchange="handleFiles(this.files)">
		<a href="#" id="fileSelect" class="w3-button w3-gray" style="margin:5px"><i class="fa fa-search"></i><span id="TextSelFile" >Selecciona una imagen</span></a> 
		<div id="fileList">
		  <p id="NoSelText">Sin seleccionar</p>
		</div>	
		<hr>
    </div>
 </div>
	
<div id="ModalPDF" class="w3-modal" style="z-index:200;display:none;">
	<div id="PDFFileContainer" class="w3-modal-content w3-card-4" style="width: 500px;">
		<header class="w3-container w3-custom"> 
		  <span style="line-height:2;font-size:21px;">
			<a class="w3-bar-item w3-button w3-left" onclick="document.getElementById('ModalPDF').style.display='none';"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a>
			<span id="PdfFileText" style="font-size:21px;line-height:2">Archivo PDF</span>
			<a id="import_accept_pdf" class="w3-bar-item w3-button w3-right" style="visibility:hidden;" onclick="acceptPdfFromDisk('fileElemPdf');document.getElementById('ModalPDF').style.display='none';"><img src="drawable/ic_action_accept.png" style="height:2em; width:auto;"></a>
		  </span>
		</header>
		<input type="file" id="fileElemPdf" style="display:none" accept="application/pdf" onchange="handlePDFFiles(this.files)">
		<a href="#" id="pdffileSelect" class="w3-button w3-gray" style="margin:5px"><i class="fa fa-search"></i><span id="SelPdfText">Selecciona un doc pdf</span></a> 
		<div id="pdffileList">
		  <p id="NoPdfSelected">Sin seleccionar</p>
		</div>
		<input id='PdfFileName' type='hidden' value=''>
		<hr>
    </div>
 </div>

<!-- Team Container -->
<div class="w3-container w3-padding-32" id="carpetas" style="padding-left:2px;display:none">
<h3>Dossiers</h3>

<div class="w3-row" style="min-height: 540px;"><br>
	  <div style="position:relative;">
		<div class="grid">
			<div id="domRex" style="display:none">
				<rex ref="RexSelected"></rex>
			</div>		
		</div> <!-- grid end -->
	  </div>

</div>
</div>

<!-- Calendario -->
<div class="w3-container w3-padding-32" id="calendario" style="display:none">
<h3 id="CalendarText">Calendario</h3>
<div class="w3-row" style="min-height: 540px;"><br>
	  <div style="position:relative;">
		<iframe id="CalendarFrame" style="display:none" :src="'calendar.html?u='+userid" frameborder=0 width=100% height=800px;></iframe>
	  </div>
</div>
</div>

<!-- Work Row -->
<div class="w3-row-padding w3-padding-32 w3-theme-l1" id="estadisticas" style="display:none">

<div class="w3-quarter">
<h3 id="EstadisticasText">Estadisticas</h3>
</div>

<div class="w3-quarter">
<div class="w3-card w3-white">
<span><b>1</b><a><i class="fa fa-refresh w3-button" id="iconChartRefresh" title="refrescar" style="padding: 4px" onclick="app.DrawDashboard(1,true);"></i></a><a><img id='expandicon' src="drawable/expand32.png" style="height:1em; width:auto;" title="mas grande" onclick="ExpandChart(this)"></a>&nbsp;<a><img src="drawable/shrink32.png" style="height:1em; width:auto;" id="iconChartPeq" title="mas pequeno" onclick="ShrinkChart(this)"></a></span>
  <div class="w3-container w3-center">
  <h3 id="Titulo1"></h3>
  <h4 id="EnTitulo1"></h4>
  <p id="UsuarioSel1"></p>
  <p id="Rango1"></p>
  <p id="Status1"></p>
  
  </div>
  <div id="chart_div1" style="width:100%"></div>	
  </div>
</div>

<div class="w3-quarter">
<div class="w3-card w3-white">
<span><b>2</b><a><i class="fa fa-refresh w3-button" id="iconChartRefresh2" title="refrescar" style="padding: 4px" onclick="app.DrawDashboard(2,true);"></i></a><a><img src="drawable/expand32.png" style="height:1em; width:auto;" id="expandicon2" title="mas grande" onclick="ExpandChart(this)"></a>&nbsp;<a><img src="drawable/shrink32.png" style="height:1em; width:auto;" id="iconChartPeq2" title="mas pequeno" onclick="ShrinkChart(this)"></a></span>
  <div class="w3-container w3-center">
  <h3 id="Titulo2"></h3>
  <h4 id="EnTitulo2"></h4>
  <p id="UsuarioSel2"></p>
  <p id="Rango2"></p>
  <p id="Status2"></p>
  </div>
  <div id="chart_div2" style="width:100%"></div>	
  </div>
</div>

<div class="w3-quarter">
<div class="w3-card w3-white">
  <span><b>3</b><a><i class="fa fa-refresh w3-button" id="iconChartRefresh3" title="refrescar" style="padding: 4px" onclick="app.DrawDashboard(3,true);"></i></a><a><img src="drawable/expand32.png" style="height:1em; width:auto;" id="expandicon3" title="mas grande" onclick="ExpandChart(this)"></a>&nbsp;<a><img src="drawable/shrink32.png" style="height:1em; width:auto;" id="iconChartPeq3" title="mas pequeno" onclick="ShrinkChart(this)"></a></span>
  <div class="w3-container w3-center">
  <h3 id="Titulo3"></h3>
  <h4 id="EnTitulo3"></h4>
  <p id="UsuarioSel3"></p>
  <p id="Rango3"></p>
  <p id="Status3"></p>
   </div>
  <div id="chart_div3" style="width:100%" class="w3-center"></div>	
  </div>
</div>

</div>

<!-- Footer -->
<footer class="w3-container w3-padding-32 w3-theme-d1 w3-center">
  <h4 id="followUs">Siguenos</h4>
  <a class="w3-button w3-large w3-custom" href="javascript:void(0)" title="Facebook"><i class="fa fa-facebook"></i></a>
  <a class="w3-button w3-large w3-custom" href="javascript:void(0)" title="Twitter"><i class="fa fa-twitter"></i></a>
  <a class="w3-button w3-large w3-custom" href="javascript:void(0)" title="YouTube"><i class="fa fa-youtube"></i></a>
  <a class="w3-button w3-large w3-custom" href="javascript:void(0)" title="Instagram"><i class="fa fa-instagram"></i></a>
  <a class="w3-button w3-large w3-custom w3-hide-small" href="javascript:void(0)" title="Linkedin"><i class="fa fa-linkedin"></i></a>
  <p>Powered by <a href="http://dossier.plus" target="_blank"><img src="drawable/TeamLogLogo60Orange.png" style="height:1em; width:auto;"><i class="fa fa-folder-o fa-fw"></i>Dossier</a></p>

  <div style="position:relative;bottom:100px;z-index:1;" class="w3-tooltip w3-right">
    <span class="w3-text w3-padding w3-custom w3-hide-small" id="iconArriba">arriba</span>   
    <a class="w3-button w3-theme" href="#myPage"><span class="w3-xlarge">
    <i class="fa fa-chevron-circle-up"></i></span></a>
  </div>
</footer>

<div id="ModalDataClips" class="w3-modal" style="display:none;">
	<input id='DataClipRexId' type='hidden' value=''>
	<div class="w3-modal-content  w3-card-4" style="width: 400px;top: 200px;">
	<header class="w3-container w3-custom"> 
      <span onclick="document.getElementById('ModalDataClips').style.display='none'" 
      class="w3-button w3-display-topright">&times;</span>
      <h3>DataClips</h3>
    </header>
      <div id="DClipsAvailable" class="w3-container" style="max-height:400px;overflow-y:auto;">
		<ul class="w3-ul w3-hoverable" >
		  <li v-for="(Dcs,index) in DataClips" :value="index" v-on:click="LoadDC(index);">{{Dcs.Desc}}</li>
		</ul>
      </div>
    </div>
 </div>
 
<div id="ModalOtrasOps" class="w3-modal" style="display:none;z-index:300;">
	<input id='OtrasOpsRexId' type='hidden' value=''>
	<input id='OtrasOpsgrupo' type='hidden' value=''>
	<div class="w3-modal-content  w3-card-4" style="width: 400px;top: 200px;">
	<header class="w3-container w3-custom"> 
      <span onclick="document.getElementById('ModalOtrasOps').style.display='none'" 
      class="w3-button w3-display-topright">&times;</span>
      <h2 id="TituloOtrasOps"><i class="fa fa-folder-o"></i> {{CurrentTitle}}</h2>
	  <h4 id="EstadoTextOtrasOps">Estado:</h4>
	  
    </header>
      <div id="SetRexStatus" class="w3-container" style="max-height:400px;overflow-y:auto;">
		  <p>
		  <input class="w3-radio" type="radio" name="NewStatus" value="1" v-model="CurrentRexStatus">
		  <label id="ActivoStatusText">Activo</label></p>
		  <p>
		  <input class="w3-radio" type="radio" name="NewStatus" value="2" v-model="CurrentRexStatus">
		  <label id="HistStatusText">Historico</label></p>
		  <!--<p>
		  <input class="w3-radio" type="radio" name="NewStatus" value="3" v-model="CurrentRexStatus">
		  <label>Cerrado</label></p>
		  <p>-->
		  <input class="w3-radio" type="radio" name="NewStatus" value="0" v-model="CurrentRexStatus">
		  <label id="BorradoStatusText">Borrado</label></p>
		  <div class="col-25">
		  </div>			  
			<div class="col-75">
				<div class="btn-group btn-group-lg w3-right" v-show="CurrentRexStatus!=RexStatus" >
					<button type="button" id="SetRexStatusButt" class="w3-button w3-custom w3-padding-large w3-hover-black" style='font-size: 1em;' v-on:click="SetRexStatus(CurrentRexStatus);">
						Cambiar Estado
					</button>
				</div>
			</div>
				
      </div>
    </div>
 </div>

<div id="ModalCambioPwd" class="w3-modal" style="display:none;z-index:140">
	<div class="w3-modal-content  w3-card-4" style="width: 500px;top: 100px;">
	<header class="w3-container w3-custom"> 
      <span onclick="document.getElementById('ModalCambioPwd').style.display='none'" 
      class="w3-button w3-display-topright">&times;</span>
      <h3><i class="fa fa-lock"></i> {{this.userid}}</h3>
	  <h4 ><span id="ChangePwdText">Cambio de Clave:</span><span id="CambioPwdSpin" style="display:none;"><i class="fa fa-spinner fa-spin"></i></span></h4>	  
    </header>
      <div id="Passwords" class="w3-container" style="max-height:400px;overflow-y:auto;">
		<TABLE width="100%">
			<tr>
				<td class="col-25">
					<label for="Login_PWDOrg">
						<i class="fa fa-lock" style="font-size:1.5em;color:grey;" id="IngresaClaveText" title="Ingresa tu Clave actual"></i> <span id="PwdActualText">actual</span>
					</label>
				</td>
				<td class="col-75">
					<span>
						<input id="Login_PWDOrg" type="password" style="width:90%;">				
					</span>
				</td>
			</tr>
			<tr>
				<td class="col-25">
					<label for="Login_PWD1">
						<i class="fa fa-lock" style="font-size:1.5em;color:grey;" id="IngresaClaveNuevaText" title="Ingresa tu Clave nueva"></i> <span id="PwdNuevoText">nueva</span>
					</label>
				</td>
				<td class="col-75">
					<span>
						<input id="Login_PWD1" type="password" style="width:90%;">				
					</span>
				</td>
			</tr>
			<tr>
				<td class="col-25">
					<label for="Login_PWD2">
						<i class="fa fa-lock" style="font-size:1.5em;color:grey;" id="ConfirmaClaveNuevaText" title="Confirma tu Clave nueva"></i> <span id="PwdConfirmText">confirma</span>
					</label>
				</td>
				<td class="col-75">
					<span>
						<input id="Login_PWD2" type="password" style="width:90%;">				
					</span>
				</td>
			</tr>
		</table>
		<br>
		<div class="">
			<div class="btn-group btn-group-lg w3-right">
				<button id="ButCambiaPwd" type="button" class="w3-button w3-custom w3-padding-large w3-hover-black" style="font-size: 1em;" v-on:click="SetCambioPwd();">
					Cambiar Clave
				</button>
			</div>
		</div>
		<br>		
      </div>
    </div>
 </div>



<div id="ModalDataClipEditor" class="w3-modal" style="display:none;z-index:127">
    <div class="w3-modal-content  w3-card-4" style="width: 100%;min-width: 350px; max-width:600px;">
	<header class="w3-container w3-custom"> 
	<span>
		<a class="w3-bar-item w3-button w3-left" onclick="document.getElementById('ModalDataClipEditor').style.display='none';StopFPSScanner();"><img src="drawable/ic_action_cancelhl.png" style="height:2.5em; width:auto;"></a>
        <span id='Editor_DataClipName' style="line-height:2;font-size:24px;">Nombre DataClip</span>
		<span>
		<a id="DC_accept" class="w3-bar-item w3-button w3-right" onclick="this.onclick=null;accept_DC('DCContainer');"><img src="drawable/ic_action_accept.png" style="height:2.5em; width:auto;"></a>
		<i class="fa fa-pencil w3-right" id="Editando" style="font-size:2.5em; width:auto; padding:4px; display:none;" title="Editando DC"></i>
		</span>
		</span>
    </header>
      <div id="DcFormContainer" >
		<div style="text-align:center">
			<a class="w3-bar-item w3-button" onclick="initcamera()" id="DCcamera" title="Toma Foto"><img id="DCCameraButt" src="drawable/ic_action_camera.png" style="height:2.5em; width:auto;"></a>
			<a class="w3-bar-item w3-button" onclick="initImageImport();" id="DCgallery" title="Incorpora Imagen"><img id="DCGalleryButt" src="drawable/ic_action_picture.png" style="height:2.5em; width:auto;"></a>
			<a class="w3-bar-item w3-button" id="PdfDC" onclick="initPdfImport()" title="Incorpora PDF"><i class="fa fa-file-pdf-o fa-2x" ></i></a>
			<a class="w3-bar-item w3-button" id="DCfingerscanner" onclick="initFPScan()"><img id="DCFingerPrintButt" src="drawable/ic_fingerprint.png" style="height:2em; width:auto;" title="Identificacion biometrica"></a>
			<a class="w3-bar-item w3-button" id="DCsignature" onclick="initSignaturePad()" title="Incorpora Firma"><img id="DCSignaturePadButt" src="drawable/ic_signature24.png" style="height:2em; width:auto;" ></a>
			<a class="w3-bar-item w3-button" id="DeleteImagefromDC" onclick="DeleteImagefromDC()" style="display:none" title="Desincorpora Imagen Anexa"><i class="fa fa-trash-o fa-2x" ></i></a>			
		</div>
		<img id="DCImage" style="display:none;width:100%;height:auto;">
		<div id ="PdfButtons" style="display:none">
		  <button id="prevPdfPage"><i class="fa fa-arrow-circle-left fa-2x"></i></button>
		  <button id="nextPdfPage"><i class="fa fa-arrow-circle-right fa-2x"></i></button>
		  &nbsp; &nbsp;
		  <span><i class="fa fa-file-o fa-2x"></i>: <span id="Pdf_page_num"></span> / <span id="Pdf_page_count"></span></span>
		</div>
		<canvas id="Pdf-canvas" style="display:none;width:100%;height:auto;"></canvas>
		<input id="ImgSource" name="ImgSource" type="hidden" value="">
		<input id="FingerPrintId" name="FingerPrintId" type="hidden" value="">
		<input id="FingerPrintTemplate" name="FingerPrintTemplate" type="hidden" value="">		
		<input type="hidden" id="DCWebId" name="DCWebId" value="">
		<input type="hidden" id="PrevDC" name="PrevDC" value="">
		<input type="hidden" id="NextDC" name="NextDC" value="">
		<input type="hidden" id="retHeadTituloDossier" name="" value="">
		<input type="hidden" id="retHeadTituloDC" name="" value="">
		<div id="operacionesDC"  style="text-align:left;background-color:lightgray;display:none">		
			<a class="w3-bar-item w3-button" onclick="alert('ImportSelected')" id="ImportSelected" title="Importar info de DC seleccionado">		
				<span class="fa-stack fa-lg"><i class="fa fa-check-circle-o fa-stack-2x"></i>		
					<i class="fa fa-arrow-down fa-1x" data-fa-transform="rotate-45" style="margin-left:35px;"></i>		
					<i class="fa fa-ban fa-stack-3x text-danger red" style="display:none"></i>		
				</span>					
			</a>		
		</div>		
 		<form id="DCContainer" class="w3-container">
			<div id="Conditionals" style="display:none;"></div>
			<a id="DC_accept2" class="w3-bar-item w3-button w3-right" onclick="this.onclick=null;accept_DC('DCContainer');"><img src="drawable/ic_action_accept.png" style="height:2.5em; width:auto;"></a>		
		</form>
		<br>
      </div>
    </div>
 </div>
 
 
 
  <div id="ModalSignaturePad" class="w3-modal" style="z-index:200;">
	<div id="Signaturecontainer" class="w3-modal-content w3-card-4">
		<header class="w3-container w3-custom"> 
		  <span>
			<a class="w3-bar-item w3-button w3-left" onclick="closeModalSignature();"><img src="drawable/ic_action_cancelhl.png" style="height:2.5em; width:auto;"></a>
			<span id="SignatureText" style="font-size:18px;">Firma aqui</span>
			<a class="w3-bar-item w3-button" onclick="signaturePad.clear();" style="font-size:1.5em;"><i class="fa fa-eraser"></i></a>
			<a id="Signature_accept" class="w3-bar-item w3-button w3-right" style="visibility:visible;" onclick="acceptSignature();"><img src="drawable/ic_action_accept.png" style="height:2.5em; width:auto;"></a>
		  </span>
		</header>
		<canvas id="SigCanvas" style="width:100%;"></canvas>
    </div>
 </div>
 
 <div id="ModalSellos" class="w3-modal" style="display:none;z-index:127">
	<input id='SelloRexId' type='hidden' value=''>
	<input id='SelloDCId' type='hidden' value=''>
	
	<div class="w3-modal-content  w3-card-4" style="width: 400px;top: 200px;">
	<header class="w3-container w3-custom"> 
      <span onclick="document.getElementById('ModalSellos').style.display='none'" 
      class="w3-button w3-display-topright">&times;</span>
      <h3 id="SellosText">Sellos</h3>
    </header>
      <div id="SellosAvailable" class="w3-container" style="max-height:400px;overflow-y:auto;text-align: center;">
		<LABEL FOR="SelloText" class="w3-text-custom" id="SellosComentarioText">Comentario:</LABEL>
		<textarea id="SelloText" width="100%" class="w3-input w3-border w3-light-grey">
		</textarea>
		<img v-for="Sello in SellosDisponibles"  :id="Sello.id"  :src="Sello.src" :alt="Sello.desc" v-on:click="SetSello(Sello.id,Sello.valor,Sello.dctype)"/>
      </div>
    </div>
 </div>


 <div id="ModalOrdenarDC" class="w3-modal" style="z-index:200;font-size:1.2em;line-height:1.5;">
	<div id="OrdenarDcContainer" class="w3-modal-content" style="width: 350px;">
		<header class="w3-container w3-custom"> 
		  <span style="line-height: 2; font-size: 21px;">
			<a class="w3-bar-item w3-button w3-left" onclick="closeModalOrdenarDC();"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a>
			<span style="line-height:2;font-size:21px;" id="OrdenarDCText">Ordenar los DC<span>
			<a id="OrdenarDC_accept" class="w3-bar-item w3-button w3-right" style="visibility:visible;" onclick="acceptOrdenarDC();"><img src="drawable/ic_action_accept.png" style="height:2em; width:auto;"></a>
		  </span>
		</header>
		<form  class="w3-container  w3-border">
			<label for="OrdenarDC" class="w3-text-custom">Repetir:</label>
			<p><input type="radio" name="OrdenarDC" value="PorFecha" checked="checked" class="w3-radio"> <label>Por Fecha</label></p>
			<p><input type="radio" name="OrdenarDC" value="PorDC" class="w3-radio"> <label>Por Tipo de DC</label></p>
			<hr>
		</form>
	</div>
 </div>
 
 <div id="ModalAddFile" class="w3-modal" style="z-index:200;display:none;">
	<div id="AddFileContainer" class="w3-modal-content w3-card-4" style="width: 500px;">
		<header class="w3-container w3-custom"> 
		  <span style="line-height:2;font-size:21px;">
			<a class="w3-bar-item w3-button w3-left" onclick="closeAddFile();"><img src="drawable/ic_action_cancelhl.png" style="height:2em; width:auto;"></a>
			<span style="font-size:21px;line-height:2" id="AddFileText">Anexo de Imagen<span>
			<a id="AddFile_accept" class="w3-bar-item w3-button w3-right" style="visibility:hidden;" onclick="acceptImagefromDisk2('AddfileElem');"><img src="drawable/ic_action_accept.png" style="height:2em; width:auto;"></a>
		  </span>
		</header>
		<label for="DescFile" class="w3-text-custom" id="AddFileDescText">Descripcion:</label>
		<textarea id='DescFile' cols="40" rows="5" class="w3-input w3-border w3-light-grey"></textarea>
			
		<input type="file" id="AddfileElem" accept="image/*" style="display:none" onchange="handleFiles2(this.files)">
		<a href="#" id="AddfileSelect" class="w3-button w3-gray" style="margin:5px"><i class="fa fa-search"></i><span id="AddFileSelImageText">Selecciona una imagen</span></a> 
		<div id="AddfileList">
		  <p id="AddFileNoSel">Sin seleccionar</p>
		</div>	
		<hr>
    </div>
 </div>
 
 <div id="ModalTiposDossier" class="w3-modal" style="display:none;">
    <div class="w3-modal-content  w3-card-4" style="width: 400px;top: 200px;">
	<header class="w3-container w3-custom"> 
      <span onclick="document.getElementById('ModalTiposDossier').style.display='none'; app.logs=[];" 
      class="w3-button w3-display-topright">&times;</span>
      <h3><span>{{nombreGrupo}}-<span id="CreateDossierText">Crear Dossier</span></span><span id="LoadingLogs" style="display:none;"><i class="fa fa-spinner fa-spin"></i></span></h3>
    </header>
      <div id="DossiersAvailable" class="w3-container" style="max-height:400px;overflow-y:auto;">
		<ul class="w3-ul w3-hoverable" >
		  <li v-for="(log,index) in logs" :value="index" v-on:click="CreateDossierLoadDC(index)">{{log.Desc}}</li>
		</ul>
      </div>
    </div>
 </div>
</div>
</div>

<!-- fin de app -->

<script>
 var video = document.querySelector("#videoElement");
 var canvas  = document.getElementById('cameracanvas');
 
 function ShowMapa(){
	if (!map){
		ShowCarpetas();
		return;
	}
	document.getElementById("MapContainer").style.display="block";
	document.getElementById("carpetas").style.display="none";
	document.getElementById("calendario").style.display="none";
	document.getElementById("CalendarFrame").style.display="none";
	document.getElementById("estadisticas").style.display="none";
	if (initialZoomLevel > map.getZoom())
		map.setZoom(initialZoomLevel);// if the user is working very zoomed, don't bother him
	if (map.getZoom()==0)
		map.setZoom(4);
	CloseSideBarIfSize(600);
	//closeNav();		
	}
 
 function ShowCarpetas(){
	document.getElementById("MapContainer").style.display="none";
	document.getElementById("carpetas").style.display="block";
	document.getElementById("carpetas").scrollTop = 0;
	document.getElementById("calendario").style.display="none";
	document.getElementById("CalendarFrame").style.display="none";	
	grid.refreshItems().layout();
	document.getElementById("estadisticas").style.display="none";
	CloseSideBarIfSize(600);
	//closeNav();
}

function ShowCalendario(){
	document.getElementById("MapContainer").style.display="none";
	document.getElementById("carpetas").style.display="none";
	document.getElementById("calendario").style.display="block";
	document.getElementById("CalendarFrame").style.display="block";
	document.getElementById("calendario").scrollTop = 0;
	
	document.getElementById("calendario").src="calendar.html?u="+ app.userid;
	grid.refreshItems().layout();
	document.getElementById("estadisticas").style.display="none";
	CloseSideBarIfSize(600);
	//closeNav();
}
function ShowDashBoard(){
	w3_close();
	setChartDiv0Size(600);
	document.getElementById("MapContainer").style.display="none";
	document.getElementById("carpetas").style.display="none";
	document.getElementById("calendario").style.display="none";
	document.getElementById("CalendarFrame").style.display="none";
	document.getElementById("estadisticas").style.display="block";
	document.getElementById("estadisticas").scrollTop = 0;
	app.showGrafico();
	app.DrawDashboard(1,false);
	app.DrawDashboard(2,false);
	app.DrawDashboard(3,false);
	CloseSideBarIfSize(600);
	//closeNav();
}

function GridElementSize(size){
 var w = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;
var sw= screen.width;
	w=sw<w?sw:w;
	 if (w<size){
		return 350;
	 }
	 return 450;
 }

 function CloseSideBarIfSize(size){
 var w = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;
var sw= screen.width;
	w=sw<w?sw:w;
	 if (w<size){
		w3_close();
	 }
 }
 
 function setChartDiv0Size(size){
 var w = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;
var sw= screen.width;
	w=sw<w?sw:w;
	 if (w<size){
		//alert('Screen size is '+ w);
		document.getElementById('ChartItem').style.width=screen.width+'px';
	 }

 }
 
 function ShowCarpetasIfSize(size){
  var w = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;
var sw= screen.width;
	w=sw<w?sw:w;
	 if (w<size){
		ShowCarpetas();
		setTimeout(function () {							
			document.getElementById("carpetas").scrollTop = 0;
		}, 500);
	 }
 }

 
	

function EnableGridDrag(size){
var w = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;
var sw= screen.width;
	w=sw<w?sw:w;
	 if (w<size){
		grid._settings.dragEnabled=false
	 }

} 
 var ContenedorActivo = "";
 
 function initcamera(){
// w3_close();
    RecyclePdf();
 try{
	stopStreamedVideo(video);
 }catch(e){
	var n=0;//para parar en el debugger y ver que paso con e
 }
 var videoSource = Cameras.options[(activeCamera)%(Cameras.options.length)].value;

  var constraints = {
    video: {
      deviceId: { exact: videoSource } 
    }
  };
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(gotStream);
	
	/*if(document.getElementById("MapContainer").style.display!="none"){
		ContenedorActivo="MapContainer";
		document.getElementById("MapContainer").style.display="none";
	}
	if(document.getElementById("calendario").style.display!="none"){
		ContenedorActivo="calendario";
		document.getElementById("calendario").style.display="none";
	}
	if(document.getElementById("estadisticas").style.display!="n"){
		ContenedorActivo="estadisticas";
		document.getElementById("estadisticas").style.display="none";
	}
	if(document.getElementById("carpetas").style.display!="none"){
		ContenedorActivo="carpetas";
		document.getElementById("carpetas").style.display="none";
	}*/
	CloseSideBarIfSize(600);
	document.getElementById('container').style.display="block";
	
	/*if (navigator.mediaDevices.getUserMedia) {       
		navigator.mediaDevices.getUserMedia({video: true})
	  .then(function(stream) {
		document.getElementById('ModalCamera').style.display="block";
		document.getElementById('camera_accept').style.visibility="hidden";
		
		video.srcObject = stream;
		video.play();
	  })
	  .catch(function(err) {
		alert('No hay Camara disponible');
		console.log("Something went wrong!");
	  });  	
	}*/
}

var videoSelect = document.querySelector("select#videoSource");
var selectors = [videoSelect];
var activeCamera = 0;
var Cameras = document.getElementById('videoSource');


function NextCamera(){
stopStreamedVideo(video);
var videoSource = Cameras.options[(++activeCamera)%(Cameras.options.length)].value;

  var constraints = {
    video: {
      deviceId: { exact: videoSource } 
    }
  };
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(gotStream);
}

function checkIfCameraExists(){
	return (videoSource.length!=0);
}

function checkIfCameraExists2(){
	if (navigator.mediaDevices.getUserMedia) {       
		navigator.mediaDevices.getUserMedia({video: true})
	  .then(function(stream) {
		video.srcObject = stream;
		video.play();
		setTimeout(function () {
			if (stream!= null) {
				stream.getTracks().map(function (val) {
				val.stop();
				});
				}
			}, 10000);
			successCamera();
			return true;
	  })
	  .catch(function(err) {
	  	errorCamera();
		return false;
	  });  	
	}
}


function cleanFotoCanvas(){
	var canvas  = document.getElementById('cameracanvas');
		canvas.style.display="none";
}


 function TakeFoto(){
        // Copiando la imagen a un canvas temporal
		//init();
		var canvas  = document.getElementById('cameracanvas');
		canvas.style.display="";

        var temp = document.createElement('canvas');

        temp.width  = video.videoWidth;
        temp.height = video.videoHeight;

        var tempcontext = temp.getContext("2d"),
            tempScale = (temp.height/temp.width);

        tempcontext.drawImage(
            video,
            0, 0,
            video.videoWidth, video.videoHeight
        );
        // Redimensionar al tama�o de nuestro cavas
        canvas.style.height    = parseInt( canvas.offsetWidth * tempScale );
        canvas.width        = video.videoWidth;
        canvas.height        = video.videoHeight;
        var context        = canvas.getContext("2d"),
            scale        = canvas.width/temp.width;
        context.scale(scale, scale);
        context.drawImage(temp, 0, 0);
		
	}
	var paused=false;
	function togglevideo(){
		initcamera();
		if (paused)
			video.play();
		else
			video.pause();
		paused=!paused;
	}

function stopStreamedVideo(videoElem) {
  let stream = videoElem.srcObject;
  let tracks = stream.getTracks();

  tracks.forEach(function(track) {
    track.stop();
  });

  videoElem.srcObject = null;
}

function DeleteImagefromDC(){
    RecyclePdf();
	var Image=document.getElementById('DCImage');
	Image.src = "";
	Image.style.display="none";
	NoBorrarImagen();
	var ImageSource=document.getElementById('ImgSource');
	ImageSource.value="";
	//Limpia el pdf tambien
	
}

function NoBorrarImagen(){
	document.getElementById('DeleteImagefromDC').style.display="none";
}


function PermiteBorrarImagen(){
	document.getElementById('DeleteImagefromDC').style.display="inline";
}

function acceptImagefromVideo(){
//DCImage
		/*var temp = document.createElement('canvas');

        temp.width  = video.videoWidth;
        temp.height = video.videoHeight;

        var tempcontext = temp.getContext("2d"),
            tempScale = (temp.height/temp.width);

        tempcontext.drawImage(
            video,
            0, 0,
            video.videoWidth, video.videoHeight
        );*/
		ShowImg();		
		var Image=document.getElementById('DCImage');
		//Image.src=temp.toDataURL();
		Image.src = document.getElementById('cameracanvas').toDataURL();
		Image.style.display="block";
		PermiteBorrarImagen();
		var ImageSource=document.getElementById('ImgSource');
		ImageSource.value="Cam";
		
				
		/*var canvas  = document.getElementById('cameracanvas');
        // Redimensionar al tama�o de nuestro cavas
        canvas.style.height    = parseInt( canvas.offsetWidth * tempScale );
        canvas.width        = video.videoWidth;
        canvas.height        = video.videoHeight;
        var context        = canvas.getContext("2d"),
            scale        = canvas.width/temp.width;
        context.scale(scale, scale);
        context.drawImage(temp, 0, 0);
	*/
}
	function closeModalCamera(){
		try{
			stopStreamedVideo(video);
		}catch(e){}

		document.getElementById('container').style.display='none';		
		//document.getElementById(ContenedorActivo).style.display="block";
	}
	
	var eventlistenercreated=false;
	var eventlistenercreatedPdf=false;


	async function CheckSyncRexId(rexId){
		if (rexId<0){
		var rex = await db.rexs.get(-rexId);
			if (rex.syncing){
				alert(langtext[0].AlertaSincDossier);//'Este Dossier se esta sincronizando, trata en un rato'
				return true;
			}
			return false;
		}
		return false;
	}
	
	
/*	function closeModalTarea(){
		document.getElementById('ModalTarea').style.display='none';
	}
	
async function InitTarea(rexID,grupo){
		var dummy = await CheckSyncRexId(rexID);
		if (dummy)
			return;			
		app.loadusersdadogrupo(grupo);
		document.getElementById('TareaRexId').value = rexID;
		document.getElementById('FechaTarea').value='';
		document.getElementById('DescTarea').value='';
		document.getElementById('ModalTarea').style.display='block';	
	}*/
	
	
	function initImageImport(){
        RecyclePdf();
		document.getElementById('ModalGallery').style.display='block';
		document.getElementById('import_accept').style.visibility="hidden";		

		window.URL = window.URL || window.webkitURL;
		var fileSelect = document.getElementById("fileSelect"),
			fileElem = document.getElementById("fileElem"),
			fileList = document.getElementById("fileList");
		fileList.innerHTML = langtext[0].initImageImportText;
		if (fileElem.files.length!=0)
			handleFiles(fileElem.files);
		if (!eventlistenercreated){
			fileSelect.addEventListener("click", function (e) {
			  if (fileElem) {
				fileElem.click();
			  }
			  e.preventDefault(); // prevent navigation to "#"
			}, false);
			eventlistenercreated=true;
		}
		
	}
	function initPdfImport(){
        RecyclePdf();
        document.getElementById('ModalPDF').style.display='block';
		document.getElementById('import_accept_pdf').style.visibility="hidden";	
		window.URL = window.URL || window.webkitURL;
		var fileSelect = document.getElementById("pdffileSelect"),
			fileElem = document.getElementById("fileElemPdf"),
			fileList = document.getElementById("pdffileList");
		fileList.innerHTML = langtext[0].initImageImportText;
		if (fileElem.files.length!=0)
			handleFiles(fileElem.files);
		if (!eventlistenercreatedPdf){
			fileSelect.addEventListener("click", function (e) {
			  if (fileElem) {
				fileElem.click();
			  }
			  e.preventDefault(); // prevent navigation to "#"
			}, false);
			eventlistenercreatedPdf=true;
		}
		
	}
	var FPScannerTimer = null;
	function initFPScan(){
        RecyclePdf();
		//CleanScanFingerPrint();
		var Dcc=document.getElementById('DCContainer');
		var ArrayElements=Dcc.elements;
		document.getElementById('FingerPrintId').value='';
		for (var xx=0;xx<ArrayElements.length;xx++){
			if (ArrayElements[xx].getAttribute('fingerprintid')=='true'){
				setId(ArrayElements[xx].value);
				break;
			}
		}
		//FPScannerTimer = setInterval(CheckScanner, 3000);
	}

	
	function handleFiles(files) {
	   var fileSelect = document.getElementById("fileSelect"),
		   fileElem = document.getElementById("fileElem"),
		   fileList = document.getElementById("fileList");
	  if (!files.length) {
			fileList.innerHTML = langtext[0].initImageImportText;
		  } else {
			fileList.innerHTML = "";
			var list = document.createElement("ul");
			fileList.appendChild(list);
			for (var i = 0; i < files.length; i++) {
			  var li = document.createElement("li");
			  list.appendChild(li);
			  
			var img = document.createElement("img");
			img.src = window.URL.createObjectURL(files[i]);
			img.height = 120;
			img.onload = function() {
				window.URL.revokeObjectURL(this.src);
			}
			li.appendChild(img);
			var info = document.createElement("span");
			info.innerHTML = files[i].name + ": " + files[i].size + " bytes";
			li.appendChild(info);
			}
			document.getElementById('import_accept').style.visibility="visible";
		}
	}

	function handlePDFFiles(files) {
	   var fileSelect = document.getElementById("pdffileSelect"),
	   		fileElem = document.getElementById("fileElemPdf"),
		   fileList = document.getElementById("pdffileList");
		   
	  if (!files.length) {
			fileList.innerHTML = langtext[0].initImageImportText;
		  } else {
			fileList.innerHTML = "";
			var list = document.createElement("ul");
			fileList.appendChild(list);
			for (var i = 0; i < files.length; i++) {
			  var li = document.createElement("li");
			  list.appendChild(li);
			  li.innerHTML=files[i].name;			 
			var info = document.createElement("span");
			info.innerHTML = " : " + files[i].size + " bytes";
			li.appendChild(info);
			}
			document.getElementById('import_accept_pdf').style.visibility="visible";
		}
	}
	
	function acceptImagefromDisk(fileInput){
		ShowImg();
		var FileElem=document.getElementById(fileInput);		
		var file=FileElem.files[0];
		
		var Image=document.getElementById('DCImage');	
		
		var reader  = new FileReader();

		reader.onloadend=function(){
			Image.src = reader.result;
			Image.style.display="block";
			PermiteBorrarImagen();
			var ImageSource=document.getElementById('ImgSource');
			ImageSource.value="Gal";
		};
 	    if (file) {
			reader.readAsDataURL(file);
		} else {
			Image.src = "";
			alert(langtext[0].errorReadingFileText);
		}
		
		
		//Image.src=window.URL.createObjectURL(FileElem.files[0]);
		
}

function ShowImg(){
var Image=document.getElementById('DCImage');		
	Image.style.display="block";
	document.getElementById('PdfButtons').style.display='none';
	document.getElementById('Pdf-canvas').style.display='none';		
}


function ShowPdf(){
var Image=document.getElementById('DCImage');		
	Image.style.display="none";
	document.getElementById('PdfButtons').style.display='block';
	document.getElementById('Pdf-canvas').style.display='block';		
}



var PdfUrl = '';
var pdfjsLib = null;
var pdfDoc = null,
    PdfPageNum = 1,
    PdfPageRendering = false,
    PdfPageNumPending = null,
    scale = 0.8,
    PdfCanvas = null,
	PdfCanvasDC = null,
    PDfCtx = null,
    PDfCtxDC = null,
	pdfFile=null;
	

function RecyclePdf(){
	if (pdfDoc!=null){ // Ya pinto la primera pagina del pdf, entonce no se necesita mas. MOSCA
		pdfDoc.destroy();
		pdfDoc=null;
		document.getElementById('PdfButtons').style.display='none';			
		document.getElementById('Pdf-canvas').style.display='none';		
	}
}

function initPdfCanvas(){
		canvas = document.getElementById('Pdf-canvas');
		w = canvas.width;
		h = canvas.height;
		ctx = canvas.getContext("2d");
		ctx.clearRect(0,0,w,h);
	}	
	
function StartPdfLib(DcObj){
	if (pdfjsLib==null){ 
		pdfjsLib = window['pdfjs-dist/build/pdf'];
		pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
	}
	PdfCanvasDC = document.getElementById('Pdf-canvasDC'+DcObj.id);
	w = canvas.width;
	h = canvas.height;
	PDfCtxDC = PdfCanvasDC.getContext('2d');
	PDfCtxDC.clearRect(0,0,w,h);
	if (pdfDoc!=null){
		pdfDoc.destroy();
		pdfDoc=null;
	}
	pdfjsLib.getDocument('DCImages/'+DcObj.filepath).promise.then(function(pdfDoc_) {
	  pdfDoc = pdfDoc_;
	  PdfPageNum = 1;
	  renderPageDC(PdfPageNum,DcObj.id);
	});
}
	
	function acceptPdfFromDisk(fileInput){
		var ImageSource=document.getElementById('ImgSource');
		ImageSource.value="Pdf";
		var FileElem=document.getElementById(fileInput);		
		var file=FileElem.files[0];
		if (file.type != "application/pdf") {
			alert(file.name + langtext[0].noPdfFileText);
			return;
		  }
		  pdfFile=file;
		var fileReader  = new FileReader();
		
		if (pdfjsLib==null){
			pdfjsLib = window['pdfjs-dist/build/pdf'];
			pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
		}
		initPdfCanvas();
		PdfCanvas = document.getElementById('Pdf-canvas');
		PDfCtx = PdfCanvas.getContext('2d');
		document.getElementById('prevPdfPage').addEventListener('click', onPrevPdfPage);
		document.getElementById('nextPdfPage').addEventListener('click', onNextPdfPage);	
		ShowPdf();
		fileReader.onload = function () {
			var typedarray = new Uint8Array(this.result);

			pdfjsLib.getDocument(typedarray).promise.then(function (pdf) {
				RecyclePdf();
				pdfDoc = pdf;
				PdfPageNum = 1;
				document.getElementById('Pdf_page_count').textContent = pdfDoc.numPages;
				if (pdfDoc.numPages==1)
					document.getElementById('PdfButtons').style.display='none';
				else
					document.getElementById('PdfButtons').style.display='block';
				// Initial/first page rendering
				renderPage(PdfPageNum);
				PermiteBorrarImagen();
			});
		};

        fileReader.readAsArrayBuffer(file);
        document.getElementById("fileElemPdf").value='';//para dejarlo en blanco
	}
/**
 * Get page info from document, resize canvas accordingly, and render page.
 * @param num Page number.
 */	
function renderPage(num) {
  PdfPageRendering = true;
  // Using promise to fetch the page
  pdfDoc.getPage(num).then(function(page) {
    var viewport = page.getViewport({scale: scale});
    PdfCanvas.height = viewport.height;
    PdfCanvas.width = viewport.width;

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: PDfCtx,
      viewport: viewport
    };
    var renderTask = page.render(renderContext);

    // Wait for rendering to finish
    renderTask.promise.then(function() {
      PdfPageRendering = false;
      if (PdfPageNumPending !== null) {
        // New page rendering is pending
        renderPage(PdfPageNumPending);
        PdfPageNumPending = null;
      }
    });
  });

  // Update page counters
  document.getElementById('Pdf_page_num').textContent = num;
}

function renderPageDC(num,DCid) {
  PdfPageRendering = true;
  // Using promise to fetch the page
  	
  pdfDoc.getPage(num).then(function(page) {
    var viewport = page.getViewport({scale: scale});
    PdfCanvasDC.height = viewport.height;
    PdfCanvasDC.width = viewport.width;

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: PDfCtxDC,
      viewport: viewport
    };
    var renderTask = page.render(renderContext);

    // Wait for rendering to finish
    renderTask.promise.then(function() {
      PdfPageRendering = false;
      if (PdfPageNumPending !== null) {
        // New page rendering is pending
        renderPageDC(PdfPageNumPending,DCid);
		PdfPageNumPending = null;
      }
		/*var kanvas=document.getElementById('Pdf-canvasDC'+DCid);
		var dataUrl = kanvas.toDataURL();
		var DCimage=document.getElementById('DcImg'+DCid);
		kanvas.style.display='none';
		DCimage.src=dataUrl;
		DCimage.style.display='block'*/
		setTimeout(function () {
							RecyclePdf();
						}, 1000);

    });
  });

  // Update page counters
  //document.getElementById('Pdf_page_num').textContent = num;
}
/**
 * If another page rendering in progress, waits until the rendering is
 * finised. Otherwise, executes rendering immediately.
 */
function queueRenderPage(num) {
  if (PdfPageRendering) {
    PdfPageNumPending = num;
  } else {
    renderPage(num);
  }
}

/**
 * Displays previous page.
 */
function onPrevPdfPage() {
  if (PdfPageNum <= 1) {
    return;
  }
  PdfPageNum--;
  queueRenderPage(PdfPageNum);
}

/**
 * Displays next page.
 */
function onNextPdfPage() {
  if (PdfPageNum >= pdfDoc.numPages) {
    return;
  }
  PdfPageNum++;
  queueRenderPage(PdfPageNum);
}

function closeGallery(){
	//var fileSelect = document.getElementById("fileSelect");
	//	fileSelect.removeEventListener("click",function (e) {
	//	  if (fileElem) {
	//		fileElem.click();
	//	  }
	//	  e.preventDefault(); // prevent navigation to "#"
	//	});
		document.getElementById('ModalGallery').style.display='none';
}
var signaturePad = null;
function initSignaturePad(){
        RecyclePdf();
		document.getElementById('ModalSignaturePad').style.display='block';
		var canvas = document.getElementById("SigCanvas");
		resizeCanvas();
		if (signaturePad!==null){
			signaturePad.clear();
		}
		else
			signaturePad = new SignaturePad(canvas);
}

function resizeCanvas() {
  // When zoomed out to less than 100%, for some very strange reason,
  // some browsers report devicePixelRatio as less than 1
  // and only part of the canvas is cleared then.
  var ratio =  Math.max(window.devicePixelRatio || 1, 1);
  var canvas = document.getElementById("SigCanvas");
		
  // This part causes the canvas to be cleared
  canvas.height = canvas.offsetHeight * ratio;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.getContext("2d").scale(ratio, ratio);

  // This library does not listen for canvas changes, so after the canvas is automatically
  // cleared by the browser, SignaturePad#isEmpty might still return false, even though the
  // canvas looks empty, because the internal data of this library wasn't cleared. To make sure
  // that the state of this library is consistent with visual state of the canvas, you
  // have to clear it manually.
}

function closeModalSignature(){
		document.getElementById('ModalSignaturePad').style.display='none';
}

function acceptSignature(){
	if (signaturePad.isEmpty()) {
		alert(langtext[0].signPleaseText);
	}
	else{
		ShowImg();
		var canvas = document.getElementById("SigCanvas");
		var Image=document.getElementById('DCImage');
			Image.src=canvas.toDataURL();
			Image.style.display="block";
			PermiteBorrarImagen();
			var ImageSource=document.getElementById('ImgSource');
			ImageSource.value="Sig";
		closeModalSignature();
	}
}

	function closeModalOrdenarDC(){
		document.getElementById('ModalOrdenarDC').style.display='none';
	}
	function InitModalOrdenarDC(){
		document.getElementsByName('OrdenarDC')[0].checked=true
		document.getElementById('ModalOrdenarDC').style.display='block';	
	}

	var eventlistenercreated2=false;
	
	function AddFile(){
		document.getElementById('ModalAddFile').style.display='block';
		document.getElementById('AddFile_accept').style.visibility="hidden";

		window.URL = window.URL || window.webkitURL;
		var fileSelect = document.getElementById("AddfileSelect"),
			fileElem = document.getElementById("AddfileElem"),
			fileList = document.getElementById("AddfileList");
		$("#AddfileElem").val('');
		fileList.innerHTML = langtext[0].initImageImportText;
		if (!eventlistenercreated2){
			fileSelect.addEventListener("click", function (e) {
			  if (fileElem) {
				fileElem.click();
			  }
			  e.preventDefault(); // prevent navigation to "#"
			}, false);
			eventlistenercreated2=true;
		}
		
	}
	function handleFiles2(files) {
	   var fileSelect = document.getElementById("AddfileSelect"),
		   fileElem = document.getElementById("AddfileElem"),
		   fileList = document.getElementById("AddfileList");
	  if (!files.length) {
			fileList.innerHTML = langtext[0].initImageImportText;
		  } else {
			fileList.innerHTML = "";
			var list = document.createElement("ul");
			fileList.appendChild(list);
			for (var i = 0; i < files.length; i++) {
			  var li = document.createElement("li");
			  list.appendChild(li);
			  
			var img = document.createElement("img");
			img.src = window.URL.createObjectURL(files[i]);
			img.height = 120;
			img.onload = function() {
				window.URL.revokeObjectURL(this.src);
			}
			li.appendChild(img);
			var info = document.createElement("span");
			info.innerHTML = files[i].name + ": " + files[i].size + " bytes";
			li.appendChild(info);
			}
			document.getElementById('AddFile_accept').style.visibility="visible";
		}
	}

function closeAddFile(){
	//var fileSelect = document.getElementById("fileSelect");
	//	fileSelect.removeEventListener("click",function (e) {
	//	  if (fileElem) {
	//		fileElem.click();
	//	  }
	//	  e.preventDefault(); // prevent navigation to "#"
	//	});
		document.getElementById('ModalAddFile').style.display='none';
}

function longTimeAcceptDC(cond){
	var botonacept=document.getElementById('DC_accept');
	var botonacept2=document.getElementById('DC_accept2');
	
	if (cond){
		$("#DC_accept").attr("disabled", "disabled");
		$("#DC_accept2").attr("disabled", "disabled");
		botonacept.innerHTML='<img src="assets/cargando.gif" style="height:2.5em; width:auto;">';		
		botonacept2.innerHTML='<img src="assets/cargando.gif" style="height:2.5em; width:auto;">';		
	}
	else{
		botonacept.innerHTML='<img src="drawable/ic_action_accept.png" style="height:2.5em; width:auto;">';
		botonacept2.innerHTML='<img src="drawable/ic_action_accept.png" style="height:2.5em; width:auto;">';
		$("#DC_accept").removeAttr("disabled");
		$("#DC_accept2").removeAttr("disabled");
	}
}

var ConditionalTituloDossier='';
var ConditionalTituloDC='';	

async function accept_DC(Container){
	longTimeAcceptDC(true);
	var CopiesOfThisDC=[];
	var RexID = document.getElementById('DataClipRexId').value;
	var cameraReq = document.getElementById('DCCameraButt').getAttribute('required');
	var ImageSource=document.getElementById('ImgSource').value;
	if (cameraReq=="true" && ImageSource==""){
		longTimeAcceptDC(false);
		alert(langtext[0].mustTakePictureText);
		reOnclick_Accept();		
		return null;
	}	
	var DCElements  = document.getElementById(Container).children;
	var Conditional=false;
	var tituloDossier=document.getElementById('retHeadTituloDossier').value;// Para ponerle el titulo al dossier en caso de que este DC sea para creacion de dossiers
	var tituloDC=document.getElementById('retHeadTituloDC').value;// Para ponerle el titulo al DC en caso de que este DC sea para creacion de dossiers
	if (Container!='Conditionals')
		app.Tuplas=[];
	else{
		tituloDossier=ConditionalTituloDossier;
		tituloDC=ConditionalTituloDC;
	}
	var tags=[];
	//var tituloDossier="";

	for (i = 0; i <= DCElements.length - 1; i++) {
		var dctype = DCElements[i].getAttribute('dctype');
		if (dctype!=null){
			switch (dctype){
				case 'FingerPrintScan':
				case 'EdtAlert':
					if (DCElements[i].getAttribute('biometricpass')=="true" && DCElements[i].value!='' ){
						//longTimeAcceptDC(false);
						//alert('Se requiere de aprobacion biometroca por '+ DCElements[i].value);
						//reOnclick_Accept();
						//return null;
						var StrObj='{"BiometricPass":"true","V2":""}';
						var JsonObj=JSON.parse(StrObj);
						app.Tuplas.unshift(JsonObj);
					}
				case 'EdtML':					
					var value = DCElements[i].value;
					DCElements[i].value = value.replace(/(\r\n|\n|\r)/gm,"//n"); //Quita los returns, porque no son validos en json
				case 'Edt':
				case 'EdtPR':
				case 'Num':
				case 'Int':
				case 'ShortInt':
				case 'Email':
				case 'Date':
				case 'Time':
				case 'Telf':
					var rethead = DCElements[i].getAttribute('rethead');
					
					var value = DCElements[i].value;
					tituloDossier = tituloDossier.replace(rethead,value);
					tituloDC = tituloDC.replace(rethead,value);
					
					if (DCElements[i].required && value ==''){
						longTimeAcceptDC(false);
						alert(langtext[0].mustEnterValueText + DCElements[i].getAttribute('placeholder'));
						DCElements[i].focus();
						reOnclick_Accept();
						return null;
					}
					//var StrObj='{"'+rethead+'":"'+value+'"}';

					var unique='false';
					
					try{
						if (DCElements[i].getAttribute('unique')=="true"){
							unique='true';
						}
					}catch (e){}
					
					if (value!=''){
						var StrObj='{"V1":"' + rethead+ '","V2":"'+value+'","unique":"'+unique+'"}';
						var JsonObj=JSON.parse(StrObj);
						if (dctype=='FingerPrintScan'){
							JsonObj.dctype=dctype;
							JsonObj.operacion=DCElements[i].getAttribute('operacion');
							if (JsonObj.operacion=='R'){
								JsonObj.tipoFP=DCElements[i].getAttribute('tipoFP');
							}	
						}
						app.Tuplas.push(JsonObj);
					}
					break;
				
				case 'RIF':
				case 'IDBANKVE':
					var rethead = DCElements[i].getAttribute('rethead');
					var RIF1 = document.getElementById('RIF1').value;
					var RIF2 = document.getElementById('RIF2').value;
					var RIF3 = document.getElementById('RIF3').value;
					if (DCElements[i].getAttribute('required')!=null && (RIF1 =='' || RIF2=='' || RIF3=='') ){
						longTimeAcceptDC(false);
						alert(langtext[0].mustEnterCorrectlyText+dctype);
						document.getElementById('RIF2').focus();
						reOnclick_Accept();
						return null;
					}
					//var StrObj='{"'+rethead+'":"'+RIF1+'-'+RIF2+'-'+RIF3+'"}';
					
					unique='false';
					try{
						if (DCElements[i].getAttribute('unique')=="true"){
							unique='true';
						}
					}catch (e){}
					
					var StrObj='{"V1":"' + rethead+ '","V2":"'+RIF1+'-'+RIF2+'-'+RIF3+'","unique":"'+unique+'"}';
					var JsonObj=JSON.parse(StrObj);
					app.Tuplas.push(JsonObj);
					break;
				case 'DCLink': // para poder copiar a una carpeta una copia de un DC, pero sin usar spin con source
				case 'Spin':
					var rethead = DCElements[i].getAttribute('rethead');
					var value = DCElements[i].value;
					if (DCElements[i].required && value ==''){
						longTimeAcceptDC(false);
						alert(langtext[0].mustEnterValueText + DCElements[i].getAttribute('placeholder'));
						DCElements[i].focus();
						reOnclick_Accept();
						return null;
					}
					//var StrObj='{"'+rethead+'":"'+value+'"}';
					if (value.trim()!=''){
						var StrObj='{"V1":"' + rethead+ '","V2":"'+value+'"}';
						var JsonObj=JSON.parse(StrObj);
						app.Tuplas.push(JsonObj);
						tituloDossier = CleanDCLink(tituloDossier.replace(rethead,value));
						tituloDC = CleanDCLink(tituloDC.replace(rethead,value));
						var Copies = DCElements[i].getAttribute('copytosource');
						if (Copies=='true'){//get the RexId to copy to
							var pos = value.indexOf("dc(");
							if (pos>0){
								pos = value.indexOf(",",pos+1);
								if (pos>0){
									var cierre = value.indexOf(")",pos+1);
									var RexIdToCopy = value.slice(pos+1,cierre);
									CopiesOfThisDC.push(RexIdToCopy);
								}
							}
							
						}
					}
					else{
						tituloDossier = CleanDCLink(tituloDossier.replace(rethead,''));
						tituloDC = CleanDCLink(tituloDC.replace(rethead,''));						
					}
					break;
				case 'RadioV':
				case 'RadioVC':
				case 'Radio':
				case 'Check':
					var rethead = DCElements[i].getAttribute('rethead');
					var RadioName = DCElements[i].getAttribute('name');
					var RadioValuesEmpty = true;
					var radios = document.getElementsByName(RadioName);
					for (var ii = 0, length = radios.length; ii < length; ii++){ // solo para verificar si es requrido que exista un valor ( si yo se, se repite un chorrero de veces)
					 if (radios[ii].checked){
						RadioValuesEmpty=false;
						break;
					 }
					}
					if (DCElements[i].required && RadioValuesEmpty ==true){
						longTimeAcceptDC(false);
						alert(langtext[0].mustSelectValueText + DCElements[i].getAttribute('placeholder'));
						radios[0].focus();
						reOnclick_Accept();
						return null;
					}
					if (DCElements[i].checked){
						var value=DCElements[i].value;
						//var StrObj='{"'+rethead+'":"'+value+'"}';
						if (value!=''){
							var StrObj='{"V1":"' + rethead+ '","V2":"'+value+'"}';
							var JsonObj=JSON.parse(StrObj);
							app.Tuplas.push(JsonObj);
							tituloDossier = tituloDossier.replace(rethead,value);
							tituloDC = tituloDC.replace(rethead,value);					
						}
						if (dctype=='RadioVC'){
							Conditional=true;
						}						
					}
					break;
				case 'Table':
					var rethead = DCElements[i].getAttribute('rethead');
					var Rows = DCElements[2].rows;
					var JsObj='';
					for(var xx=0;xx< Rows.length;xx++){
						JsObj='{"V1":"' + rethead+ '"';
						var hasValue=false;
						for (var yy=0;yy<Rows[xx].children.length;yy++){
							JsObj = JsObj + ",";
							var cell = Rows[xx].children[yy];
							var value='';
							if (cell.children.length==1){
								value = cell.children[0].value;
								if (value!='')
									hasValue=true;
							}
							else{
								value = cell.innerHTML;
							}
							JsObj = JsObj + '"V'+ (yy+2) + '":"'+value+'"';
						}
						if (hasValue || xx==0){
							var JsonObj=JSON.parse(JsObj + "}");
							app.Tuplas.push(JsonObj);
						}
					}
					break;
			}
		}
	}
	if (Conditional){
		//var CondTupla=
		ConditionalTituloDossier=tituloDossier;
		ConditionalTituloDC=tituloDC;
		if (accept_DC('Conditionals')==null){
			return(null);
		}
		tituloDossier=ConditionalTituloDossier;
		tituloDC=ConditionalTituloDC;
		ConditionalTituloDossier='';
		ConditionalTituloDC='';				
	}
	if (Container=='Conditionals'){
	// hasta aqui llega la recursion
		ConditionalTituloDossier=tituloDossier;
		ConditionalTituloDC=tituloDC;
		return '';
	}
	//fromUser, fileid, DCType, longitud, latitud, status, repciId, when_date
	 	
	var DCWebId=document.getElementById('DCWebId').value;
	var PrevDC=document.getElementById('PrevDC').value;
	var NextDC=document.getElementById('NextDC').value;
		
	var d=new Date();
	
	var now = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2)  + " " + ("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);		
	var SaveImage='';
	
	if (ImageSource!="" && ImageSource.substr(0,3)=="FDC"){ // From DataClip
		//ya la imagen esta grabada en el servidor
		SaveImage = document.getElementById('DCImage').src;
		if (SaveImage.search("=")!=-1){
			var Paths =SaveImage.split("=");
			SaveImage=Paths[Paths.length -1];
		}
		if (ImageSource=="FDC-PDF"){
			SaveImage=document.getElementById('PdfFileName').value;
			RecyclePdf();
		}
		SaveImage=', "filename":"' + SaveImage + '", "base64img":""';
		
	}
	else{		
		if (ImageSource!=""){
			//generate filename
			if (cameraReq=="true" && ImageSource!="Cam"){// "true" es un string en este contexto
				longTimeAcceptDC(false);
				alert(langtext[0].imageMustBeFromCameraText);
				reOnclick_Accept();
				return null;
			}
			var ext = '';
			var base64Img=null;
			if (ImageSource=="Pdf"){
				var pdf64=await pdfDoc.getData();
				//base64Img=btoa(String.fromCharCode.apply(null, pdf64));
				base64Img=btoa(handleCodePoints(pdf64));					
				ext=".pdf";
				RecyclePdf();
			}
			else
				base64Img=document.getElementById('DCImage').src;
			if (DCWebId.indexOf("-")==-1){ // no est� en memoria
				if (base64Img!=null){
					if ( base64Img.slice(0,15)=="data:image/jpeg")
						ext=".jpg";
					else
						if ( base64Img.slice(0,14)=="data:image/png")
							ext=".png";
						else
							if ( base64Img.slice(0,14)=="data:image/bmp")
								ext=".bmp";
							else
								if (ImageSource=="Pdf"){
									ext=".pdf";
									RecyclePdf();
								}
								else
									ext="";
					if (ext!=""){
						var d = new Date();
						var n = d.toISOString();
						n=n.replace(/-/g,'');
						n=n.replace(/:/g,'');
						n=n.slice(0,n.indexOf('.'));
						var grupo=app.$refs.RexSelected.grupo;
						if (grupo==undefined)
							grupo = app.$refs.ModalRex.rexobj.grupo;	
						var filename=app.userid + '-G'+grupo+'-D'+ n + '-' + ImageSource+ext;
						SaveImage=', "filename":"' + filename + '", "base64img":"'+base64Img+'"';
					}
					//else{
						//alert('formato de imagen desconocida (no se grab�)');
					//}
				}				
			}
			else{
				var DCWebIdInt = parseInt(DCWebId);
				var dbdc = db.DataClips.get(-DCWebIdInt);
				if (base64Img!=null){
					if ( base64Img.slice(0,15)=="data:image/jpeg")
						ext=".jpg";
					else
						if ( base64Img.slice(0,14)=="data:image/png")
							ext=".png";
						else
							if ( base64Img.slice(0,14)=="data:image/bmp")
								ext=".bmp";
							else
								if (ImageSource=="Pdf"){
									ext=".pdf";
									RecyclePdf();
								}
								else
									ext="";
					if (ext!=""){
						var d = new Date();
						var n = d.toISOString();
						n=n.replace(/-/g,'');
						n=n.replace(/:/g,'');
						n=n.slice(0,n.indexOf('.'));		
						var grupo=app.$refs.RexSelected.grupo;
						if (grupo==undefined)
								grupo = app.$refs.ModalRex.rexobj.grupo;	
						var filename="";
						if (dbdc==undefined || dbdc.filename==undefined || dbdc.filename=="" || dbdc.filename=="undefined")
							filename=app.userid + '-G'+grupo+'-D'+ n + '-' + ImageSource+ext;
						else
							filename = dbdc.filename;
						SaveImage=', "filename":"' + filename + '", "base64img":"'+base64Img+'"';
					}
					//else{
						//alert('formato de imagen desconocida (no se grab�)');
					//}
				}
			}
		}
	}

	//var DCHeaderStr='{"repciID":"' + app.$refs.ModalRex.rexobj.repciId + '","user":"' + app.userid + '","DCType":"' + app.SelectedDC + '","when_date":"' + now + '","longitud":"' + app.currentLongitud + '","latitud":"' + app.currentLatitud+ '","IP":"'+ data.ip +'","GPSOrg":"'+ app.currentGPSOrigin + '"' + SaveImage + '}';
	// DCWebId if exists then it is an update of the DC
	var DCHeaderStr='{"repciID":"' + RexID + '","user":"' + app.userid + '","DCWebId":"' + DCWebId + '","PrevDC":"' + PrevDC + '","NeExtDC":"' + NextDC +'","DCType":"' + app.SelectedDC + '","when_date":"' + now + '","longitud":"' + app.currentLongitud + '","latitud":"' + app.currentLatitud+ '","IP":"","GPSOrg":"'+ app.currentGPSOrigin + '"' + SaveImage + ',"CopyToRexs":[' + CopiesOfThisDC.toString() + ']}';

	var JsonDCHeader = JSON.parse(DCHeaderStr);
	//alert('Saving DC from IP success');
		
	if (JsonDCHeader.repciID=="" || JsonDCHeader.DCType.toUpperCase()==app.$root.DataClips[0].Code.toUpperCase()){
		if (tituloDossier!=undefined && tituloDossier!="undefined")
			JsonDCHeader.titulo=tituloDossier;
		JsonDCHeader.grupo=app.$refs.ModalRex.rexobj.grupo;
		JsonDCHeader.notift=app.$refs.ModalRex.rexobj.notift;
		JsonDCHeader.repcitype=app.$refs.ModalRex.rexobj.repcitype;
	}
	if (tituloDC!="undefined")
		JsonDCHeader.Comment=tituloDC;
	if (app.GrupoJson.data.Totales!=undefined  && app.GrupoJson.data.Totales!="undefined")
		JsonDCHeader.Totales=app.GrupoJson.data.Totales;	// manda al servidor o guarda localmente la forma de calcular los totales de ese dossier
		
	if (app.SelectedDC == 'Anexo')
		JsonDCHeader.Comment=app.Tuplas[0].V2; //Si es un Anexo, agrega en comentario la descripcion del anexo		
		
	for (xx=0;xx<app.DataClips.length;xx++){
		if (app.DataClips[xx].Code==app.SelectedDC){
			if (app.DataClips[xx].onSave!=undefined && app.DataClips[xx].onSave!=""){
				JsonDCHeader.onSave=app.DataClips[xx].onSave;
			}
			break;
		}
	}
	
	SaveDC(JsonDCHeader,app.Tuplas);
	reOnclick_Accept();	
	return '';
}

function handleCodePoints(array) {
  var CHUNK_SIZE = 0x8000; // arbitrary number here, not too small, not too big
  var index = 0;
  var length = array.length;
  var result = '';
  var slice;
  while (index < length) {
    slice = array.slice(index, Math.min(index + CHUNK_SIZE, length)); // `Math.min` is not really necessary here I think
    result += String.fromCharCode.apply(null, slice);
    index += CHUNK_SIZE;
  }
  return result;
}

function CleanDCLink(strText){
	var Texto = strText;
	var pos = Texto.indexOf(" dc(")
	while (pos>0){
		var cierre = Texto.indexOf(")", pos + 4);
		if (cierre > 0){
			Texto = Texto.slice(0,pos) + Texto.slice(cierre+1);
		}
		else
			return (Texto);
		pos = Texto.indexOf(" dc(");
	}
	return (Texto);		
}

function getDC_Rex(strText){
	var Texto = strText;
	var pos = Texto.indexOf(" dc(");
	var retVal = [];
	if (pos>0){
		var cierre = Texto.indexOf(")", pos + 4);
		if (cierre > 0){
			Texto = Texto.slice(pos+4,cierre);
			retVal = Texto.split(',');
		}
	}
	return (retVal);
}

function PosError(err){
	  alert(err.message);
	switch(err.code) {
	case err.PERMISSION_DENIED:
	  alert(langtext[0].userDeniedGeolocationText);//"User denied the request for Geolocation.");
	  break;
	case err.POSITION_UNAVAILABLE:
	  alert(langtext[0].noLocationInfoText);//"Location information is unavailable.");
	  break;
	case err.TIMEOUT:
	  alert(langtext[0].geolocationTimedOutText);//"The request to get user location timed out.");
	  break;
	case err.UNKNOWN_ERROR:
	  alert(langtext[0].errorDesconocidoText);//"An unknown error occurred.");
	  break;
  }
}

function CreateRex(Head,Tuple){
	var RexObj={};
	var DC={};
	
	var toktok='666123';
	
	RexObj.token = toktok;
	RexObj.repciId = Head.repciID;
	RexObj.repcitype = Head.repcitype;
	RexObj.creator = Head.user;
	RexObj.when_date = dateFns.format(Head.when_date,'YYYYMMDD[T]HHmmss');
	RexObj.when_date = RexObj.when_date.slice(0, -2)+'00';
	RexObj.longitud = Head.longitud;
	RexObj.latitud = Head.latitud;
	RexObj.titulo = Head.titulo;
	RexObj.grupo = Head.grupo;
	RexObj.notift = Head.notift;
	RexObj.Images = [];
	RexObj.Images.push(Head.filename);

	return RexObj;
}

function CreateDC(Head,Tuple,repciID){
	var DC={};
	
	var toktok='666123';
	
	DC.repciId = repciID;
	DC.DCWebId = Head.DCWebId;
	DC.DCType = Head.DCType;
	DC.longitud = Head.longitud;
	DC.latitud = Head.latitud;
	DC.IP = Head.IP;
	DC.GPSOrg = Head.GPSOrg;
	DC.comment = Head.Comment;
	DC.fromUser = Head.user;
	DC.when_date = Head.when_date;
	DC.status = 0;
	DC.PrevDC = 0;
	DC.filename = Head.filename; // or image.jpg
	DC.base64img = Head.base64img;
	//DC.Tuples = [];
	return DC;
}

function CreateTuplas(Tuple,DCid){
	var Tuples = [];
	for (var xx=0;xx<Tuple.length;xx++){
		var Dctuples={};
		Dctuples.idDC=DCid;
		Dctuples.value1=Tuple[xx].V1;
		Dctuples.value2=Tuple[xx].V2;
		Dctuples.value3=Tuple[xx].V3;
		Dctuples.value4=Tuple[xx].V4;
		Dctuples.value5=Tuple[xx].V5;
		Tuples.push(Dctuples);
	}
	return Tuples;
}

function syncDB(){
	if (!('Notification' in window)){
		//debe ser ios Safari
		document.getElementById('uploadrexs').style.display='none';
		document.getElementById('synclogo').classList.add("fa-spin");
		document.getElementById('synclogo').style.color="red";
		document.getElementById('enMemoriaButton').focus();	
		RemoveAllLocalnGrid();
		SaveDcToServer();
		return;
	}
	if (ServiceWorker){
		document.getElementById('uploadrexs').style.display='none';
		ServiceWorker.sync.register('sync-db'); // dile al service worker que tiene uno mas que sincronizar.
		document.getElementById('synclogo').classList.add("fa-spin");
		document.getElementById('synclogo').style.color="red";
		document.getElementById('enMemoriaButton').focus();	
		RemoveAllLocalnGrid()		
		//alert('syncing...');
	}
	else
		alert(langtext[0].tryAgainSoonText);
}

async function SaveDC(Head,Tuple){
	longTimeAcceptDC(true);
	//comienzo verificando si para grabar este DC se requiere de una aprobacion biometrica de parte de un supervisor
	if (Tuple[0].BiometricPass!=undefined && Tuple[0].BiometricPass=="true"){
		longTimeAcceptDC(false);
		////////////////////
		
		alert(langtext[0].mustBeApprovedBySupervisorText);
		
		Tuple.shift(); // quita esta restriccion biometrica
		var FPlink = FingerPrintCall+'/?tr=I&tip=H';
		var misCabeceras = new Headers();
		misCabeceras.append("Content-Type", "application/x-www-form-urlencoded");

		var miInit = { method: 'GET',
			   headers: misCabeceras,
			   cache: 'default' };
		fetch(FPlink,miInit).then(response => response.text())
					.then(function(response){
						var xml = $.parseXML(response);
						var id = $(xml).find('id').text();
						var opresult = $(xml).find('cod').text();
						var textresult= ResultFPOPText(opresult);
						if (opresult != "0"){
							alert(langtext[0].cantRegisterText + $(xml).find('id').text() + langtext[0].commaResultIsText+ textresult);
						}											
						else{
							var nm = $(xml).find('nm').text();
							var ap = $(xml).find('ap').text();
							var tf = $(xml).find('tf').text();
							if (tf=='S'){
								var StrObj='{"V1":"'+langtext[0].approvedByText+'","V2":"'+id+ '-' + ap + ' ' + nm + '"}';
								var JsonObj=JSON.parse(StrObj);
								app.Tuplas.push(JsonObj);
								SaveDC(Head,Tuple);
							}
						
						}
					})
					.catch(function(err) {
						alert(langtext[0].cantTakeSupervisorText, err);
					});
		///////////////////
		return null;
	}
	//////////////////////////////
	//busco si hay un elemento que sea para grabar una huella digital
	for (tt=0;tt<Tuple.length;tt++){
		if (Tuple[tt].dctype!=undefined && Tuple[tt].dctype=="FingerPrintScan"){
			longTimeAcceptDC(false);
			////////////////////
			if (Tuple[tt].operacion=='R'){
				alert(langtext[0].getFingerPrintText);
			}
			
			//verificacion de campos ingresados para el registro de la huella
			var Cedula = '';
			try{
				Cedula = $('[rethead="Cedula"]')[0].value;
				if (Cedula==""){
					alert(langtext[0].enterIdToRegFingerPrintText);
					$('[rethead="Cedula"]').focus();
					return null;
				}
			}
			catch(e){
				alert(langtext[0].mustEnterIdText);
				return null;
			}
			if (Tuple[tt].operacion=='R'){
				var Apellidos = '';
				try{
					Apellidos = $('[rethead="Apellidos"]')[0].value;
					if (Apellidos==""){
						alert(langtext[0].mustEnterLastNameText);
						$('[rethead="Apellidos"]').focus();
						return null;
					}
				}
				catch(e){
					alert(langtext[0].mustEnterLastNameText)
					return null;
				}
				var Nombres = '';
				try{
					Nombres = $('[rethead="Nombres"]')[0].value;
					if (Nombres==""){
						alert(langtext[0].mustEnterNameText);
						$('[rethead="Nombres"]').focus();
						return null;
					}
				}
				catch(e){
					alert(langtext[0].mustEnterNameText)
					return null;
				}
				if ( Cedula =='' || Apellidos =='' || Nombres =='' ){
					alert(langtext[0].mustEnterAllText)
					return null;
				}
			}
			
			var FPlink = '';
			if (Tuple[tt].operacion=='R')
				FPlink = FingerPrintCall+'/?tr=R&id='+Cedula+'&nm='+Nombres+'&ap='+Apellidos+'&tip=H'+'&tf='+Tuple[tt].tipoFP;
			else	
				FPlink = FingerPrintCall+'/?tr=D&id='+Cedula+'&tip=H';

			var misCabeceras = new Headers();
			misCabeceras.append("Content-Type", "application/x-www-form-urlencoded");

			var miInit = { method: 'GET',
				   headers: misCabeceras,
				   cache: 'default' };
			fetch(FPlink,miInit).then(response => response.text())
						.then(function(response){
							var xml = $.parseXML(response);
							var id = $(xml).find('id').text();
							var opresult = $(xml).find('cod').text();
							var textresult= ResultFPOPText(opresult);
							if (opresult != "0"){
								alert(langtext[0].couldNotExecText + $(xml).find('id').text() + langtext[0].commaResultIsText+ textresult);
							}											
							else{
								var StrObj='{"V1":"'+Tuple[tt].V1+'","V2":"'+id+'"}';
								var JsonObj=JSON.parse(StrObj);
								Tuple[tt]=JsonObj; //sustituye el vacio por el que te da el core biometrico
								SaveDC(Head,Tuple);
							}
						})
						.catch(function(err) {
							if (Tuple[tt].operacion=='R')
								alert(langtext[0].cantGetFingerPrintText, err);
							if (Tuple[tt].operacion=='D')
								alert(langtext[0].cantDelFingerPrintText, err);
							//StrObj='{"V1":"'+Tuple[tt].V1+'","V2":"'+0000+'"}';
							//JsonObj=JSON.parse(StrObj);
							//Tuple[tt]=JsonObj; //sustituye el vacio por el que te da el core biometrico
							//SaveDC(Head,Tuple);
						});
			///////////////////
			return null;
		}
	}
	
	//////////////////////////////
	var repciId = Head.repciID;
	var autosave = document.getElementById('DCContainer').getAttribute('autosave')=='true';
	if (repciId == "" && !autosave){ // es nuevo el rex
		var rex=CreateRex(Head,Tuple);	
		db.rexs.add(rex).then(function(){
			db.rexs.orderBy('id').last().then (function(lastrex){
				var repciId = -(lastrex.id);
				var Dc=CreateDC(Head,Tuple,repciId);
				db.DataClips.add(Dc).then(function(){
					db.DataClips.orderBy('id').last().then (function(lastdc){
						var DCID = -(lastdc.id);
						var Tuples = CreateTuplas(Tuple,DCID);
						db.Tuplas.bulkAdd(Tuples).then(function(){
							longTimeAcceptDC(false);
							//syncDB();
							document.getElementById('ModalDataClipEditor').style.display='none';
							document.getElementById('Editando').style.display='none';
							DeleteImagefromDC();
							//closeModalTarea();
							//closeModalRecordatorio();
							//closeModalCita();
							dbGetCantNoSync();//Actualiza cuantos rexs hay en el UI
							app.$refs.RexSelected.getRexData(parseInt(repciId));
							ShowCarpetas();							
						}
						)
					}
					)
				}
				)
			}
			)
		}).catch(error=>
			alert(langtext[0].errorSavingDC + JSON.stringify(error))
			)
	}
	else{ //ya est� en indexedDB el rex, solo se le est� agregando un DC
		if (repciId.indexOf("-")==-1 || autosave){
			SaveDCServer(Head,Tuple);
		}
		else{
			var Dc=CreateDC(Head,Tuple,parseInt(repciId));
			if (Dc.DCWebId==undefined || Dc.DCWebId==""){
				if (Head.titulo!=""){
					repciId = -Head.repciID;
					db.rexs.where('repciId').equals(repciId).modify(function(rex){
						rex.titulo = Head.titulo;
					 });
				}	
				
				db.DataClips.add(Dc).then(function(){
					db.DataClips.orderBy('id').last().then (function(lastdc){
						var DCID = -(lastdc.id);
						var Tuples = CreateTuplas(Tuple,DCID);
						db.Tuplas.bulkAdd(Tuples).then(function(){
							longTimeAcceptDC(false);
							//syncDB();
							document.getElementById('ModalDataClipEditor').style.display='none';
							document.getElementById('Editando').style.display='none';
							DeleteImagefromDC();
							dbGetCantNoSync();//Actualiza cuantos rexs hay en el UI
							app.$refs.RexSelected.getRexData(parseInt(-repciId));
							ShowDCinGridById(-DCID,parseInt(-repciId));
						})
					})
				})
			}
			else{
				await db.Tuplas.where('idDC').equals(parseInt(Dc.DCWebId)).delete();
				await db.DataClips.delete(-parseInt(Dc.DCWebId));
				RemoveIfInGrid(parseInt(Dc.DCWebId));
				Dc.DCWebId="";
				if (Head.titulo!=""){
					repciId = -Head.repciID;
					db.rexs.update(repciId, {titulo:Head.titulo });
				}
				if (Head.filename!=""){ //Si estas agregnado un DC con imagenes, 
					repciId = -Head.repciID;					
					var rex = await db.rexs.get(repciId);
					if (rex.Images.length==1)
						if (rex.Images[0]==undefined)
							rex.Images[0]=Head.filename;
						else
							rex.Images.push(Head.filename);
					else
						rex.Images.push(Head.filename);
					db.rexs.update(repciId,{Images:rex.Images});
				}
				db.DataClips.add(Dc).then(function(){
					db.DataClips.orderBy('id').last().then (function(lastdc){
						var DCID = -(lastdc.id);
						var Tuples = CreateTuplas(Tuple,DCID);
						db.Tuplas.bulkAdd(Tuples).then(function(){
							longTimeAcceptDC(false);
							//syncDB();
							document.getElementById('ModalDataClipEditor').style.display='none';
							document.getElementById('Editando').style.display='none';
							DeleteImagefromDC();
							dbGetCantNoSync();//Actualiza cuantos rexs hay en el UI
							app.$refs.RexSelected.getRexData(parseInt(-repciId));
							ShowDCinGridById(-DCID,parseInt(-repciId));
						})
					})
				})
			}
		}
	}   
}

function SaveDCServer(Head,Tuple){
	//alert(JSON.stringify(Head));
	//alert(JSON.stringify(Tuple));
	longTimeAcceptDC(true);
			
	var toktok='666123';
	
	var JsonObj = { "token": toktok, "head": Head, "tuple": Tuple };
	var Method="POST";
	//if (Head.DCWebId!="") //EverLeap no permite usar PUT creo que porque usa WEBDAV trate de anularlo pero no se pudo
	//	Method="PUT";
	$.ajax({
        url: "api/saveDC-v132.php?",
        type: Method,
        data: JSON.stringify(JsonObj),
        dataType: "text",
        success: function (result) {
					var testResult = result.replace(/"/g, '');//quitale todas las doble comillas con las que viene
					if ($.isNumeric(testResult)){
						//alert("Exito el DC es:"+testResult);
						DescDC=DescDataDCCode(Head.DCType);
						if (DescDC==langtext[0].Tarea || DescDC== langtext[0].Anexo)
							DescDC+= '-' + Tuple[0].V2;
						if (DescDC==langtext[0].Recordatorio)
							DescDC+= '-' + Tuple[1].V2;

						if (app.$refs.ModalRex.rexobj.repciId!="" || document.getElementById('DataClipRexId').value!=""){ // no es nuevo 
							if (Head.DCWebId=="") // new DC, then pushit
								try{
									app.$refs.ModalRex.PushDC(testResult,DescDC); // mosca, esto depende de la presentacion en el editor del dataclip
								}
								catch(e){
									var xyz=0;
								}
							else{
								try{
									app.$refs.ModalRex.ShowDC(testResult);
								}
								catch(e){
									var xyz=0;
								}
							}
							RemoveIfInGrid(Head.DCWebId);// hacer una funcion que utilice el mismo frame que el anterior
							if (Head.repciID!="")
								ShowDCinGridById(testResult,Head.repciID);
						}
						// cierra cualquier modal desde donde fue llamado SaveDC
						document.getElementById('ModalDataClipEditor').style.display='none';
						document.getElementById('Editando').style.display='none';
						longTimeAcceptDC(false);
						if (app.$refs.ModalRex.rexobj.repciId==""){
							//Busca el nuevo rex y cargalo. en el Editor y en Muuri
							app.LoadRexByDCtoEditorAndMuuri(testResult);	
						}
						else{
							app.seleccionRex(app.$refs.ModalRex.rexobj);
							if (Head.filename!='')
								app.$refs.ModalRex.rexobj.picfiles.push(Head.filename);
						}
						
						//closeAddFile();
					}
					else{
						if (result!='')
							alert(langtext[0].problemSavingText+result);
						longTimeAcceptDC(false);
					}
					app.Tuple=[];
					DeleteImagefromDC();
					document.all.CalendarFrame.contentWindow.reFetch();//Refresca el calendario en caso de que se guarde Tarea, Recordatorio o Cita
					app.$refs.RexSelected.getRexData(parseInt(Head.repciID));
					
					if (document.getElementById('ModalRexEditor').style.display=="block"){
						app.$refs.ModalRex.getRexData(parseInt(Head.repciID));
						setTimeout(function () {							
							app.$refs.ModalRex.ShowDC(testResult);
						}, 5000);
					}
					if (Head.onSave!=undefined && Head.onSave!="" && Head.repciID==""){ //Solo levanta el proximo DC si es nuevo
						setTimeout(function () {							
								//alert('Loading next DC');
								for(dd=app.DataClips.length-1;dd>=0;dd--){
									if (app.DataClips[dd].NoShow!=undefined && app.DataClips[dd].NoShow=="true")
										app.DataClips.splice(dd,1);	//remove no show element.	
								}
								//if (app.DataClips[0].NoShow!=undefined && app.DataClips[0].NoShow=="true")
								//	app.DataClips.shift(); //remove first element. el que se usa solo en la creacion de la carpeta
								document.getElementById('DataClipRexId').value = app.$refs.RexSelected.rexobj.repciId;
								//document.getElementById('retHeadTituloDossier').value=='';
								var Operacion = Head.onSave;
								if (Operacion.slice(0,6)=='LoadDC'){
									var OperDC = Operacion.slice(7);
									OperDC = OperDC.slice(0,OperDC.length-1);
									for (xx=0;xx<app.DataClips.length;xx++){
										if (app.DataClips[xx].Code = OperDC){
											app.LoadDC(xx);
											break;
										}
									}
								}
								
							}, 5000);
					}
					
            },
        error: function (xhr, ajaxOptions, thrownError) {
			//alert("No se pudo registrar DC status:".xhr.status." Error: ".thrownError);
			longTimeAcceptDC(false);
			alert('SaveDCServer Status: '+ xhr.status);
			alert('SaveDCServer Error: '+thrownError);
			app.Tuple=[];
        }
    });
}

</script>


<script>
// Script for side navigation
function w3_open() {
	document.getElementById("mySidebar").classList.remove('w3-hide-small');
    var x = document.getElementById("mySidebar");
    if (x.style.display == "block"){
		w3_close();
		return;
	}		
	x.style.width = "350px";
    x.style.display = "block";
	document.getElementById("MainWP").style.marginLeft = "350px";
	setTimeout(function () {							
				grid.refreshItems().layout();
			}, 1000);
	
	//document.getElementById("openNav").style.display = 'none';
}

// Close side navigation
function w3_close() {
	document.getElementById("MainWP").style.marginLeft = "0px";
    document.getElementById("mySidebar").style.display = "none";
	setTimeout(function () {							
				grid.refreshItems().layout();
			}, 1000);
	//document.getElementById("openNav").style.display = "inline-block";
}

// Used to toggle the menu on smaller screens when clicking on the menu button
function openNav() {
    var x = document.getElementById("navDemo");
    if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
    } else { 
        x.className = x.className.replace(" w3-show", "");
    }
}
function closeNav() {
    var x = document.getElementById("navDemo");
    if (x.className.indexOf("w3-show") != -1) {
        x.className = x.className.replace(" w3-show", "");
    }
}


</script>
  <script>
      var datepickerOptions = {
		  sundayFirst: false,
		  dateLabelFormat: 'dddd, MMMM D, YYYY',
		  days: [langtext[0].Lunes, langtext[0].Martes, langtext[0].Miercoles, langtext[0].Jueves, langtext[0].Viernes, langtext[0].Sabado, langtext[0].Domingo],
		  daysShort: [langtext[0].Lun, langtext[0].Mar, langtext[0].Mie, langtext[0].Jue, langtext[0].Vie, langtext[0].Sab, langtext[0].Dom],
		  monthNames: [
		  langtext[0].Enero,
		  langtext[0].Febrero,
		  langtext[0].Marzo,
		  langtext[0].Abril,
		  langtext[0].Mayo,
		  langtext[0].Junio,
		  langtext[0].Julio,
		  langtext[0].Agosto,
		  langtext[0].Septiembre,
		  langtext[0].Octubre,
		  langtext[0].Noviembre,
		  langtext[0].Diciembre,
		  ],
		  colors: {
			selected:'#ff6600',
			inRange:'#ffc299',
			selectedText:'#fff',
			text:'#565a5c',
			inRangeBorder:'#cc5200',
			disabled:'#fff',
		  },
		  texts: {
			apply: langtext[0].apply,
			cancel: langtext[0].cancel,
			keyboardShortcuts: langtext[0].keyboardShortcuts,
		  },
		  keyboardShortcuts: [
			{symbol: '?', label: langtext[0].selectedDateText, symbolDescription: langtext[0].EnterKeyText},
			{symbol: '?/?', label: langtext[0].leftRight4Days, symbolDescription: langtext[0].LeftRightKeysText},
			{symbol: '?/?', label: langtext[0].upDown4Weeks, symbolDescription:langtext[0].UpDownKeysText },
			{symbol: langtext[0].symbolRePagAvPatText, label: langtext[0].cambioMes, symbolDescription: langtext[0].RePagAvPagKeysText},
			{symbol: langtext[0].symbolInicioFinText, label: langtext[0].firstLastWeekText, symbolDescription: langtext[0].InicioFinKeysText},
			{symbol: langtext[0].symbolEscText, label: langtext[0].closePanelText, symbolDescription: langtext[0].EscKeyText},
			{symbol: '?', label: langtext[0].openPanelText, symbolDescription: langtext[0].QuestionKeyText}
		  ]
	  }
    Vue.use(window.AirbnbStyleDatepicker, datepickerOptions)

        var app = new Vue({
            el: '#app',
			components:{
				'rex':{
					template: '#rexfolder',
					data: 
						function (){
							return {
								rexobj:{
									repciId : '',
									when_date : null,
									picon: '',
									titulo: '',
									creator: '',
									pict: '',
									ricon: '',
									aicon: '',
									grupo: '',
									name: '',
									Dcs: []
								},
							};
						},
					methods:{
						getRexData: function(id){
							if (id<0){ // esta en el IndexedDB								
								db.rexs.get(-id, function (dbrex) {
									app.rexobj = dbrex;
									if (app.rexobj.Images[0]==undefined || app.rexobj.Images[0]==""){
										app.rexobj.Images[0]='DCImages/default'+ dbrex.grupo +'.jpg';
										app.rexobj.picfiles = 'DCImages/default'+ dbrex.grupo +'.jpg';
									}
									else{
										app.rexobj.picfiles=app.rexobj.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.
										app.rexobj.pict = app.rexobj.Images[0];
									}
									app.rexobj.ricon = 'ricons/'+ dbrex.grupo +'.png';
									app.rexobj.aicon = 'aicons/user-'+dbrex.creator+'.jpg';
									app.rexobj.picon = 'assets/pinon32.png';
									app.rexobj.Dcs=[];																		
									db.DataClips.where('repciId').equals(id).each(function (Dc){
																			app.rexobj.Dcs.push({'id':Dc.id,'text':Dc.DCType+ ' ' + Dc.comment});
																			});		
		
									if (jQuery.isEmptyObject(app.$root.GrupoJson) || app.$root.GrupoJson.id!= app.$refs.RexSelected.rexobj.grupo){
										app.$http.get("grupos/" + app.$refs.RexSelected.rexobj.grupo + ".json").then (function(response){
											app.$root.GrupoJson = response; 
											app.$refs.RexSelected.rexobj.nombreGrupo = app.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
											app.$root.DataClips = app.$root.GrupoJson.data.logs[app.$refs.RexSelected.rexobj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
											//limpia en el rex los Dcs que este usuario no puede ver
											app.$refs.RexSelected.rexobj=SecurityDCFilter(app.$refs.RexSelected.rexobj,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
											// luego quita los dataclips que no puede ver
											app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
											if (!app.$root.DataClips){
												app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
												alert(langtext[0].errorStructTransferText);
												return (false);
											}
											document.getElementById('retHeadTituloDossier').value = app.$root.DataClips[0].tituloDossier;
											//document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
											if (app.$refs.RexSelected.rexobj.Dcs)
												app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);
										}, function(error){
											app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
											alert(langtext[0].errorStructTransferLocalText);
										});
									}
									else{
										app.rexobj.nombreGrupo = app.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
										app.$root.DataClips = app.$root.GrupoJson.data.logs[app.rexobj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
										app.$refs.RexSelected.rexobj=SecurityDCFilter(app.$refs.RexSelected.rexobj,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
										app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
										if (!app.$root.DataClips){
											app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
											alert(langtext[0].errorStructTransferLocalSecText);
											return (false);
										}	
																				
										document.getElementById('retHeadTituloDossier').app = app.$root.DataClips[0].tituloDossier;
										//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
										if (app.rexobj.Dcs)
											app.rexobj.Dcs=ReText(app.rexobj.Dcs);							
									}
									app.$refs.RexSelected.rexobj=app.rexobj;
									setTimeout(function () {
										addRex(app.$refs.RexSelected);
									}, 500);
								});
							return;
							}
							link='api/dossier.php/repcis/'+id;
							//this.$http.get(link).then(function(response){
							fetch(link).then(response => response.json()).then(function(response){
								//var dummystr = response.data[0];
								//dummystr=dummystr.replace(/'/g,'"');
								var RexObj = response[0];
								app.$refs.RexSelected.rexobj = RexObj;
								//app.grupochartselected = RexObj.grupo;
								//app.gruposelected = RexObj.grupo;
								if (app.$refs.RexSelected.rexobj.Images[0]!=""){
									app.$refs.RexSelected.rexobj.picfiles=app.$refs.RexSelected.rexobj.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.
									app.$refs.RexSelected.rexobj.pict = 'api/thumb.asp?path='+RexObj.picfiles[0];
								}
								else
									app.$refs.RexSelected.rexobj.pict = 'api/thumb.asp?path='+RexObj.picfiles[0];
								app.$refs.RexSelected.rexobj.ricon = 'ricons/'+ RexObj.grupo +'.png';
								app.$refs.RexSelected.rexobj.aicon = 'aicons/user-'+RexObj.creator+'.jpg';
								app.$refs.RexSelected.rexobj.picon = 'assets/pinon32.png';
								if (jQuery.isEmptyObject(app.$root.GrupoJson) || app.$root.GrupoJson.id!= app.$refs.RexSelected.rexobj.grupo){
									app.$http.get("grupos/" + app.$refs.RexSelected.rexobj.grupo + ".json").then (function(response){
										app.$root.GrupoJson = response;
										app.$refs.RexSelected.rexobj.nombreGrupo = app.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
										if (app.$refs.RexSelected.rexobj.notift==undefined)
											app.$refs.RexSelected.rexobj.notift=0;
										app.$root.DataClips = app.$root.GrupoJson.data.logs[app.$refs.RexSelected.rexobj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
										/*app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
										if (!app.$root.DataClips){
											app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
											alert('Error transfiriendo estructura del grupo actual localmente por seguridad');
											return (false);
										}*/
										document.getElementById('retHeadTituloDossier').value = app.$root.DataClips[0].tituloDossier;
										//document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
										if (app.$refs.RexSelected.rexobj.Dcs)
											app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);
										var okFilter=SecurityDCFilter(app.$refs.RexSelected.rexobj,app.GrupoJson,parseJwt(app.JWT).perfiles);
										if (okFilter!=false){
											app.$refs.RexSelected.rexobj=okFilter;
											app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);
											//app.$refs.RexSelected.$forceUpdate();
											}
										else{
											app.$refs.RexSelected.rexobj=null;
											//alert('No tienes Perfil para ver este dossier');
											alert('Trata nuevamente');
										}
										setTimeout(function () {
											addRex(app.$refs.RexSelected);
										}, 500);
									}, function(error){
										app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
										alert(langtext[0].errorStructTransferRemoteText);
									});
								}
								else{
									app.$refs.RexSelected.rexobj.nombreGrupo = this.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
									if (app.$refs.RexSelected.rexobj.notift==undefined)
										app.$refs.RexSelected.rexobj.notift=0;
									app.$root.DataClips = app.$root.GrupoJson.data.logs[app.$refs.RexSelected.rexobj.notift].DCs; //app.$refs.RexSelected.rexobj.notift
									/*app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
									if (!app.$root.DataClips){
										app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
										alert('Error transfiriendo estructura del grupo actual localmente por seguridad');
										return (false);
									}*/
									document.getElementById('retHeadTituloDossier').value = app.$root.DataClips[0].tituloDossier;
									//document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
									if (app.$refs.RexSelected.rexobj.Dcs)
										app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);	
									var okFilter=SecurityDCFilter(app.$refs.RexSelected.rexobj,app.GrupoJson,parseJwt(app.JWT).perfiles);
									if (okFilter!=false){
										app.$refs.RexSelected.rexobj=okFilter;
										app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);
										//app.$refs.RexSelected.$forceUpdate();
										}
									else{
										app.$refs.RexSelected.rexobj=null;
										//alert('No tienes Perfil para ver este dossier');
										alert(langtext[0].tryAgain);
									}
									setTimeout(function () {
										addRex(app.$refs.RexSelected);
									}, 500);
								}
								}, function(error){
								console.log(error.statusText);
							});
						},
						setRexData: function(rexObj){
							this.rexobj = rexObj;
						},
						workOnRex: function(id){
							WorkOnRex(id);
						},
						errorIMG: function(im,path){
							im.src=path;
						}
					},
					mounted:function () {
					  var srcId = this.$el.getElementsByClassName("slot-wrapper")[0].innerHTML;
					  if (srcId!=null && srcId!=''){
						this.getRexData(srcId);
					  }
					}        			
				},
				'dc_details':{
					template: '#dc_dets',
					data: 
						function (){
							return {
								dcobj:{
									id:0,
									repciId : '',
									fromUser : '',
									when_date : null,
									DCType: '',
									titulo: '',
									longitud: 0,
									latitud: 0,
									status: 0,
									PrevDc: '',
									NextDC: '',
									filepath: '',
									comment: '',
									tuplas:[]
								}
							};
						},
					methods:{
						getDcData: function (dcId){
						link='api/Dcs-V2.php/'+dcId;
						return new Promise((resolve, reject) => {
							fetch(link).then(response => response.json()).then(function(response){
								var status0style='';
								if (response.repciId==undefined || response.repciId== '' || response.repciId==0)
									alert(langtext[0].cantLoadDataClip+dcId);
						
								if (response.status==-1) {
									status0style="opaque:0.5;background-image: url('assets/NoValido2.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
								}
								else{
									if (response.DCType == langtext[0].Tarea){
										if (response.status == "1" || response.status == "-2")
											status0style="opaque:0.5;background-image: url('assets/sello/aceptada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										if (response.status == "2" || response.status == "-3")
											status0style="opaque:0.5;background-image: url('assets/sello/enprogreso.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										if (response.status == "3" || response.status == "-4")
											status0style="opaque:0.5;background-image: url('assets/sello/lista.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										if (response.status == "4" || response.status == "-5")
											status0style="opaque:0.5;background-image: url('assets/sello/incompleta.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										if (response.status == "5" || response.status == "-6")
											status0style="opaque:0.5;background-image: url('assets/sello/anulada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										if (response.status == "6" || response.status == "-7")
											status0style="opaque:0.5;background-image: url('assets/sello/borrada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
									}
									else
										if (response.DCType == langtext[0].Recordatorio){
											if (response.status == "3" || response.status == "-4")
												status0style="opaque:0.5;background-image: url('assets/sello/listo.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
											if (response.status == "6" || response.status == "-7")
												status0style="opaque:0.5;background-image: url('assets/sello/borrada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
										}
										else{
											if (response.DCType == langtext[0].Cita) {
												if (response.status == "3" || response.status == "-4")
													status0style="opaque:0.5;background-image: url('assets/sello/lista.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
												if (response.status == "5" || response.status == "-6")
													status0style="opaque:0.5;background-image: url('assets/sello/anulada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
												if (response.status == "6" || response.status == "-7")
													status0style="background-image: url('assets/sello/borrada.png');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";
											}
											else{
												//cualquier sello en la estructura del dataclip
												if (response.status != "0") {
													if (response.status < 0) 
														response.status=(response.status+1)*-1;
													if (response.SelloImage!='')
														status0style="background-image: url('assets/sello/" +response.SelloImage + "');background-repeat: no-repeat;background-position: 95% 25%; opacity:1;";							
												}
											}
										}
									}
									if (response.OriginalDC!="") {
										if (status0style != "")
											status0style = status0style + ";";
										status0style=status0style+ " background-color: lightyellow ";
										document.getElementById('PostModuleContent').style.backgroundColor = "lightyellow";
									}
									else
										document.getElementById('PostModuleContent').style.backgroundColor = "white";
									
									if (response.filepath==''  && response.OriginalDC=="")
										response.filepath='empty.png';
									if (response.filepath==''  && response.OriginalDC!="")
										response.filepath='emptycopy.png';
									document.getElementById('DcContent').style=status0style;
									app.$refs.DcDets.dcobj=response;
									app.$refs.DcDets.$forceUpdate();
									if (app.$refs.DcDets.dcobj.repciId==undefined || app.$refs.DcDets.dcobj.repciId== '' || app.$refs.DcDets.dcobj.repciId==0)
										alert(langtext[0].cantLoadDataClip2+dcId);
									app.$refs.DcDets.dcobj.tuplas.forEach(function(item){
										item.value2=linkify(item.value2);
									});
									resolve(app.$refs.DcDets.dcobj);
								}, function(error){
									alert(error.statusText);
									reject(error);
								});
							});
						},
						CargaCarpeta:function (DcId){
							app.$refs.RexSelected.getRexData(parseInt(DcId));
						},
						DetectDCLink: function (Ctext){
							var CCtext='';
							CCtext = Ctext;
							var DcPos = CCtext.indexOf("dc(");
							var Cierre = 0;
							var Numero = 0;
							var DcParams = '';
							var ComaSep = 0;
							var DcId = '';
							var RexId= '';
							if (DcPos>0) {
								Cierre = CCtext.indexOf(")",DcPos);
								if (Cierre > 0) {
									DcParams = Ctext.substring(DcPos + 3,Cierre);
									ComaSep = DcParams.indexOf(",");
									if (ComaSep > 0) {
										DcId = DcParams.slice(0,ComaSep);
										RexId = DcParams.slice(ComaSep+1);
										CCtext = "<span>" + CCtext.slice(0,DcPos) + "<i class='fa fa-list-alt' onclick='ShowDCinGridById(" + DcId + "," + RexId + ")'> </i>" + CCtext.slice(Cierre+1) + "</span>";
										//DcPos=InStr(CCtext,"dc(")
									}
									else
										CCtext = "<span>" + CCtext.slice(0,DcPos-1) + CCtext.slice(Cierre+1) + "</span>";
									
								}
								else
									DcPos = 0;
								
							}
							
							return CCtext;
						},
						CleanTemplate:function (){
							this.dcobj= {
									"id":0,
									"repciId" : "",
									"fromUser" : "",
									"when_date" : "",
									"DCType": "",
									"titulo": "",
									"longitud": 0,
									"latitud": 0,
									"status": 0,
									"PrevDc": "",
									"NextDC": "",
									"filepath": "",
									"comment": "",
									"IP":"",
									"titulo":"",
									"SelloImage":"",
									"LocationOrigin":"",
									"tuplas":[]
								};
								app.$refs.DcDets.$forceUpdate();
						},
						ShowMultLines:function(MlTd){
							var dummy=null;
							dummy=MlTd.replace(/\/\/n/g,'<br>');
							return dummy;
						}
							
						
					
					},
					mounted:function () {
						var srcId = this.$el.getElementsByClassName("slot-wrapper")[0].innerHTML;
						if (srcId!=null && srcId!=''){
							this.getDcData(srcId);
						}
					}
				},
				'rex_editor':{
					template: '#rex_ed',
					data: 
						function (){
							return {
								ActiveDC:null,
								rexobj:{
									repciId : '',
									when_date : null,
									picon: '',
									titulo: '',
									creator: '',
									pict: '',
									ricon: '',
									aicon: '',
									grupo: '',
									name: '',
									Dcs: []								},
							};
						},
					methods:{
						getRexData: function(id){
							link='api/dossier.php/repcis/'+id;
							this.$http.get(link).then(function(response){
								var dummystr = response.data[0];
								//dummystr=dummystr.replace(/'/g,'"');
								var RexObj = dummystr;//JSON.parse(dummystr);
								this.rexobj = RexObj;
								//app.grupochartselected = RexObj.grupo;
								//app.gruposelected = RexObj.grupo;
								
								if (this.rexobj.Images[0]!="")
									this.rexobj.picfiles=this.rexobj.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.
								this.rexobj.pict = 'api/thumb.asp?path='+RexObj.picfiles[0];
								this.rexobj.ricon = 'ricons/'+ RexObj.grupo +'.png';
								this.rexobj.aicon = 'aicons/user-'+RexObj.creator+'.jpg';
								this.rexobj.picon = 'assets/pinon32.png';
								this.$http.get("grupos/" + this.rexobj.grupo + ".json").then (function(response){
									this.$root.GrupoJson = response;
									this.rexobj.nombreGrupo = this.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
									this.$root.DataClips = this.$root.GrupoJson.data.logs[this.rexobj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
									app.$refs.ModalRex.rexobj=SecurityDCFilter(app.$refs.ModalRex.rexobj,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
									app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
									if (!app.$root.DataClips){
										app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
										alert(langtext[0].errorStructTransferLocalSecText);
										return (false);
									}
									document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
									//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
									this.rexobj.Dcs=ReText(this.rexobj.Dcs);
								}, function(error){
									this.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
									alert(langtext[0].errorStructTransferRemoteText);
								});
								setTimeout(function () {	
									InitEditor();
								}, 500);
								}, function(error){
								console.log(error.statusText);
							});
						},
						setRexData: function(rexObj){
							this.rexobj = rexObj;
						},
						ShowDC : function(Dcid){ // verificar en ShowDC que este id sea de ese rex
							$('#FotoSlides').css('display','none');
							$('#DcSlides').css('display','block');
							this.ActiveDC=Dcid;
							SetToolBoxDataClips();
							document.getElementById('DataClipFrame').src = "api/DCFrameV2.asp?usr="+this.userid+"&dcId="+Dcid;							
						},
						EditDC: async function(RexId,DCId){
							if (RexId<0){
								var dummy = await CheckSyncRexId(RexId);
								if (dummy)
									return;
								
							// Falta leer el dc de indexedDB
								var dbdc = null;
								if (DCId)
									dbdc =  await db.DataClips.get(-DCId);
								if (!dbdc){	
									alert(dcid + ' Not in db');
									return;
								}
								
								dbdc.tuplas = [];
								await db.Tuplas.where('idDC').equals(DCId).each(function (Tp){
														var tupla = {"value1":Tp.value1,"value2":Tp.value2};
														dbdc.tuplas.push(tupla);															
														});								
								
								var DCType = dbdc.DCType;
								
								var Rex = await db.rexs.get(-RexId);
								
								this.LoadDataClipStruct(Rex.grupo,DCType).then(async function(DCStruct) {								
									var DCArray = DCStruct;//app.$root.DataClips;
									var DCOffset = -1;
									for (var xx=0;xx<DCArray.length;xx++){
										if (DCType.toUpperCase()==DCArray[xx].Code.toUpperCase()){
											DCOffset=xx;
											break;										
										}
									}
									NoBorrarImagen();
									if (DCOffset==-1){
										alert(langtext[0].cantEditClipText);
										return;
									}
									else{
										await app.LoadDC(DCOffset);
										document.getElementById('Editando').style.display='block';
										if (RexId==0)									
											document.getElementById('DataClipRexId').value= app.$refs.ModalRex.rexobj.repciId;									
										else
											document.getElementById('DataClipRexId').value= RexId;
										document.getElementById('DCWebId').value=-dbdc.id;
										var path=dbdc.filename;
										if (path==undefined)
											path='';
										if (path != ''){									
											var Image=document.getElementById('DCImage');
											var ImageSource=document.getElementById('ImgSource');
											if (dbdc.base64img!=''){
												Image.src=dbdc.base64img;
												var dumb=dbdc.filename.slice(-7);										
												ImageSource.value=dumb.substr(0,3);		
											}
											else
												Image.src="api/thumb.asp?path="+path;									
											Image.style.display="block";
											PermiteBorrarImagen();
										}
										var Domcontainer = document.getElementById("DCContainer");
										//Convertir las tuplas a {value1:value2, nextvalue:next value2}
										var ArrayTuplas=[];
										for (var yy=0;yy<dbdc.tuplas.length;yy++){
											 if (ArrayTuplas[dbdc.tuplas[yy].value1]==undefined)
												ArrayTuplas[dbdc.tuplas[yy].value1] = [dbdc.tuplas[yy].value2];
											 else
												ArrayTuplas[dbdc.tuplas[yy].value1].push(dbdc.tuplas[yy].value2);
										}
										ArrayToDom(ArrayTuplas,Domcontainer);
									}
								})
								return;
							}
							if (DCId==0){
								link='api/dcs-V2.php/'+ this.ActiveDC;
							}
							else{
								link='api/dcs-V2.php/'+DCId;
							}		
							this.$http.get(link).then(function(response){
								var DC = response.data;
								var DCType = DC.DCType;
								var path = DC.filepath;
								
								var grupo=DC.grupo; // pendiente 22/5/2020 por ver si esta bien
								
								this.LoadDataClipStruct(grupo,DCType).then(async function(DCStruct){
									var DCArray = DCStruct;//app.$root.DataClips;
									var DCOffset = -1;
									for (var xx=0;xx<DCArray.length;xx++){
										if (DCType.toUpperCase()==DCArray[xx].Code.toUpperCase()){
											DCOffset=xx;
											break;										
										}
									}
									if (DCOffset==-1){
										alert(langtext[0].cantEditClipText);
									}
									else{
										await app.LoadDC(DCOffset);
										document.getElementById('Editando').style.display='block';
										if (RexId==0)									
											document.getElementById('DataClipRexId').value= app.$refs.ModalRex.rexobj.repciId;									
										else
											document.getElementById('DataClipRexId').value= RexId;
										document.getElementById('DCWebId').value=DC.id;
										document.getElementById('DeleteImagefromDC').style.display="none";
										DeleteImagefromDC();
										document.getElementById('PdfFileName').value='';
										if (path != ''){
											if (path.substr(-4)=='.pdf'){
												var ulrPdf='DCImages/'+path;
												document.getElementById('PdfFileName').value=path;
												if (pdfjsLib==null){
													pdfjsLib = window['pdfjs-dist/build/pdf'];
													pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
												}												
												document.getElementById('prevPdfPage').addEventListener('click', onPrevPdfPage);
												document.getElementById('nextPdfPage').addEventListener('click', onNextPdfPage);
												initPdfCanvas();
												PdfCanvas = document.getElementById('Pdf-canvas');
												PDfCtx = PdfCanvas.getContext('2d');
												RecyclePdf();												
												ShowPdf();
												pdfjsLib.getDocument(ulrPdf).promise.then(function(pdfDoc_) {
												  pdfDoc = pdfDoc_;
												  document.getElementById('Pdf_page_count').textContent = pdfDoc.numPages;
												  PdfPageNum = 1;
												  if (pdfDoc.numPages==1)
													document.getElementById('PdfButtons').style.display='none';
												else
													document.getElementById('PdfButtons').style.display='block';
												// Initial/first page rendering
												  renderPage(PdfPageNum);
												});
											}
											else{
												var Image=document.getElementById('DCImage');												
												Image.src="api/thumb.asp?path="+path;
												Image.style.display="block";
											}
											var ImageSource=document.getElementById('ImgSource');
											ImageSource.value='FDC';
											if (path.substr(-4)=='.pdf'){
												ImageSource.value='FDC-PDF';
											}											
											PermiteBorrarImagen();											
										}
										var Domcontainer = document.getElementById("DCContainer");
										//Convertir las tuplas a {value1:value2, nextvalue:next value2}
										var JsonTuplas = {};
										var strobj='[{';
										var ArrayTuplas=[];
										for (var yy=0;yy<DC.tuplas.length;yy++){
											 if (ArrayTuplas[DC.tuplas[yy].value1]==undefined)
												ArrayTuplas[DC.tuplas[yy].value1] = [DC.tuplas[yy].value2];
											 else
												ArrayTuplas[DC.tuplas[yy].value1].push(DC.tuplas[yy].value2);
										}
										ArrayToDom(ArrayTuplas,Domcontainer);
										BlockUnique(Domcontainer); // como est� editando no debe cambiar el campo que tiene atributo unique
									}
								})
							}, function(error){
								console.log(error.statusText);
							});
						},
						PushDC : function(Dcid,Desc){
							this.rexobj.Dcs.push({'id':Dcid,'text':Desc});
							this.ShowDC(Dcid);
						},
						CurrentSlide: function(index){
							currentSlide(index +1);
						},
						 hideModal: function(){
							document.getElementById('ModalRexEditor').style.display='none';
							//app.showBusqueda();
						  },
						  
						 LoadDataClipStruct: function (grupo,DC){
							// hazlo siempre, este o no este ya en memoria, vuelve a leerlo por el no show. si se acaba de leer el cache debe minimizar todo
							//if (jQuery.isEmptyObject(app.$root.GrupoJson) || app.$root.GrupoJson.data.id!= grupo){
								return new Promise((resolve, reject) => {
									app.$refs.RexSelected.$http.get("grupos/" + grupo + ".json").then (function(response){
										app.$root.GrupoJson = response;
										app.$refs.RexSelected.rexobj.nombreGrupo = app.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
										var TipoDataClipLogs=app.$root.GrupoJson.data.logs;
										for (var xx=0;xx<TipoDataClipLogs.length;xx++){
											var DataC = TipoDataClipLogs[xx];
											for (var yy=0;yy<DataC.DCs.length;yy++){
												if (DataC.DCs[yy].Code.toUpperCase()==DC.toUpperCase()){
													app.$root.DataClips=[];
													app.$root.DataClips.push(DataC.DCs[yy]);											
												if (app.$root.DataClips[0].tituloDossier!=undefined)
													document.getElementById('retHeadTituloDossier').value = app.$root.DataClips[0].tituloDossier;
												else
													document.getElementById('retHeadTituloDossier').value = '';
												/*if (app.$root.DataClips[0].tituloDC!=undefined)
													document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
												else
													document.getElementById('retHeadTituloDC').value = '';*/
												if (app.$refs.RexSelected.Dcs)
													app.$refs.RexSelected.Dcs=ReText(app.$refs.RexSelected.Dcs);
												}
											}
										}
										app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
										resolve(app.$root.DataClips);
										
									}, function(error){
										app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
										reject(error);
										//alert('Error');
									});
								})
							//}
							/*else{
								return new Promise((resolve, reject) => {
									
									app.$refs.RexSelected.rexobj.nombreGrupo = app.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
									var TipoDataClipLogs=app.$root.GrupoJson.data.logs;
									for (var xx=0;xx<TipoDataClipLogs.length;xx++){
										var DataC = TipoDataClipLogs[xx];
										for (var yy=0;yy<DataC.DCs.length;yy++){
											if (DataC.DCs[yy].Code.toUpperCase()==DC.toUpperCase()){
												app.$root.DataClips=[];
												app.$root.DataClips.push(DataC.DCs[yy]);
												if (app.$root.DataClips[0].tituloDossier!=undefined)
													document.getElementById('retHeadTituloDossier').value = app.$root.DataClips[0].tituloDossier;
												else
													document.getElementById('retHeadTituloDossier').value = '';
												if (app.$root.DataClips[0].tituloDC!=undefined)
													document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
												else
													document.getElementById('retHeadTituloDC').value = '';
												if (app.$refs.RexSelected.rexobj.Dcs)
													app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs);
											}
										}
									}
								app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
								resolve(app.$root.DataClips);	
								})
							}*/
						}
					},
					mounted:function () {
					  var srcId = this.$el.getElementsByClassName("slot-wrapper")[0].innerHTML;
		
					  if (srcId!=null && srcId!=''){
						this.getRexData(srcId);
					  }
					}        			
				}
			},
			data:{
				Desc:'',
				rexs: [],
				CantRexs:0,
                CantMarkersDragged:0,
				CantMarkers:0,
				users : [],
				chartusers : [],
				usersX : [],
				grupos : [],
				gruposChart: [],
				ShowGrupo : [],
				GrupoCounter:[],
				GrupoPerfil:[],
				Tareas: [],
				Recordatorios: [],
				Citas: [],
				Vencimientos: [],
				CantNoSyncs:0,
				//iconosgrupo: [],
				gruposelected: 0,
				grupochartselected: 0,
				nombreGrupo:'',
				enTitulo: '',
				usuarioselected: 'T',
				statusselected:1,
				usuarioschartselected: 'T',
				timeselected: '0',
				RexSelected: null,
				TituloSelected: '',
				UserName: '',
				TextoChart: '',
				userid:GetParameter('u'),
				token:'',
				GrupoJson:{},
				ChartJson:{},
				Carpetas:[],
				CarpetaSeleccionada:"T",
				ChartDCSeleccionado:"T",
				ChartFieldSeleccionado:"T",
				ChartDcs:[],
				CamposDcs:[],
				sellochartselected:0,
				selchartstatus:"1",
				sellos:[],
				logs:[],
				DataClips:[],
				dateFormat: 'D MMM',
				inputDateOne: '',
				inputDateTwo: '',
				buttonDateOne: new Date(),
				buttonDateTwo: '',
				buttonChartDateOne: new Date(),
				buttonChartDateTwo: '',
				inlineDateOne: '',
				sundayDateOne: '',
				sundayFirst: false,
				alignRight: false,
				trigger: false,
				busquedaColapsada:false,
				DetallesColapsados:true,
				DetallesChartColapsados:false,
				RexsColapsados:false,
				ChartColapsado:true,
				TipoGrafico:1,
				DashBoard1:1,
				DashBoard2:2,
				TipoChart:'Bar',
				TipoChart1:'Bar',
				TipoChart2:'Pie',
				SelectedDC:'',
				currentLongitud:0.0,
				currentLatitud:0.0,
				currentIP:'',
				currentGPSOrigin:'',
				Tuplas:[],
				showCols:[],
				SellosDisponibles:[],
				JWT:'',
				CurrentRexStatus:0,
				RexStatus:0,
				CurrentTitle:''
			},
			methods:{
				loginRex: function(luser,lpwd){
					fetch('api/authen.php', {
								  method: 'POST',
								  headers: {
									'Accept': 'application/json, text/plain, */*',
									'Content-Type': 'application/json'
								  }
								  ,body: JSON.stringify({"userid":luser,"pwd":lpwd})
								}).then (response => {
					  return response.json();
					}).then(token => {
					  if (token.type=='error'){
						alert(langtext[0].authProblems+token.msg)
						return;
					  }
					  if (token.type=='token'){
						  this.JWT=token.jwt;
						  this.userid=token.usuario;
						  this.logginIn();
						  document.getElementById('splashscreen').style.opacity="0";
						  setTimeout(function () {	// dale tiempo para que lea todo
							document.getElementById('splashscreen').style.display='none';
							ShowCalendario();
							}, 1000);
					}
					}).catch (function(){alert('No autorizado');}); 					
				},
				formateaFecha: function(TT) {
					var options = {
						year: "numeric", month: "short",
						day: "numeric", hour: "numeric", minute: "2-digit"
					};

					var d = new Date(TT.substring(0, 4), TT.substring(4, 6)-1, TT.substring(6, 8), TT.substring(9, 11), TT.substring(11, 13), TT.substring(13, 15), 0);
					var n = d.toLocaleString("sp-ve", options);
					return(n);
				},
				DameFecha: function(TT) {
					var d = new Date(TT.substring(0, 4), TT.substring(4, 6)-1, TT.substring(6, 8), TT.substring(9, 11), TT.substring(11, 13), TT.substring(13, 15), 0);
					return(d);
				},
				showRexDC : function(repciId,idDC){
						app.$refs.ModalRex.getRexData(repciId);
						if (idDC!=0)
							setTimeout(function () {	
										var r=app.$refs.ModalRex.rexobj;
										app.seleccionRex(r);					
										app.$refs.ModalRex.ShowDC(idDC);										
									}, 2000);
				},				
				TraeRexs: function(Option){
					$('#anigif').css('visibility', 'visible');
					$('#rexarr').css('visibility', 'visible');
					var ahora = new Date();
					var enTit = this.enTitulo; //document.getElementById("enTitulo").value;
					var enRango = this.timeselected; //document.all.selrango.options[document.all.selrango.selectedIndex].value
					var conUsuario = this.usuarioselected; //document.all.selequipo.options[document.all.selequipo.selectedIndex].value
					var grupoSelected = this.gruposelected;
					var statusSelected = this.statusselected;
					if (!conUsuario)
						conUsuario='T';		
					if (!enTit)
						enTit='';
					if (!enRango)
						enRango = "0";
					if (!grupoSelected)
						grupoSelected = "0";
					hideKeyboard();//es para esconder el teclado cuando estas usando en un celular y no ocupe la mitad de la pantalla sin necesidad
					var link = "api/traerexsML.asp?usr=" + this.userid+ "&grp=" + grupoSelected + "&d1=" + this.buttonDateOne + "&d2=" + this.buttonDateTwo + "&ted=" + enTit + "&u=" + conUsuario + "&bx=" + Option + "&s=" + statusSelected;
					this.$http.get(link).then(function(response) {
						this.rexs = response.data;
						this.RexSelected=null;
						rexarray=this.rexs;
						this.CantRexs=rexarray.length;
						$("#rexarr").animate({scrollTop: 0}, 0);
						var gruposelected = this.gruposelected;
						
						setTimeout(function () {
							grid.refreshItems().layout();
						}, 500);
						
						$('#anigif').css('visibility', 'hidden');
						this.CountGroupByGrupo();
						this.RexsColapsados=false; // para que se muestren los rexs traidos
					
					},
					function() {
						alert(langtext[0].errorRetreivingDossierText);
						$('#anigif').css('visibility', 'hidden');
					});	
					
				},
				TraeNoSyncs: function(){
					$('#anigif').css('visibility', 'visible');
					$('#rexarr').css('visibility', 'visible');
					try{
						db.rexs.where("repciId").equals("").reverse().toArray(function (RexArray) {
							app.rexs = RexArray;
							app.CountGroupByGrupo();
						}).catch(function (error) {
							console.log(error);
							app.rexs = [];
							app.CountGroupByGrupo();
						});						
					}
					catch(e){}
					document.getElementById('synclogo').classList.remove("fa-spin");
					document.getElementById('synclogo').style.color="black";
					document.getElementById('uploadrexs').style.display='';
					$('#anigif').css('visibility', 'hidden');
				},
				LoadRexByDCtoEditorAndMuuri:function(DcId){
					link='api/dossier.php/DC/'+DcId;
					this.$http.get(link).then(function(response){
						var dummystr = response.data[0];
						//dummystr=dummystr.replace(/'/g,'"');
						var RexObj = dummystr;//JSON.parse(dummystr);
						if (RexObj.Images[0]!="")
							RexObj.picfiles=RexObj.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.
						RexObj.pict = 'api/thumb.asp?path='+RexObj.picfiles[0];
							RexObj.ricon = 'ricons/'+ RexObj.grupo +'.png';
						RexObj.aicon = 'aicons/user-'+RexObj.creator+'.jpg';
						RexObj.picon = 'assets/pinon32.png';
						if (jQuery.isEmptyObject(this.$root.GrupoJson) || this.$root.GrupoJson.id!= RexObj.grupo){
							this.$http.get("grupos/" + RexObj.grupo + ".json").then (function(response){
								this.$root.GrupoJson = response;
								RexObj.nombreGrupo = this.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
								this.$root.DataClips = this.$root.GrupoJson.data.logs[RexObj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
								app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
								if (!app.$root.DataClips){
									app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
									alert(langtext[0].errorStructTransferLocalSecText);
									return (false);
								}
								document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
								//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
								RexObj.Dcs=ReText(RexObj.Dcs);
							}, function(error){
								RexObj.nombreGrupo = this.$root.GrupoJson.data.name;
								alert(langtext[0].errorLoadingDC2DeskText);
							});
						}
						else{
							RexObj.nombreGrupo = this.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
							this.$root.DataClips = this.$root.GrupoJson.data.logs[RexObj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
							app.$root.DataClips=SecurityDCFilterList(app.$root.DataClips,app.$root.GrupoJson,parseJwt(app.JWT).perfiles);
							if (!app.$root.DataClips){
								app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
								alert(langtext[0].errorStructTransferLocalSecText);
								return (false);
							}
							document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
							//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
							RexObj.Dcs=ReText(RexObj.Dcs);							
						}
						setTimeout(function () {
							app.seleccionRex(RexObj);
							//app.$refs.RexSelected.setRexData(RexObj);
							//app.$refs.ModalRex.setRexData(RexObj);
							//addRex(app.$refs.RexSelected);
							//app.$refs.ModalRex.ShowDC(DcId);							
						}, 500);
					}, function(error){
						console.log(error.statusText);
					});				
				},
				gruposdadouser:function(loggeduser){
					return new Promise((resolve, reject) => {
						link='api/gruposdadouser.asp?usr='+loggeduser;					
						this.$http.get(link).then(function(response){
						this.grupos = response.data;
						resolve(true);
						}, function(error){
							console.log(error.statusText);
							reject(error);
						});
					});
				},
				TareasDadoUser: function(loggeduser){
					link='api/fetchTareasML.php?t=1234&u='+loggeduser;				
					this.$http.get(link).then(function(response){
					this.Tareas = response.data;
					}, function(error){
						console.log(langtext[0].Tareas+":"+error.statusText);
					});				
				},
				RecordatoriosDadoUser: function(loggeduser){
					link='api/fetchRecordatoriosML.php?t=1234&u='+loggeduser+'&end='+dateFns.format(new Date,"YYYY-MM-DD");				
					this.$http.get(link).then(function(response){
					this.Recordatorios = response.data;
					}, function(error){
						console.log(langtext[0].Recordatorios+':'+error.statusText);
					});				
				},
				CitasDadoUser: function(loggeduser){
					link='api/fetchCitasML.php?t=1234&u='+loggeduser+'&end='+dateFns.format(new Date,"YYYY-MM-DD");				
					this.$http.get(link).then(function(response){
					this.Citas = response.data;
					}, function(error){
						console.log(langtext[0].Citas+':'+error.statusText);
					});				
				},
				VencimientosDadoUser: function(loggeduser){
					link='api/fetchVencimientos.php?t=1234&u='+loggeduser+'&end='+dateFns.format(new Date,"YYYY-MM-DD");				
					this.$http.get(link).then(function(response){
					this.Vencimientos = response.data;
					}, function(error){
						console.log(langtext[0].Vencimientos+':'+error.statusText);
					});				
				},
				gruposel: function (){
					var gruposelected = this.gruposelected;
					this.nombreGrupo = $( "#selgrupo option:selected" ).text();
					this.$http.get("grupos/" + gruposelected + ".json").then (function(response){
						this.GrupoJson = response;
						this.DataClips = this.GrupoJson.data.logs[0].DCs; //this.GrupoJson.data.logs[0].Dcs;
						this.DataClips=SecurityDCFilterList(this.DataClips,this.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorStructTransferLocalSecText);
							return (false);
						}
						document.getElementById('retHeadTituloDossier').value = this.DataClips[0].tituloDossier;
						/*if (app.$root.DataClips[0].tituloDC!=undefined)
							document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
						else
							document.getElementById('retHeadTituloDC').value = '';*/
						this.loadusers();
					}, function(error){
						alert(langtext[0].errorReadingGrupoText);
					});
				},
				grupochartsel: function (){
					var gruposelected = this.grupochartselected;
					this.CarpetaSeleccionada='T';
					////////////////////////					
					if (jQuery.isEmptyObject(app.$root.GrupoJson) || app.$root.GrupoJson.id!= gruposelected){
						app.$http.get("grupos/" + gruposelected + ".json").then (function(response){
							app.$root.GrupoJson = response;
							this.ChartJson = response;
							this.Carpetas = this.ChartJson.data.logs;
							this.ChartDcs = [];
							//this.ChartDCSeleccionado="T";
							this.CamposDcs=[];
							this.showCols=[];
							this.sellos=[];
							this.CarpetaSeleccionada=0;					
							this.LoadChartDCs();						
						//this.DataClips = this.ChartJson.data.logs[0].DCs; //this.GrupoJson.data.logs[0].Dcs;
						this.loadchartusers();
						}, function(error){
							alert(langtext[0].errorSelGrupoChartText);
							this.CamposDcs=[];
							this.showCols=[];
						});
					}					
					/////////////////////////					
					/*this.$http.get("grupos/" + gruposelected + ".json").then (function(response){
						this.ChartJson = response;
						this.Carpetas = this.ChartJson.data.logs;
						this.ChartDcs = [];
						//this.ChartDCSeleccionado="T";
						this.CamposDcs=[];
						this.showCols=[];
						this.sellos=[];
						this.CarpetaSeleccionada=0;					
						this.LoadChartDCs();
						
						//this.DataClips = this.ChartJson.data.logs[0].DCs; //this.GrupoJson.data.logs[0].Dcs;
						this.loadchartusers();
					}, function(error){
						alert('Error al seleccionar la estructura del grupo Json en el tipo de grafico a mostrar');
						this.CamposDcs=[];
						this.showCols=[];
					});*/
					//this.CarpetaSeleccionada='T';
					
				},
				resizechart: function(){
					var ChartItem = document.getElementById('ChartItem');
					var ChartWindowHeight = ChartItem.offsetHeight;
					var Chart_Div = document.getElementById('chart_div');
					var ChartDetails = document.getElementById('ChartDetails');
					if (this.DetallesChartColapsados){
						//ChartDetails.style.resize="";
						ChartDetails.style.minHeight ="";
						ChartDetails.style.height="60px";
						Chart_Div.style.height=(ChartWindowHeight-60-25-26)+'px';
					}
					else{
						//ChartDetails.style.resize="both";
						//ChartItem.style.maxHeight="none";
						ChartDetails.style.minHeight ="350px";
						ChartDetails.style.height=ChartWindowHeight+"px";
					}
				},
				LoadChartDCs:function(){
					//var CarpetaSelec = this.CarpetaSeleccionada;
					if (this.Carpetas && this.Carpetas[this.CarpetaSeleccionada]){
						this.ChartDcs = this.Carpetas[this.CarpetaSeleccionada].DCs;					
						try{
							this.ChartDcs.push({"Code":this.ChartJson.data.Totales[0].DC,"Desc":this.ChartJson.data.Totales[0].DC,"DcStructure":[{"desc":this.ChartJson.data.Totales[0].rethead,"rethead":this.ChartJson.data.Totales[0].rethead,"type":"Num"}]});
						}catch(e){}
						this.ChartDCSeleccionado=this.ChartDcs[0].Code;			
						setTimeout(function () {
							app.LoadCamposDCs();
						}, 500);
					}
					else{
						this.ChartDcs = [];
					}
					//this.ChartDCSeleccionado="T";
					this.CamposDcs=[];
					this.showCols=[];
					this.sellos=[];
				},
				LoadCamposDCs:function(){
					var ChartDCSelec = this.ChartDCSeleccionado;
					this.CamposDcs=[];
					this.showCols=[];
					this.sellos=[];
					for (var xx=0;xx<this.ChartDcs.length;xx++){
						if (this.ChartDcs[xx].Code.toUpperCase()==ChartDCSelec.toUpperCase()){
							this.CamposDcs = Array.from(this.ChartDcs[xx].DcStructure);
							this.sellochartselected=0;
							if (this.ChartDcs[xx].Sellos){
								this.sellos = Array.from(this.ChartDcs[xx].Sellos);
							}
							else
								this.sellos=[];
							break;
						}
					}
					for (var yy=0;yy<this.CamposDcs.length;yy++){//agregar todos los campos de los RadioVC
						//if (this.CamposDcs[yy].type == 'Txt' || this.CamposDcs[yy].type == 'Edt' || this.CamposDcs[yy].type == 'EdtPR' || this.CamposDcs[yy].type == 'EdtML' || this.CamposDcs[yy].type == 'RIF'|| this.CamposDcs[yy].type == 'Email' || this.CamposDcs[yy].type == 'Telf' || this.CamposDcs[yy].type == 'Separator' || this.CamposDcs[yy].type == 'Table' || this.CamposDcs[yy].type == 'SrcTxt' || this.CamposDcs[yy].type == 'Date' || this.CamposDcs[yy].type == 'Time')
						if (this.CamposDcs[yy].type == 'RadioVC' ){
							var NuevosCampos=[];
							for (var zz=0; zz< this.CamposDcs[yy].value.length;zz++){
								NuevosCampos=NuevosCampos.concat(this.CamposDcs[yy].value[zz].DcStructure);								
							}
							this.CamposDcs=this.CamposDcs.concat(NuevosCampos);
						}
					}
					for (var yy=this.CamposDcs.length-1;yy>=0;yy--){
						//if (this.CamposDcs[yy].type == 'Txt' || this.CamposDcs[yy].type == 'Edt' || this.CamposDcs[yy].type == 'EdtPR' || this.CamposDcs[yy].type == 'EdtML' || this.CamposDcs[yy].type == 'RIF'|| this.CamposDcs[yy].type == 'Email' || this.CamposDcs[yy].type == 'Telf' || this.CamposDcs[yy].type == 'Separator' || this.CamposDcs[yy].type == 'Table' || this.CamposDcs[yy].type == 'SrcTxt' || this.CamposDcs[yy].type == 'Date' || this.CamposDcs[yy].type == 'Time')
						if (this.CamposDcs[yy].type == 'Txt' || this.CamposDcs[yy].type == 'Separator' || this.CamposDcs[yy].type == 'Table' || this.CamposDcs[yy].type == 'SrcTxt' )
							this.CamposDcs.splice(yy, 1);
					}
					if (this.CamposDcs.length>=1){
						this.CamposDcs.unshift( {
										"desc": langtext[0].Usuario,
										"rethead": langtext[0].Usuario_DC,
										"type": "Edt",
										"req": "false",
										"value": []
									});
						this.CamposDcs.unshift( {
										"desc": langtext[0].Hora,
										"rethead": langtext[0].Hora_DC,
										"type": "Time",
										"req": "false",
										"value": []
									});
									
						this.CamposDcs.unshift( {
										"desc": langtext[0].Fecha,
										"rethead": langtext[0].Fecha_DC,
										"type": "Date",
										"req": "false",
										"value": []
									});
						this.CamposDcs.unshift( {
										"desc": langtext[0].Titulo,
										"rethead": langtext[0].Titulo,
										"type": "Edt",
										"req": "false",
										"value": []
									});
					}
				},
				loadusers:function(){
					var gruposelected = this.gruposelected;
					this.$http.get("api/usersgrupo.asp?usr="+this.userid+"&grp=" + gruposelected).then (function(response) {
						this.users = response.data;
						this.usuarioselected="T";
						$("#busquedas").css("visibility","visible");
					})
					.error(function() {
						alert(langtext[0].errorGettingGrupoText);
					});					
				},
				loadchartusers:function(){
					var gruposelected = this.grupochartselected;
					this.$http.get("api/usersgrupo.asp?usr="+this.userid+"&grp=" + gruposelected).then (function(response) {
						this.chartusers = response.data;
						this.usuariochartselected = "T";
					})
					.error(function() {
						alert(langtext[0].errorGettingGrupoChartText);
					});					
				},
				loadusersdadogrupo:function(grp){
					return new Promise((resolve, reject) => {
						this.$http.get("api/usersgrupo.asp?usr="+this.userid+"&grp=" + grp).then (function(response) {
							this.usersX = response.data;
							resolve(this.usersX);
						})
						.error(function() {
							reject();
						})
					})						
				},
				showGrupo:function(key){
					Vue.set(app.ShowGrupo,key,!app.ShowGrupo[key]);
				},
				CountGroupByGrupo:function(){
					this.GrupoCounter=[];
					for (var xx=0;xx<this.rexs.length;xx++){
						var r=this.rexs[xx];
						if (this.GrupoCounter['G'+r.grupo]==undefined)
							this.GrupoCounter['G'+r.grupo]=0;
						this.GrupoCounter['G'+r.grupo]++;
					}
					Vue.set(app.GrupoCounter,'G'+r.grupo,app.GrupoCounter['G'+r.grupo]);
				},
				ColapsaTodosLosGrupos:function(){
					for(var xx=0;xx<this.grupos.length;xx++)
						if (this.ShowGrupo['G'+this.grupos[xx].grupo]!=true)
							this.showGrupo('G'+this.grupos[xx].grupo);
				},
				seleccionRex: function(r){
					try{
						infowindow.close();
					}
					catch(e){}
					if (r.id!=undefined)
						app.$refs.RexSelected.getRexData(-r.id);
					else
						app.$refs.RexSelected.getRexData(r.repciId);
					setTimeout(function () {						
							grid.refreshItems().layout();
							ShowCarpetasIfSize(600);
							CloseSideBarIfSize(600);
						}, 500);
					var Roffset = null;
					if (r.id!=undefined)
						Roffset = findMarkerOffset(-r.id);
					else
						Roffset = findMarkerOffset(r.repciId);
					var marker=null;
					try{
						var location = new google.maps.LatLng(r.latitud,r.longitud);	
					}catch(e){}
					if (Roffset !== null){
						try{
							marker=RexMarkerArray[Roffset];
						}catch(e){}
					}
					else{
						if (r.Images[0]!="")
							r.picfiles=r.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.								
						var image = 'ricons/' + r.grupo + ".png";					
						try{
							marker=addMarkerToRexMarkerArray(location,image,r);
						}catch(e){}
						}				
					try{
						if (initialZoomLevel > map.getZoom())
							map.setZoom(initialZoomLevel);// if the user is working very zoomed, don't bother him
						map.panTo(location); //Make map global
						JumpMarker(marker);
					}catch(e){}
					if (jQuery.isEmptyObject(this.GrupoJson) || r.grupo!=this.GrupoJson.id){
						this.$http.get("grupos/" + r.grupo + ".json").then (function(response){
							this.$root.GrupoJson = response;
							this.$root.DataClips = this.$root.GrupoJson.data.logs[r.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
							/*this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
							if (!this.$root.DataClips){
								app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
								alert('Error transfiriendo estructura del grupo actual localmente por seguridad');
								return (false);
							}			*/				
							document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
							/*if (app.$root.DataClips[0].tituloDC!=undefined)
								document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
							else
								document.getElementById('retHeadTituloDC').value = '';*/
							//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
							app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs); 
						}, function(error){
							this.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorGetGrupoRexText);
						});
					}
					else{
						this.$root.DataClips = this.GrupoJson.data.logs[r.notift].DCs; //this.logs[0].Dcs;
						/*this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.$root.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert('Error transfiriendo estructura del grupo actual localmente por seguridad');
							return (false);
						}*/
						document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;		
						/*if (app.$root.DataClips[0].tituloDC!=undefined)
							document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
						else
							document.getElementById('retHeadTituloDC').value = '';*/
						//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;		
						app.$refs.RexSelected.rexobj.Dcs=ReText(app.$refs.RexSelected.rexobj.Dcs); 
					}
					
					//ahora el calendario
					var fechaX=r.when_date + ' ';
					var fecha = fechaX.substring(0, 10);
					if (fechaX.indexOf("-")==-1){
						fecha=fechaX.substring(0, 4)+'-';
						fecha+=fechaX.substring(4, 6)+'-';
						fecha+=fechaX.substring(6, 8);
					}
					document.all.CalendarFrame.contentWindow.gotoDate(fecha);					
					if (r.id!=undefined)
						document.all.CalendarFrame.contentWindow.AddEvent(-r.id,fecha,r.titulo);
					else
						document.all.CalendarFrame.contentWindow.AddEvent(r.repciId,fecha,r.titulo);
					
				},
				LoadGrupoJson: function(NumGrupo){
					this.logs =[];
					document.getElementById('LoadingLogs').style.display='inline';
					if (jQuery.isEmptyObject(this.GrupoJson) || NumGrupo!=this.GrupoJson.id){
						this.$http.get("grupos/" + NumGrupo + ".json").then (function(response){
							this.$root.GrupoJson = response;
							this.logs = this.$root.GrupoJson.data.logs; 
							this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs; 
							this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
							if (!this.$root.DataClips){
								app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
								alert(langtext[0].errorStructTransferLocalSecText);
								return (false);
							}
							document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
							/*if (app.$root.DataClips[0].tituloDC!=undefined)
								document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
							else
								document.getElementById('retHeadTituloDC').value = '';*/
							//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
							document.getElementById('LoadingLogs').style.display='none';
							if (this.logs.length == 1){
								app.CreateDossierLoadDC(0);
							}
				
						}, function(error){
							alert(langtext[0].errorGetGrupoText);
							document.getElementById('LoadingLogs').style.display='none';
						});
					}
					else{
						this.logs = this.$root.GrupoJson.data.logs; 
						this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs; //this.logs[0].Dcs;
						this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.$root.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorStructTransferLocalSecText);
							return (false);
						}
						document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
						/*if (app.$root.DataClips[0].tituloDC!=undefined)
							document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
						else
							document.getElementById('retHeadTituloDC').value = '';*/
						//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
						document.getElementById('LoadingLogs').style.display='none';	
						if (this.logs.length == 1){
							app.CreateDossierLoadDC(0);
						}						
					}
				},
				SetGrupoJson: function(NumGrupo){
					this.logs =[];
					document.getElementById('LoadingLogs').style.display='inline';
					if (jQuery.isEmptyObject(this.GrupoJson) || NumGrupo!=this.GrupoJson.id){
						this.$http.get("grupos/" + NumGrupo + ".json").then (function(response){
							this.$root.GrupoJson = response;
							this.logs = this.$root.GrupoJson.data.logs; 
							this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs; 
							this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
							if (!this.$root.DataClips){
								app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
								alert(langtext[0].errorStructTransferLocalSecText);
								return (false);
							}
							document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
							document.getElementById('LoadingLogs').style.display='none';				
						}, function(error){
							alert(langtext[0].errorGetGrupoDefaultText);
							document.getElementById('LoadingLogs').style.display='none';
						});
					}
					else{
						this.logs = this.$root.GrupoJson.data.logs; 
						this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs; //this.logs[0].Dcs;
						this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.$root.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorStructTransferLocalSecText);
							return (false);
						}
						document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
						/*if (app.$root.DataClips[0].tituloDC!=undefined)
							document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
						else
							document.getElementById('retHeadTituloDC').value = '';*/
						//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
						document.getElementById('LoadingLogs').style.display='none';	
						if (this.logs.length == 1){
							app.CreateDossierLoadDC(0);
						}						
					}
				},
				LoadAllDcsGrupoJson: function(Grupo){
					if (jQuery.isEmptyObject(this.$root.GrupoJson) || this.$root.GrupoJson.data.id!= Grupo){
						this.$http.get("grupos/" + Grupo + ".json").then (function(response){
							this.$root.GrupoJson = response;
							this.logs = this.$root.GrupoJson.data.logs; 
							this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs;
							for(dd=this.$root.DataClips.length-1;dd>=0;dd--){
								if (this.$root.DataClips[dd].NoShow!=undefined && this.$root.DataClips[dd].NoShow=="true")
									this.$root.DataClips.splice(dd,1);	//remove no show element.	
							}
							//if (this.$root.DataClips[0].NoShow!=undefined && this.$root.DataClips[0].NoShow=="true")
							//	this.$root.DataClips.shift(); //remove first element. el que se usa solo en la creacion de la carpeta
							document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
							/*if (app.$root.DataClips[0].tituloDC!=undefined)
								document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
							else
								document.getElementById('retHeadTituloDC').value = '';*/
							//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
							document.getElementById('LoadingLogs').style.display='none';
							if (this.$root.DataClips.length==1){ // si solo hay un dataclip, levantalo de una vez
								app.LoadDC(0); 
							}
						}, function(error){
							alert(langtext[0].errorGetGrupo4DCs);
							document.getElementById('LoadingLogs').style.display='none';
						});
					}
					else{
						//this.rexobj.nombreGrupo = this.$root.GrupoJson.data.name;//$( "#selgrupo option:selected" ).text();
						//this.$root.DataClips = this.$root.GrupoJson.data.logs[this.rexobj.notift].DCs; //this.GrupoJson.data.logs[0].Dcs;
						this.$root.DataClips = this.$root.GrupoJson.data.logs[0].DCs; 
						
						for(dd=this.$root.DataClips.length-1;dd>=0;dd--){
							if (this.$root.DataClips[dd].NoShow!=undefined && this.$root.DataClips[dd].NoShow=="true")
								this.$root.DataClips.splice(dd,1);	//remove no show element.	
						}

						//if (this.$root.DataClips[0].NoShow!=undefined && this.$root.DataClips[0].NoShow=="true")
						//	this.$root.DataClips.shift(); //remove first element. el que se usa solo en la creacion de la carpeta
						this.$root.DataClips=SecurityDCFilterList(this.$root.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.$root.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorStructTransferLocalSecText);
							return (false);
						}
						document.getElementById('retHeadTituloDossier').value = this.$root.DataClips[0].tituloDossier;
						/*if (app.$root.DataClips[0].tituloDC!=undefined)
							document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
						else
							document.getElementById('retHeadTituloDC').value = '';*/
						//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[0].tituloDC;
						document.getElementById('LoadingLogs').style.display='none';	
						if (this.$root.DataClips.length==1){ // si solo hay un dataclip, levantalo de una vez
							app.LoadDC(0); 
						}						
					}
				},
				CreateDossier: function(NumGrupo){
					document.getElementById('DataClipRexId').value=''; // se est� creando un Rex nuevo el RexId debe estar en ""
					this.LoadGrupoJson(NumGrupo);
					CloseSideBarIfSize(1290);
					document.getElementById('ModalTiposDossier').style.display='inline';					
				},
				CreateDossierLoadDC: function(index){
					 document.getElementById('DataClipRexId').value=''; // se est� creando un Rex nuevo el RexId debe estar en ""
					 this.DataClips = this.logs[index].DCs;
					 this.DataClips=SecurityDCFilterList(this.DataClips,this.$root.GrupoJson,parseJwt(app.JWT).perfiles);
						if (!this.DataClips){
							app.$refs.RexSelected.rexobj.nombreGrupo = $( "#selgrupo option:selected" ).text();
							alert(langtext[0].errorStructTransferLocalSecText);
							return (false);
						}
					 try{
						document.getElementById('retHeadTituloDossier').value = this.DataClips[0].tituloDossier;
					 }catch(e){
						document.getElementById('retHeadTituloDossier').value = ''; 
					 }
					 /*if (app.$root.DataClips[0].tituloDC!=undefined)
						document.getElementById('retHeadTituloDC').value = app.$root.DataClips[0].tituloDC;
					 else
						document.getElementById('retHeadTituloDC').value = '';*/
					 //document.getElementById('retHeadTituloDC').value = this.DataClips[0].tituloDC;
					 this.LoadDC(0);
					 if (this.DataClips[0].fotostart=='true'){
						initcamera();
					 }
					 document.getElementById('ModalTiposDossier').style.display='none'; 
					 app.$refs.ModalRex.rexobj.repciId=""; //para que se cree el Dossier y el DC enlazado de una vez
					 app.$refs.ModalRex.rexobj.grupo=this.GrupoJson.data.id;
					 app.$refs.ModalRex.rexobj.notift=this.logs[index].Id;
					 app.$refs.ModalRex.rexobj.repcitype="0";
					 this.logs=[];
					 
				 },
				loadSearchOnMap: function(){
					try{
						infowindow.close();
					}
					catch(e){}
					TimelyOperationStarts();
					for (var xx=0;xx<this.rexs.length;xx++){
						var r=this.rexs[xx];
						if (r.Images[0]!="")
							r.picfiles=r.Images;// transicion, cuando el movil sea puro javascript entonces solo sera Images.								
						var Roffset = findMarkerOffset(r.repciId);
						var marker=null;
						if (Roffset == null){
							var location = new google.maps.LatLng(r.latitud,r.longitud);	
							var image = 'ricons/' + r.grupo + "gray.png";						
							addMarkerToRexMarkerArray(location,image,r);
						}
					}
					markerCluster.fitMapToMarkers();
					//hideBusqueda();
					TimelyOperationEnds();		
				},
				randomNumber: function () {
				  this.random = Math.floor(Math.random() * 13);
				},
				formatDates: function(dateOne, dateTwo) {
					var formattedDates = ''
					if (dateOne) {
					  formattedDates = dateFns.format(dateOne, this.dateFormat)
					}
					if (dateTwo) {
					  formattedDates += ' - ' + dateFns.format(dateTwo, this.dateFormat)
					}
					return formattedDates
				  },
				  onClosed: function() {
					var datesStr = this.formatDates(this.inputDateOne, this.inputDateTwo)
					console.log('Dates Selected: ' + datesStr)
					this.trigger = false
				  },
				  onChartClosed: function() {
					var datesStr = this.formatDates(this.inputChartDateOne, this.inputChartDateTwo)
					console.log('Dates Selected: ' + datesStr)
					this.trigger = false
				  },
				  toggleAlign: function() {
					this.alignRight = !this.alignRight
				  },
				  triggerDatepicker: function() {
					this.trigger = !this.trigger
				  },
				  onMonthChange: function(dates) {
					console.log('months changed', dates)
				  },
				  
				  DrawChart : function(command){
				    document.getElementById('anigifChart').style.display='inline-block';
					var ahora = new Date();
					var enTit = this.TextoChart; 
					var enRango = this.formatDates(this.buttonChartDateOne, this.buttonChartDateTwo);
					var conUsuario = this.usuariochartselected; //document.all.selequipo.options[document.all.selequipo.selectedIndex].value
					var grupoSelected = this.grupochartselected;
					if (!enTit)
						enTit='';
					if (!enRango)
						enRango = "0";
					if (!grupoSelected)
						grupoSelected = "0";						
					var link = "api/"+command+"?usr=" + this.userid+ "&grp=" + grupoSelected + "&d1=" + this.buttonChartDateOne + "&d2=" + this.buttonChartDateTwo + "&ted=" + enTit + "&u=" + conUsuario;
					this.$http.get(link).then(function(response) {
						var data = new google.visualization.DataTable(response.data);
						if (!conUsuario)
							conUsuario='T';							
						if (conUsuario=='T')
							conUsuario=langtext[0].Todos;
						var sellosSelected = this.sellochartselected;
						var ChartStatusSelected = this.selchartstatus;
						if (!sellosSelected)
							sellosSelected = "0";
						var mm = 0;
						var selloFound=false;
						var SelloTitle='';
						for (mm=0;mm<this.sellos.length;mm++)
							if (this.sellos[mm].valor==this.sellochartselected){
								selloFound=true;
								break;
							}
						if (selloFound)
							SelloTitle=this.sellos[mm].desc;
						else
							SelloTitle='';
						var StatusDossierText='';
						switch (ChartStatusSelected){
							case "1":
								StatusDossierText=langtext[0].Activos;
								break;
							case "2":
								StatusDossierText=langtext[0].Historicos;
								break;
							case "3":
								StatusDossierText=langtext[0].ActivosHistoricos;
								break;
							default:
						}
						var options = {
						  title: $( "#Chartgrupo option:selected" ).text() +' ' + document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].text + '-' + enTit + ' - ' + enRango + ' (' + conUsuario + ') -' + SelloTitle + '-' + StatusDossierText,
						  legend: { position: 'none' },
						};
						var chart = null;
						
						switch (this.TipoChart){
							case 'Bar':
								chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
								break;
							case 'Pie':
								chart=new google.visualization.PieChart(document.getElementById('chart_div'));
								options = {
									  title: $( "#selgrupo option:selected" ).text() +' ' + document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].text + ' - ' + enTit + ' - ' + enRango + ' (' + conUsuario + ')',
									  is3D: true,
									};
								break;
							case 'Line':
								chart=new google.visualization.LineChart(document.getElementById('chart_div'));
								options = {
									  title: $( "#Chartgrupo option:selected" ).text() +' ' + document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].text + ' - ' + enTit + ' - ' + enRango + ' (' + conUsuario + ')',
									  curveType: 'function',
									  legend: { position: 'none' }
									};
								break;
							case 'Table':
								chart=new google.visualization.Table(document.getElementById('chart_div'));
								options={showRowNumber: true, width: '100%', height: '100%'};
								break;
							default:
								chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
								break;
						}
						chart.draw(data, options);
						document.getElementById('anigifChart').style.display='none';
						}
						,function() {
							alert(langtext[0].errorDrawSelChartText);
							document.getElementById('anigifChart').style.display='none';
							//$('#anigif').css('visibility', 'hidden');
						});
					},
				  showGrafico: function(){
					var top = $("#ChartItem").css("top")
					top=top.replace("px","");
					var ntop = parseInt(top)-10;
					if (ntop < 20){
						$("#ChartItem").css("top","100px")
					}
                                        
					var left = $("#ChartItem").css("left")
					left=left.replace("px","");
					var nleft = parseInt(left);
					if (nleft + 350 > $(window).width()){
                        nleft=$(window).width()-362
						$("#ChartItem").css("left",nleft+"px")
					}

					this.ChartColapsado=!this.ChartColapsado;
                    closeNav();
				  },
				  ReportePredeterminado:function(){
					var reporte=document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].value;
					if (reporte==1 || reporte==2){
						this.showCols=['Nombre', 'DescripTrabajo', 'Fecha_Deposito','Deposito','MontoPresupuestado','Abonado', 'Deuda'];
					}
					app.DetallesChartColapsados=true; //esconde los campos de busqueda del chart
					app.resizechart();										
					document.getElementById('anigifChart').style.display='inline';
					if (this.showCols.length>1){
						this.TipoChart='Table';
					}
					if (this.showCols.length>0){
						//body to sent
						var ahora = new Date();
						var enTit = 'Azotea';
						var enRango = this.formatDates(this.buttonChartDateOne, this.buttonChartDateTwo);
						var conUsuario = this.usuariochartselected; //document.all.selequipo.options[document.all.selequipo.selectedIndex].value
						var grupoSelected = this.grupochartselected;
												
						if (!enTit)
							enTit='';
						if (!enRango)
							enRango = "0";
						if (!grupoSelected)
							grupoSelected = "0";						
						
						var Body={"token":666123,
									"grupo":grupoSelected,
									"expediente":this.CarpetaSeleccionada,
									"DCType":this.ChartDCSeleccionado,
									"CamposDC":this.showCols,
									"d1":this.buttonChartDateOne,
									"d2":this.buttonChartDateTwo,
									"ted":enTit,
									"fromUser":conUsuario,
									"TipoChart":this.TipoChart
									};
						fetch('api/reporteazotea.php', {
								  method: 'POST',
								  headers: {
									'Accept': 'application/json, text/plain, */*',
									'Content-Type': 'application/json'
								  }
								  ,body: JSON.stringify(Body)
								})
								.then(res=>res.json())
										.then(res => {
														var poppit = false;
														if (this.showCols.length==1){
															poppit = true;
															this.showCols.push(langtext[0].Cantidad);
														}
														var data = new google.visualization.DataTable();
														for (xx=0;xx<this.showCols.length;xx++){
															//if (isNaN(this.showCols[xx]))
															if (this.showCols[xx]!=langtext[0].Cantidad)
																data.addColumn('string', this.showCols[xx]);
															else
																data.addColumn('number', this.showCols[xx]);
														}
														data.addRows(res);
														if (!conUsuario)
															conUsuario='T';							
														if (conUsuario=='T')
															conUsuario="Todos";
														var ChartTitle = $( "#Chartgrupo option:selected" ).text() +' ' + document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].text + '-' + enTit + ' - ' + enRango + ' (' + conUsuario + ')';
														if (this.showCols.length==2){
															ChartTitle = this.showCols[0]+ '-' + enTit + ' - ' + enRango + ' (' + conUsuario + ')';
														}
																																
														var options = {
														  title: ChartTitle,
														  legend: { position: 'none' }
															//'width':400,
															//'height':250
														};
														var chart = null;				
														switch (this.TipoChart){
															case 'Bar':
																chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
																document.getElementById('ChartButton').setAttribute("class", "fa fa-bar-chart-o w3-button w3-custom");
																break;
															case 'Pie':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-pie-chart w3-button w3-custom");
																chart=new google.visualization.PieChart(document.getElementById('chart_div'));
																options = {
																	  title: ChartTitle,
																	  is3D: true
																	  //'width':400,
																	  //'height':250
																	};
																break;
															case 'Line':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-line-chart w3-button w3-custom");
																chart=new google.visualization.LineChart(document.getElementById('chart_div'));
																options = {
																	  title: ChartTitle,
																	  curveType: 'function',
																	  legend: { position: 'none' },
																	  //'width':400,
																	  //'height':250
																	};
																break;
															case 'Table':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-table w3-button w3-custom");
																chart=new google.visualization.Table(document.getElementById('chart_div'));
																options={showRowNumber: true, width: '100%', height: '100%'};
																break;
															default:
																document.getElementById('ChartButton').setAttribute("class", "fa fa-bar-chart-o w3-button w3-custom");
																chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
																
																break;
														}
														if (poppit)
															this.showCols.pop();
														chart.draw(data, options);
														$('#ExportToCSV').css("display", "");
														$('#PrintChart').css("display", "");
														$('#PrintChart').click(function () {
															var chartdiv=document.getElementById('chart_div');
															printDiv(chartdiv);
														});
														$('#ExportToCSV').click(function () {
															var csvFormattedDataTable = google.visualization.dataTableToCsv(data);
															var headerRow = ""; 
															data.Ff.forEach(function (col,index) { 
																						headerRow += col.label; 
																						headerRow += (index == data.Ff.length-1) ? '\n' : ','; 
																					}); 
															csvFormattedDataTable = headerRow + csvFormattedDataTable;
															csvFormattedDataTable=csvFormattedDataTable.replace(/,/g, ";");
															
															//var encodedUri = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csvFormattedDataTable);							
															var encodedUri = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURIComponent(csvFormattedDataTable);
															this.href = encodedUri;
															this.download = 'DossierReport.csv';
															this.target = '_blank';
														});
														document.getElementById('chart_div').style.height="-webkit-fill-available";//Para que haga resize autom�tico
														document.getElementById('anigifChart').style.display='none';
														this.showCols=[];
													}
												).catch((err)=>{
													document.getElementById('anigifChart').style.display='none';
												});
									
								
					}
				  },
				  GraficoSelected: function(refresh){
					app.DetallesChartColapsados=true; //esconde los campos de busqueda del chart
					app.resizechart();										
					document.getElementById('anigifChart').style.display='inline';
					if (this.showCols.length>1){
						this.TipoChart='Table';
					}
					if (this.showCols.length>0){
						//body to sent
						var ahora = new Date();
						var enTit = this.TextoChart;
						var enRango = this.formatDates(this.buttonChartDateOne, this.buttonChartDateTwo);
						var conUsuario = this.usuariochartselected; //document.all.selequipo.options[document.all.selequipo.selectedIndex].value
						var grupoSelected = this.grupochartselected;
						var sellosSelected = this.sellochartselected;
						var ChartStatusSelected = this.selchartstatus;
												
						if (!enTit)
							enTit='';
						if (!enRango)
							enRango = "0";
						if (!grupoSelected)
							grupoSelected = "0";	
						if (!sellosSelected)
							sellosSelected = "0";	
							
						
						var Body={"token":666123,
									"grupo":grupoSelected,
									"expediente":this.CarpetaSeleccionada,
									"DCType":this.ChartDCSeleccionado,
									"Sello":sellosSelected,
									"DossierStatus":ChartStatusSelected,
									"CamposDC":this.showCols,
									"d1":this.buttonChartDateOne,
									"d2":this.buttonChartDateTwo,
									"ted":enTit,
									"fromUser":conUsuario,
									"TipoChart":this.TipoChart
									};
						if (refresh){ // llevalo a ahorita
							var Today = new Date();
							var Month = ("0" + (Today.getMonth() + 1)).slice(-2);
							var Day = ("0" + Today.getDate()).slice(-2);
							Body.d2 = Today.getFullYear() + "-" + Month + "-" + Day;
							enRango = this.formatDates(this.buttonChartDateOne, Body.d2);
							if (!enRango)
								enRango = "0";
						}
						fetch('api/reporte.php', {
								  method: 'POST',
								  headers: {
									'Accept': 'application/json, text/plain, */*',
									'Content-Type': 'application/json'
								  }
								  ,body: JSON.stringify(Body)
								})
								.then(res=>res.json())
										.then(res => {
														var poppit = false;
														if (this.showCols.length==1){
															poppit = true;
															this.showCols.push(langtext[0].Cantidad);
														}
														var data = new google.visualization.DataTable();
														for (xx=0;xx<this.showCols.length;xx++){
															//if (isNaN(this.showCols[xx]))
															if (this.showCols[xx]!=langtext[0].Cantidad)
																data.addColumn('string', this.showCols[xx]);
															else
																data.addColumn('number', this.showCols[xx]);
														}
														data.addRows(res);
														if (!conUsuario)
															conUsuario='T';							
														if (conUsuario=='T')
															conUsuario=langtext[0].Todos;
														var mm = 0;
														var selloFound=false;
														var SelloTitle='';
														for (mm=0;mm<this.sellos.length;mm++)
															if (this.sellos[mm].valor==this.sellochartselected){
																selloFound=true;
																break;
															}
														if (selloFound)
															SelloTitle=this.sellos[mm].desc;
														else
															SelloTitle='';
														var StatusDossierText='';
														switch (ChartStatusSelected){
															case "1":
																StatusDossierText=langtext[0].Activos;
																break;
															case "2":
																StatusDossierText=langtext[0].Historicos;
																break;
															case "3":
																StatusDossierText=langtext[0].ActivosHistoricos;
																break;
															default:
														}	
														var ChartTitle = $( "#Chartgrupo option:selected" ).text() +' ' + document.getElementById('TipoGrafico').options[document.getElementById('TipoGrafico').selectedIndex].text + '-' + SelloTitle +'-'+ enTit + ' - ' + enRango + ' (' + conUsuario + ') ' + '-' + StatusDossierText;
														if (this.showCols.length==2){
															ChartTitle = this.showCols[0]+ '-' + enTit + ' - ' +  SelloTitle + '-' + enRango + ' (' + conUsuario + ')' + '-' + StatusDossierText;
														}
																																
														var options = {
														  title: ChartTitle,
														  legend: { position: 'none' }
															//'width':400,
															//'height':250
														};
														var chart = null;				
														switch (this.TipoChart){
															case 'Bar':
																chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
																document.getElementById('ChartButton').setAttribute("class", "fa fa-bar-chart-o w3-button w3-custom");
																break;
															case 'Pie':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-pie-chart w3-button w3-custom");
																chart=new google.visualization.PieChart(document.getElementById('chart_div'));
																options = {
																	  title: ChartTitle,
																	  is3D: true
																	  //'width':400,
																	  //'height':250
																	};
																break;
															case 'Line':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-line-chart w3-button w3-custom");
																chart=new google.visualization.LineChart(document.getElementById('chart_div'));
																options = {
																	  title: ChartTitle,
																	  curveType: 'function',
																	  legend: { position: 'none' },
																	  //'width':400,
																	  //'height':250
																	};
																break;
															case 'Table':
																document.getElementById('ChartButton').setAttribute("class", "fa fa-table w3-button w3-custom");
																chart=new google.visualization.Table(document.getElementById('chart_div'));
																options={showRowNumber: true, width: '100%', height: '100%'};
																break;
															default:
																document.getElementById('ChartButton').setAttribute("class", "fa fa-bar-chart-o w3-button w3-custom");
																chart=new google.visualization.ColumnChart(document.getElementById('chart_div'));
																
																break;
														}
														if (poppit)
															this.showCols.pop();
														chart.draw(data, options);
														$('#ExportToCSV').css("display", "");
														$('#PrintChart').css("display", "");
														$('#PrintChart').click(function () {
															var chartdiv=document.getElementById('chart_div');
															printDiv(chartdiv);
														});
														$('#ExportToCSV').click(function () {
															var csvFormattedDataTable = google.visualization.dataTableToCsv(data);
															var headerRow = ""; 
															data.Ff.forEach(function (col,index) { 
																						headerRow += col.label; 
																						headerRow += (index == data.Ff.length-1) ? '\n' : ','; 
																					}); 
															csvFormattedDataTable = headerRow + csvFormattedDataTable;
															csvFormattedDataTable=csvFormattedDataTable.replace(/,/g, ";");
															
															//var encodedUri = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csvFormattedDataTable);							
															var encodedUri = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURIComponent(csvFormattedDataTable);
															this.href = encodedUri;
															this.download = 'DossierReport.csv';
															this.target = '_blank';
														});
														document.getElementById('chart_div').style.height="-webkit-fill-available";//Para que haga resize autom�tico
														document.getElementById('anigifChart').style.display='none';
													}
												).catch((err)=>{
													document.getElementById('anigifChart').style.display='none';
												});
									
								
					}
					else
						if (this.TipoGrafico==1)
							this.DrawChart("graficarexs.asp");
						else
							//this.DrawChart("tipogasto.asp"); 
							this.DrawChart("pasospasaporte.asp");
						//document.getElementById('anigifChart').style.display='none';
				  },
				  SaveChartDraw: function(chart){
						var enTit = this.TextoChart;
						var enRango = this.formatDates(this.buttonChartDateOne, this.buttonChartDateTwo);
						var conUsuario = this.usuariochartselected; //document.all.selequipo.options[document.all.selequipo.selectedIndex].value
						var grupoSelected = this.grupochartselected;
						var ChartStatusSelected = this.selchartstatus;
						var mm = 0;
						var selloFound=false;
						var SelloTitle='';
						for (mm=0;mm<this.sellos.length;mm++)
							if (this.sellos[mm].valor==this.sellochartselected){
								selloFound=true;
								break;
							}
						if (selloFound)
							SelloTitle=this.sellos[mm].desc;
						else
							SelloTitle='';
												
						if (!enTit)
							enTit='';
						if (!enRango)
							enRango = "0";
						if (!grupoSelected)
							grupoSelected = "0";						
						
						var Body={"token":666123,
									"var":app.userid+".chart"+chart,
									"grupo":grupoSelected,
									"expediente":this.CarpetaSeleccionada,
									"DCType":this.ChartDCSeleccionado,
									"Sello":this.sellochartselected,
									"SelloTitle":SelloTitle,
									"DossierStatus":ChartStatusSelected,
									"CamposDC":this.showCols,
									"d1":this.buttonChartDateOne,
									"d2":this.buttonChartDateTwo,
									"ted":enTit,
									"fromUser":conUsuario,
									"TipoChart":this.TipoChart
									};
						db.vars.get({var:app.userid+".chart"+chart}, chh=>{
							if (chh==undefined){
								db.vars.put(Body).then(function(){
									app.DrawDashboard(chart,false)
								});
							}
							else{
								db.vars.update(chh.id,Body).then(function(updated){
									app.DrawDashboard(chart,false);
								});								
							}
							
						});
				  },
				  LoadDC: async function(DcIndex){
					//var Code=this.$root.DataClips[DcIndex].Code;
					DeleteImagefromDC();
					cleanFotoCanvas();
					document.getElementById('DCWebId').value="";
					document.getElementById('ModalDataClips').style.display='none';
					document.getElementById('ModalDataClipEditor').style.display='block';
					reOnclick_Accept();
					document.getElementById('Editando').style.display='none';
					document.getElementById('DCImage').style.display='none';
					NoBorrarImagen();
					document.getElementById('DCImage').src=null;
					document.getElementById('Editor_DataClipName').innerHTML=this.$root.DataClips[DcIndex].Desc;
					/*if (app.$root.DataClips[DcIndex].tituloDC!=undefined)
						document.getElementById('retHeadTituloDC').value = app.$root.DataClips[DcIndex].tituloDC;
					else
						document.getElementById('retHeadTituloDC').value = '';*/
					//document.getElementById('retHeadTituloDC').value = this.$root.DataClips[DcIndex].tituloDC;
					if (DcIndex==0 && app.$root.DataClips[DcIndex].tituloDossier!=undefined){
						document.getElementById('retHeadTituloDossier').value=app.$root.DataClips[DcIndex].tituloDossier;
					}
					else
						document.getElementById('retHeadTituloDossier').value='';
					document.getElementById('ImgSource').value=""; 
					await newDCSelected(this.$root.DataClips[DcIndex]);
				  },
				  AgregaAnexo: async function(RexId){
					if (RexId<0){
						var dummy = await CheckSyncRexId(RexId);
						if (dummy)
							return;
					}	
					document.getElementById('retHeadTituloDossier').value='';
					DeleteImagefromDC();
					cleanFotoCanvas();
					document.getElementById('DataClipRexId').value = RexId;
					document.getElementById('ModalDataClips').style.display='none';
					document.getElementById('ModalDataClipEditor').style.display='block';
					reOnclick_Accept();
					document.getElementById('DCImage').style.display='none';
					NoBorrarImagen();
					document.getElementById('DCImage').src=null;
					document.getElementById('Editor_DataClipName').innerHTML=langtext[0].Anexo;
					document.getElementById('ImgSource').value=""; 
					newDCSelected(
									{
										"Code": langtext[0].Anexo,
										"DcStructure":
											[
												{
													"desc":langtext[0].DescAnexo,
													"req":"true",
													"rethead":langtext[0].Descripcion,
													"type":"Edt",
													"value":""
												}
											],
										"Desc":langtext[0].Anexo,
										"tituloDC": langtext[0].Descripcion,
										"concomentario":"false",
										"default":"false",
										"req":"false"
									}
								);
				  },
				  AgregaRecordatorio: async function(RexId){
					if (RexId<0){
						var dummy = await CheckSyncRexId(RexId);
						if (dummy)
							return;
					}
					DeleteImagefromDC();
					cleanFotoCanvas();
					document.getElementById('DCWebId').value="";
					document.getElementById('PrevDC').value="";
					document.getElementById('NextDC').value="";
					
					document.getElementById('retHeadTituloDossier').value='';
					//document.getElementById('retHeadTituloDC').value="ObsRecordatorio";
					document.getElementById('DataClipRexId').value = RexId;
					document.getElementById('ModalDataClips').style.display='none';
					document.getElementById('ModalDataClipEditor').style.display='block';
					reOnclick_Accept();
					document.getElementById('DCImage').style.display='none';
					NoBorrarImagen();
					document.getElementById('DCImage').src=null;
					document.getElementById('Editor_DataClipName').innerHTML=langtext[0].Recordatorio;
					document.getElementById('ImgSource').value=""; 
					newDCSelected(
									{
										"Code": langtext[0].Recordatorio,
										"Desc":langtext[0].Recordatorio,
										"tituloDC": langtext[0].ObsRecordatorio,
										"concomentario":"false",
										"default":"false",
										"req":"false",
										"DcStructure":
											[
												{
													"desc":langtext[0].Fecha,
													"req":"true",
													"rethead":langtext[0].FechaRecordatorio,
													"type":"Date",
													"value":""
												},
												{
													"desc":"Hora",
													"req":"true",
													"rethead":langtext[0].HoraRecordatorio,
													"type":"Time",
													"value":""
												},
												{
													"desc":langtext[0].Observacion,
													"req":"true",
													"rethead":langtext[0].ObsRecordatorio,
													"type":"EdtML",
													"value":""
												},
												{
													"desc":langtext[0].Repetir,
													"req":"true",
													"rethead":langtext[0].Repetir,
													"type":"RadioV",
													"value":
															[
																{
																	"desc": langtext[0].NoRepite
																},
																{
																	"desc": langtext[0].Semanalmente
																},
																{
																	"desc": langtext[0].Mensualmente
																},
																{
																	"desc": langtext[0].Anualmente
																}
															]
													
												}
											],
									}
								);
				  }
				  ,
				  AgregaCita: async function(RexId){
					if (RexId<0){
						var dummy = await CheckSyncRexId(RexId);
						if (dummy)
							return;
					}
					DeleteImagefromDC();
					cleanFotoCanvas();
					document.getElementById('DCWebId').value="";
					document.getElementById('PrevDC').value="";
					document.getElementById('NextDC').value="";
					document.getElementById('retHeadTituloDossier').value='';
					
					//document.getElementById('retHeadTituloDC').value="ObsCita";
					document.getElementById('DataClipRexId').value = RexId;
					document.getElementById('ModalDataClips').style.display='none';
					document.getElementById('ModalDataClipEditor').style.display='block';
					reOnclick_Accept();
					document.getElementById('DCImage').style.display='none';
					NoBorrarImagen();
					document.getElementById('DCImage').src=null;
					document.getElementById('Editor_DataClipName').innerHTML=langtext[0].Cita;
					document.getElementById('ImgSource').value=""; 
					newDCSelected(
									{
										"Code": langtext[0].Cita,
										"Desc":langtext[0].Cita,
										"tituloDC": langtext[0].ObsCita,
										"concomentario":"false",
										"default":"false",
										"req":"false",
										"DcStructure":
											[
												{
													"desc":langtext[0].Fecha,
													"req":"true",
													"rethead":langtext[0].FechaCita,
													"type":"Date",
													"value":""
												},
												{
													"desc":langtext[0].Hora,
													"req":"true",
													"rethead":langtext[0].HoraCita,
													"type":"Time",
													"value":""
												},
												{
													"desc":langtext[0].Nombre,
													"req":"true",
													"rethead":langtext[0].Nombre,
													"type":"Edt",
													"value":""
												},
												{
														"desc":langtext[0].Telefono,
														"req":langtext[0].Telefono,
														"rethead":langtext[0].Telefono,
														"type":"Telf",
														"value":""
												},
												{
													"desc":langtext[0].Observacion,
													"req":"true",
													"rethead":langtext[0].ObsCita,
													"type":"EdtML",
													"value":""
												}
											],
									}
								);
				  }
				  ,
				  
				  AgregaTarea: async function(RexId,grupo){
					if (RexId<0){
						var dummy = await CheckSyncRexId(RexId);
						if (dummy)
							return;
					}
					document.getElementById('DCWebId').value="";
					document.getElementById('PrevDC').value="";
					document.getElementById('NextDC').value="";
					
					this.loadusersdadogrupo(grupo).then( function(users){
						var usuarios = [];
						for (var xx=0; xx< users.length;xx++){
							var user = users[xx].userid;
							user = user.trim();
							var item = {"desc":user};
							usuarios.push(item);
						}
						DeleteImagefromDC();
						cleanFotoCanvas();
						document.getElementById('retHeadTituloDossier').value='';
						//document.getElementById('retHeadTituloDC').value="DescTarea";
						document.getElementById('DataClipRexId').value = RexId;
						document.getElementById('ModalDataClips').style.display='none';
						document.getElementById('ModalDataClipEditor').style.display='block';
						reOnclick_Accept();
						document.getElementById('DCImage').style.display='none';
						NoBorrarImagen();
						document.getElementById('DCImage').src=null;
						document.getElementById('Editor_DataClipName').innerHTML=langtext[0].Tarea;
						document.getElementById('ImgSource').value=""; 
						newDCSelected(
										{
											"Code": langtext[0].Tarea,
											"Desc":langtext[0].Tarea,
											"tituloDC": langtext[0].DescTarea,
											"concomentario":"false",
											"default":"false",
											"req":"false",
											"DcStructure":
												[
													{
														"desc":langtext[0].Descripcion,
														"req":"true",
														"rethead":langtext[0].DescTarea,
														"type":"EdtML",
														"value":""
													},												
													{
														"desc":langtext[0].Ejecutor,
														"req":"true",
														"rethead":langtext[0].EjecutorTarea,
														"type":"Spin",
														"value":usuarios
													},
													{
														"desc":langtext[0].Fecha,
														"req":"true",
														"rethead":langtext[0].FechaTarea,
														"type":"Date",
														"value":""
													},
													{
														"desc":langtext[0].Hora,
														"req":"true",
														"rethead":langtext[0].HoraTarea,
														"type":"Time",
														"value":""
													}
													
												],
										}
									);
					})
				  },
				  OtrasOps:function (rexId,rexstatus){
				  var CurrentDossier=document.getElementById('RR'+rexId);
					app.CurrentTitle=CurrentDossier.querySelector(".titulo").title;
					app.CurrentRexStatus=rexstatus;
					app.RexStatus=rexstatus;
					//document.getElementById('TituloOtrasOps').innerHTML='Nombre del Dossier';
					document.getElementById('OtrasOpsRexId').value=rexId;
					document.getElementById('OtrasOpsgrupo').value=CurrentDossier.getAttribute('grupo');
					document.getElementById('ModalOtrasOps').style.display='block';
					//alert('rexid: '+rexId+ ', rexstatus: '+rexstatus);
				  },
				  DrawDashboard: function(offset,refresh){
					var Body={};
					var key=app.userid+".chart"+offset;
					db.vars.get({var:key}, function(chh){
																Body=chh;
																if (Body.SelloTitle==undefined)
																	Body.SelloTitle='';
																if (Body.DossierStatus==undefined)
																	Body.DossierStatus=1;
																
																document.getElementById('Titulo'+offset).innerHTML=Body.DCType.replace(/_/g, " ") + ' ' + Body.SelloTitle;
																document.getElementById('EnTitulo'+offset).innerHTML=Body.CamposDC[0].replace(/_/g, " ") + (Body.ted!=''? ':' + Body.ted:'');
																if (Body.fromUser=='T')
																	document.getElementById('UsuarioSel'+offset).innerHTML=langtext[0].AllUsersText;
																else
																	document.getElementById('UsuarioSel'+offset).innerHTML=langtext[0].Usuario+': ' + Body.fromUser;
																var dumbDateFormat = app.dateFormat;
																app.dateFormat += ' YY';
																if (refresh){ // llevalo a ahorita
																	var Today = new Date();
																	var Month = ("0" + (Today.getMonth() + 1)).slice(-2);
																	var Day = ("0" + Today.getDate()).slice(-2);
																	Body.d2 = Today.getFullYear() + "-" + Month + "-" + Day;
																}
																document.getElementById('Rango'+offset).innerHTML=app.formatDates(Body.d1, Body.d2);
																app.dateFormat = dumbDateFormat;
																switch (Body.DossierStatus){
																	case "1":
																		document.getElementById('Status'+offset).innerHTML=langtext[0].Activos;
																		break;
																	case "2":
																		document.getElementById('Status'+offset).innerHTML=langtext[0].Historico;
																		break;
																	case "3":
																		document.getElementById('Status'+offset).innerHTML=langtext[0].ActivosHistoricos;
																		break;
																	default:
																}
																fetch('api/reporte.php', {
																		  method: 'POST',
																		  headers: {
																			'Accept': 'application/json, text/plain, */*',
																			'Content-Type': 'application/json'
																		  }
																		  ,body: JSON.stringify(Body)
																		})
																.then(res=>res.json())
																	.then(res => {
																					var poppit = false;
																					if (Body.CamposDC.length==1){
																						poppit = true;
																						Body.CamposDC.push(langtext[0].Cantidad);
																					}
																					var data = new google.visualization.DataTable();
																					for (xx=0;xx<Body.CamposDC.length;xx++){
																						//if (isNaN(this.showCols[xx]))
																						if (Body.CamposDC[xx]!=langtext[0].Cantidad)
																							data.addColumn('string', Body.CamposDC[xx]);
																						else
																							data.addColumn('number', Body.CamposDC[xx]);
																					}
																					data.addRows(res);
																					
																					//var ChartTitle = "";
																					//if (Body.CamposDC.length==2){
																					//	ChartTitle = tBody.CamposDC[0]+ '-' + Body.ted + ' - ' + this.formateaFecha + ' (' + conUsuario + ')';
																					//}
																														
																					var options = {
																					  //title: ChartTitle,
																					  legend: { position: 'none' },
																						  //'width':400,
																						  'height':250
																					};
																					
																					var chart = null;				
																					switch (Body.TipoChart){
																						case 'Bar':
																							chart=new google.visualization.ColumnChart(document.getElementById('chart_div'+offset));
																							break;
																						case 'Pie':
																							chart=new google.visualization.PieChart(document.getElementById('chart_div'+offset));
																							options = {
																								  //title: ChartTitle,
																								  is3D: true,
																								  //'width':400,
																									'height':250
																								};
																							break;
																						case 'Line':
																							chart=new google.visualization.LineChart(document.getElementById('chart_div'+offset));
																							options = {
																								  //title: ChartTitle,
																								  curveType: 'function',
																								  legend: { position: 'none' },
																								  //'width':400,
																									'height':250
																								};
																							break;
																						case 'Table':
																							chart=new google.visualization.Table(document.getElementById('chart_div'+offset));
																							options={showRowNumber: true, width: '100%', height: '100%'};
																							break;
																						default:
																							chart=new google.visualization.ColumnChart(document.getElementById('chart_div'+offset));
																							break;
																					}
																					if (poppit)
																						Body.CamposDC.pop();
																					chart.draw(data, options);
																					//document.getElementById('chart_div').style.height="-webkit-fill-available";//Para que haga resize autom�tico
																					//document.getElementById('anigifChart').style.display='none';
																				}
																			).catch((err)=>{
																				document.getElementById('anigifChart').style.display='none';
																			});
					
						})
					},
				  
					syncDB: function(){
						syncDB();
					},
					logginIn: function(){						
						  $('#rexarr').css('visibility', 'visible');
						  var aicon = document.getElementById('aicon');
						  var menuaicon = document.getElementById('menuaicon');
						  try{
							  aicon.src='aicons/user-'+this.userid+'.jpg';
							  menuaicon.src='aicons/user-'+this.userid+'.jpg';
							  aicon.title=langtext[0].SessionMenuText+this.userid;
							  aicon.style.display='';
						  }catch(e){
							aicon.src='aicons/default'+ randomNumber() + '.png';
						  }
						  
						  this.gruposdadouser(this.userid).then(function(){	// dale tiempo para que lea todo
								LoadGruposInCache();
								/*setTimeout(function () {	// dale tiempo para que lea todo
									ActualizaUI();
								}, 2000);*/
							});
						  document.getElementById('CalendarFrame').src='calendar.html?u='+this.userid;
						  
						  this.TareasDadoUser(this.userid);
						  this.RecordatoriosDadoUser(this.userid);
						  this.CitasDadoUser(this.userid);
						  this.VencimientosDadoUser(this.userid);
					},
					CheckAddPerfil: function(){
						this.GrupoPerfil=[];
						var perfiles=parseJwt(this.JWT).perfiles;
						var xx=0;
						var yy=0;
						for (xx=0;xx<perfiles.length;xx++){
							this.GrupoPerfil['G'+this.grupos[xx].grupo]=0;
							//document.getElementById('AddGrupo'+this.grupos[xx].grupo).style.display='none';
							var profiles=this.grupos[xx].new;
							try{
								for (yy=0;yy<profiles.length;yy++){
									if (perfiles[xx].perfil == profiles[yy]){
										this.GrupoPerfil['G'+this.grupos[xx].grupo]=1;
										//document.getElementById('AddGrupo'+this.grupos[xx].grupo).style.display='';									
									}
								}
							}catch(e){}
						}
						Vue.set(app.GrupoPerfil,'G'+this.grupos[xx].grupo,app.GrupoPerfil['G'+this.grupos[xx].grupo]);
					},
					Sello: function (RexId,DCId){
									if (RexId>0){
										link='api/dcs-V2.php/'+DCId;
										this.$http.get(link).then(function(response){
											var DC = response.data;
											var DCType = DC.DCType;
											var dcxx=document.getElementById("DC"+DCId);
											var grupo=app.$refs.RexSelected.rexobj.grupo;
											if (dcxx){
												grupo = parseInt(dcxx.getAttribute("grupo"));
											}
											document.getElementById('SelloText').value=DC.comment;
											/////////////////
											app.$refs.ModalRex.LoadDataClipStruct(grupo,DCType).then(function(DCStruct){
												var Sellos=app.LoadSellos(DCType);
												if (RexId==0)									
													document.getElementById('DataClipRexId').value= app.$refs.ModalRex.rexobj.repciId;									
												else
													document.getElementById('DataClipRexId').value= RexId;
												document.getElementById('DCWebId').value=DC.id;
												
												app.SelectFromSellos(Sellos,DCType);	
											})
										
											//////////////////
											
											/*var Sellos=this.LoadSellos(DCType);
											
											if (RexId==0)									
												document.getElementById('DataClipRexId').value= app.$refs.ModalRex.rexobj.repciId;									
											else
												document.getElementById('DataClipRexId').value= RexId;
											document.getElementById('DCWebId').value=DC.id;
											
											this.SelectFromSellos(Sellos);
											*/
									
										}, function(error){
										console.log(error.statusText);
									});
								}
						},
						LoadSellos: function (type){
							var retval=[];
							switch (type) {
							  case langtext[0].Tarea:
								retval = [{"desc":langtext[0].Aceptada,"valor":"1","src":"assets/sello/aceptada.png","id":"Aceptada"}, {"desc":langtext[0].EnProgreso,"valor":"2","src":"assets/sello/enprogreso.png","id":"EnProgreso"}, {"desc":langtext[0].Lista,"valor":"3","src":"assets/sello/lista.png","id":"Lista"}, {"desc":langtext[0].Incompleta,"valor":"4","src":"assets/sello/incompleta.png","id":"Incompleta"},  {"desc":langtext[0].Anulada,"valor":"5","src":"assets/sello/anulada.png","id":"Anulada"}, {"desc":langtext[0].Borrada,"valor":"6","src":"assets/sello/borrada.png","id":"Borrada"}];
								break;
							  case langtext[0].Recordatorio:
								retval = [{"desc":langtext[0].Listo,"valor":"3","src":"assets/sello/listo.png","id":"Listo"}, {"desc":langtext[0].Borrada,"valor":"6","src":"assets/sello/borrada.png","id":"Borrada"}];
								break;
							  case langtext[0].Cita:
								retval = [{"desc":langtext[0].Lista,"valor":"3","src":"assets/sello/lista.png","id":"Lista"}, {"desc":langtext[0].Anulada,"valor":"5","src":"assets/sello/anulada.png","id":"Anulada"}, {"desc":langtext[0].Borrada,"valor":"6","src":"assets/sello/borrada.png","id":"Borrada"}];
								break;
							  default:
								if (app.DataClips!=[]){
									for (var x=0;x<app.DataClips.length;x++){
										if (app.DataClips[x].Code.toUpperCase()==type.toUpperCase()){
											retval = app.DataClips[x].Sellos;
											break;
										}
									}
								}
								break;
							}
							return (retval);
						},
						SelectFromSellos: function (SelloStruct,type){
							this.SellosDisponibles = SelloStruct;
							this.sellos=SelloStruct;
							this.sellos.forEach(function (item,index){
													item.dctype=type;
												});
							document.getElementById('ModalSellos').style.display="block";
							return;
						},
						SetSello: function(id,value,dctype){
							var RexId = document.getElementById('DataClipRexId').value;
							var DCid=document.getElementById('DCWebId').value;
							var image=document.getElementById(id);
							var mm = 0;
							var selloFound=false;
							var SelloImage='';
							var SelloTitle='';
							for (mm=0;mm<this.sellos.length;mm++)
								if (this.sellos[mm].valor==value){
									selloFound=true;
									break;
								}
							if (selloFound){
								SelloTitle = this.sellos[mm].desc;
								SelloImage=this.sellos[mm].src;
								var ArrayDumb=SelloImage.split('/');
								SelloImage=ArrayDumb[ArrayDumb.length-1];
							}
							else
								SelloImage='';
							image.style.filter= "grayscale(100%)";
							image.style.border = "thick solid #0000FF";
							//alert("Set valor:"+value + " RexId:" + RexId + " DC:"+ DCid);
							setTimeout(function () {
								image.style.filter= "";
								image.style.border = "";
								document.getElementById('ModalSellos').style.display="none";
							}, 300);
							var d=new Date();
							var now = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2)  + " " + ("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);
							app.currentGPSOrigin='gps';
							if (app.currentLongitud==0){
								app.currentGPSOrigin = 'IP';
							}
							var fetchBody={	"rexid":RexId,
											"dcid":DCid,
											"dctype":dctype,
											"when_date":now,
											"longitud":app.currentLongitud.toString(),
											"latitud": app.currentLatitud.toString(),
											"fromUser": app.userid,
											"newStatus": value + "",
											"SelloImage":SelloImage,
											"LocationOrigin": app.currentGPSOrigin,
											"SelloComment": SelloTitle+":"+document.getElementById('SelloText').value
										};
							fetch('api/setsello.php/23423', {
														  method: 'POST',
														  headers: {
															'Accept': 'application/json, text/plain, */*',
															'Content-Type': 'application/json'
														  },
														  body:JSON.stringify(fetchBody)
														}) 
								.then(res=>res.json())
										.then(res => {// res tiene el viejo DC y el Nuevo...Solo eso
										var oldDC = res.old;
										var newDC = res.new;
										var RexId = res.rexid;
										RemoveIfInGrid(oldDC);
										app.$refs.RexSelected.getRexData(RexId);
										ShowDCinGridById(newDC,RexId);
										if (document.getElementById('ModalRexEditor').style.display=="block"){
											app.$refs.ModalRex.getRexData(RexId);
											setTimeout(function () {							
												app.$refs.ModalRex.ShowDC(newDC);
											}, 5000);
										}
										this.TareasDadoUser(this.userid);
										this.RecordatoriosDadoUser(this.userid);
										this.CitasDadoUser(this.userid);
										this.VencimientosDadoUser(this.userid);
										})
										.catch((err)=>{
													//document.getElementById('anigifChart').style.display='none';
												});
						
						},
						SetRexStatus:function(Status){
							var RexId=document.getElementById('OtrasOpsRexId').value;
							//alert('New Status is ' + Status + ' RexId= '+RexId);
							var d=new Date();
							var now = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2)  + " " + ("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);
							app.currentGPSOrigin='gps';
							if (app.currentLongitud==0){
								app.currentGPSOrigin = 'IP';
							}
							var StatusBody={"rexid":RexId,
											"newStatus": Status + "",
											"when_date":now,
											"grupo":document.getElementById('OtrasOpsgrupo').value,
											"longitud":app.currentLongitud.toString(),
											"latitud": app.currentLatitud.toString(),
											"fromUser": app.userid,
											"LocationOrigin": app.currentGPSOrigin
										};
							fetch('api/setrexstatus.php/23423', {
														  method: 'POST',
														  headers: {
															'Accept': 'application/json, text/plain, */*',
															'Content-Type': 'application/json'
														  },
														  body:JSON.stringify(StatusBody)
														}) 
								.then(res=>res.json())
										.then(res => {
										document.getElementById('ModalOtrasOps').style.display='none';
										var RexId = res.rexid;
										app.$refs.RexSelected.getRexData(RexId);
										if (document.getElementById('ModalRexEditor').style.display=="block"){
											app.$refs.ModalRex.getRexData(RexId);
										}
										this.TareasDadoUser(this.userid);
										this.RecordatoriosDadoUser(this.userid);
										this.CitasDadoUser(this.userid);
										this.VencimientosDadoUser(this.userid);
										})
										.catch((err)=>{
													document.getElementById('ModalOtrasOps').style.display='none';
													alert(langtext[0].errorSetEstadoRexText+ err);
												});
							
							
						},
						SetCambioPwd: function(){
							var pwd = document.getElementById('Login_PWDOrg').value;
							var pwd1 = document.getElementById('Login_PWD1').value;
							if (pwd1.length<6)
							{
								alert(langtext[0].newPwd2Short);
								return;
							}
							var pwd2 = document.getElementById('Login_PWD2').value;
							if (pwd1!=pwd2){
								alert(langtext[0].mustBeEqualPwds);
								return;
							}
							document.getElementById('CambioPwdSpin').style.display='inline';
							fetch('api/cambioclave.php', {
								  method: 'POST',
								  headers: {
									'Accept': 'application/json, text/plain, */*',
									'Content-Type': 'application/json'
								  }
								  ,body: JSON.stringify({"userid":this.userid,"pwd":pwd,"newpwd":pwd1})
								}).then (response => {
									  return response.json();
									}).then(token => {
									  if (token.type=='error'){
										document.getElementById('CambioPwdSpin').style.display='none';
										alert(langtext[0].errorSetNewPwd+token.msg);
										loggout(false);
									  }
									  else{
										  document.getElementById('CambioPwdSpin').style.display='none';
										  alert(langtext[0].setNewPwdOk);
										  document.getElementById('ModalCambioPwd').style.display='none';
										  loggout(false);
									  }
									}).catch (function(){
											document.getElementById('CambioPwdSpin').style.display='none';
											//alert('No se cambio la clave');
											document.getElementById('ModalCambioPwd').style.display='none';
											loggout(false);
									}); 
						}
			},
			mounted: function () {
				logginIn();			  		  
			}            
		}	
    )

function LoadGruposInCache(){
if (app.grupos.length>0)	
	app.grupos.forEach(fetchGrupo);
}
function fetchGrupo(item, index) {
	var fetchJsonFile = 'grupos/'+item.grupo+'.json';
	fetch(fetchJsonFile).then(res=>res.json())
		.then(res => {
				if (res.logs[0].DCs[0].read!=undefined)
					app.grupos[index].read=res.logs[0].DCs[0].read;
				else
					app.grupos[index].read='readall';
				if (res.logs[0].DCs[0].new!=undefined)
					app.grupos[index].new=res.logs[0].DCs[0].new;
				else
					app.grupos[index].new='newall';
				if (res.logs[0].DCs[0].edit!=undefined)
					app.grupos[index].edit=res.logs[0].DCs[0].edit;
				else
					app.grupos[index].edit='newall';
				ActualizaUI();
			});
	fetch('DCImages/default'+item.grupo+'.jpg');
	fetch('ricons/'+item.grupo+'.png');
}


function gotDevices(deviceInfos) {
  // Handles being called several times to update labels. Preserve values.
  var values = selectors.map(function(select) {
    return select.value;
  });
  selectors.forEach(function(select) {
    while (select.firstChild) {
      select.removeChild(select.firstChild);
    }
  });

  for (var i = 0; i !== deviceInfos.length; ++i) {
    var deviceInfo = deviceInfos[i];
    var option = document.createElement("option");
    option.value = deviceInfo.deviceId;

    if (deviceInfo.kind === "videoinput") {
      option.text = deviceInfo.label || "camera " + (videoSelect.length + 1);
      videoSelect.appendChild(option);
    } else {
      console.log("Some other kind of source/device: ", deviceInfo);
    }

    selectors.forEach(function(select, selectorIndex) {
      if (
        Array.prototype.slice.call(select.childNodes).some(function(n) {
          return n.value === values[selectorIndex];
        })
      ) {
        select.value = values[selectorIndex];
      }
    });
  }
}

navigator.mediaDevices
  .enumerateDevices()
  .then(gotDevices)
  .catch(handleError);

function gotStream(stream) {
  //arToolkitSource.domElement.srcObject = stream; // make stream available to console
   window.stream = stream; // make stream available to browser console
   video.srcObject = stream;
   //try{video.play()}
   //catch(e){};
  // Refresh button list in case labels have become available
  return navigator.mediaDevices.enumerateDevices();
}

function LoadCamerasInfo() {
  if (window.stream) {
    window.stream.getTracks().forEach(function(track){
      track.stop();
    });
  }
  var videoSource = videoSelect.value;
  var constraints = {
    video: {
      deviceId: videoSource ? { exact: videoSource } : undefined
    }
  };
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(gotStream)
    .then(gotDevices)
	.then(function(){
		stopStreamedVideo(video);
	})
    .catch(handleError);
	
	setTimeout(function () {	// dale tiempo para que lea todo
			if(Cameras.options.length<2){
				document.getElementById('NextCamera').style.display="none";
			}
			stopStreamedVideo(video);
		}, 5000);
}
function handleError(error) {
  console.log("navigator.getUserMedia error: ", error);
}
	
	window.onbeforeunload = function() {
        return langtext[0].wantReStartDossier;
    }
	
	var FingerPrintCall='http://localhost:5000';
	
	function initRexs() {
		SetCurrentLanguageTexts();// traduce de español al lenguaje que quieras
		$('#Login_User').keypress(function(event) {
			if (event.keyCode == 13 || event.which == 13) {
				document.getElementById('Login_PWD').focus();
				event.preventDefault();
			}
		});
		$('#Login_PWD').keypress(function(event) {
			if (event.keyCode == 13 || event.which == 13) {
				app.loginRex(document.getElementById('Login_User').value,document.getElementById('Login_PWD').value);
				event.preventDefault();
			}
		});
		if (window.navigator.onLine){
			try{
				initializemap();
			}
			catch(e){
				document.getElementById('Donde1').style.display='none';
				document.getElementById('Donde2').style.display='none';			
				document.getElementById('Donde3').style.display='none';			
			}
		}
		else{
			document.getElementById('uploadrexs').style.display='none';
		}
		dragElement(document.getElementById("ChartItem"));
		document.getElementById("ChartItem").style.width="350px;"
		setChartDiv0Size(600);
		
	    var d=new Date();
		try{
			app.$root.$children[0].selectedDate1=(d.getFullYear(d)-1)+'-'+("0"+(d.getMonth()+1)).slice(-2)+'-'+("0"+d.getDate()).slice(-2);
			app.$root.$children[0].selectedDate2=(d.getFullYear(d))+'-'+("0"+(d.getMonth()+1)).slice(-2)+'-'+("0"+d.getDate()).slice(-2);
			app.$root.$children[1].selectedDate1=(d.getFullYear(d)-1)+'-'+("0"+(d.getMonth()+1)).slice(-2)+'-'+("0"+d.getDate()).slice(-2);
			app.$root.$children[1].selectedDate2=(d.getFullYear(d))+'-'+("0"+(d.getMonth()+1)).slice(-2)+'-'+("0"+d.getDate()).slice(-2);
		}
		catch(e){
		}
		//ShowMapa();
		//ShowCalendario(); //se activa en el app.loginRex
		w3_close();
		w3_open();
		EnableGridDrag(600);
		LoadCamerasInfo();
		if (navigator.geolocation) {// registra la posicion desde donde se pide la creacion de la carpeta o el dossier
			navigator.geolocation.watchPosition(function(position) {
				app.currentLongitud=position.coords.longitude;
				app.currentLatitud=position.coords.latitude;
			}, PosError);
		}
		StartDB();
		if (this.userid==undefined || this.userid==''){
			document.getElementById('loading').style.display='none';
			document.getElementById('SplashLogo').style.top='0%';
			document.getElementById('SplashLogo').style.right='0%';
			document.getElementById('LoginBox').style.display='';
		}
		else{
			document.getElementById('splashscreen').style.opacity="0";
			setTimeout(function () {	// dale tiempo para que lea todo
				document.getElementById('splashscreen').style.display='none';
			}, 1000);

		}
		dbGetCantNoSync();
		//Agregando Service Worker
		requestPermission();
		if ('serviceWorker' in navigator){
		  navigator.serviceWorker.register('dossier-worker.js');
		  navigator.serviceWorker.ready.then(function(swRegistration) {
			ServiceWorker = swRegistration;
			navigator.serviceWorker.addEventListener('message', function(event){
				//alert("Received Message: " + event.data);
				ActualizaUI();
				//event.ports[0].postMessage("Client 1 Says 'Hello back!'");
				});
			return;
			});
		
		}
		//var myVar = setInterval(ActualizaUI, 60000);
		ActualizaUI();
		
		window.addEventListener('offline', function(e) { 
												console.log('offline');
												document.getElementById('uploadrexs').style.display='none';
												});

		window.addEventListener('online', function(e) { 
													if (!map) 
														initializemap();
														document.getElementById('uploadrexs').style.display='';
													});

		CleanUpDB();
	}
	
async function CleanUpDB(){
	await db.rexs.where('repciId').notEqual("").delete(); //borra los que ya est�n registrados
	await db.DataClips.where('DCWebId').notEqual("").delete(); //borra los que ya est�n registrados
	await db.Tuplas.where('idDC').above(0).delete(); // borra los que ya est�n registrados
	 //Sacar los synced
	 db.rexs.toCollection().modify(function(rex){
		if (rex.syncing!=undefined && rex.syncing){
			//var now = new Date();
			//var diffDays = parseInt((now - rex.syncDateStart) / (1000 * 60 * 60 * 24));
			//if (diffDays >1) // si esta tratando de sincronizar y ha pasado mas de un dia, 
				rex.syncing=false; // limpia la marca de que est� sincronizando para que intente nuevamente.
		}
	 });
}
	
	
function ActualizaUI() { // cada minuto...
  app.TraeNoSyncs();
  dbGetCantNoSync();
  app.CheckAddPerfil(); 
}
	
	function reOnclick_Accept(){ // Para evitar que se le de varias veces al boton de Accept y se graben varios registros. Esta rutina rehabilita el onclick del boton de accept y lo nulifica cuando le das una vez
		var Boo = function(){
			document.getElementById("DC_accept").onclick = null; //para que solo le de al boton una vez y ya
			document.getElementById("DC_accept2").onclick = null; //para que solo le de al boton una vez y ya
			accept_DC('DCContainer');
		}
/*		var Boo2 = function(){
			document.getElementById("DC_accept").onclick = null; //para que solo le de al boton una vez y ya
			document.getElementById("DC_accept2").onclick = null; //para que solo le de al boton una vez y ya
			accept_DC('DCContainer');
		}
*/		document.getElementById("DC_accept").onclick = Boo;
		document.getElementById("DC_accept2").onclick = Boo;
	}
	
	var NotificationPermission = null;
	function requestPermission() {
	  if (!('Notification' in window)) {
		//alert('Notification API not supported!');//es safari en iOS
		return;
	  }
	  
	  Notification.requestPermission(function (result) {
		NotificationPermission=result;
	  });
	}
	var ServiceWorker = null;
	var db = null;
	function StartDB(){
		if (!db)
			db = new Dexie('RexSet');
		db.version(1).stores({
			rexs: '++id,repciId,when_date',
			DataClips:'++id,repciId,filename,DCWebId',
			Tuplas:'++id,idDC,value1,value2',
			vars:'++id,var'
		});	
	}
	function dbGetCantNoSync(){
		db.rexs.where("repciId").equals("").count(function (cantidad) {
			app.CantNoSyncs=cantidad;
		}).catch(function (error) {
			app.CantNoSyncs=0;
			//alert("1-"+ error.message);
		});
	}
	function parseJSON(data) {
		try{
			return JSON ? JSON.parse(data) : eval('(' + data + ')');
		}
         catch(e){
			return JSON ? JSON.parse('[]') : eval('[]');
		 }
			
	}
	function GetParameter(parameterName) {
    var result = null,
        tmp = [];
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        });
    return result;
}
	function generateGridItem(item) {
	  var itemElem = document.createElement('div');
	  var foldercontent = item.$el.innerHTML;
	  var repciId=null;
	  var status=item.rexobj.status;
	  var tipostatus="";
	  if (status=='2')
		tipostatus="historico";
	
	  if (item.rexobj.id!=undefined)
		repciId=-item.rexobj.id;
	  else
		repciId=item.rexobj.repciId;
	  var grupo = item.rexobj.grupo;
	  foldercontent=foldercontent.replace("class=\"portada\"", "class=\"portada\" onclick=\"WorkOnRex('"+repciId+"')\"" );
  	  //foldercontent=foldercontent.replace(/id=\"Dummy\"/g, "onclick='alert(\"EPA\");'" );

	  var itemTemplate = '' +
		  '<div class="item" id="RR'+ repciId +'" grupo="'+ grupo+'" status="'+ status +'" onmouseenter="document.querySelectorAll(\'.rextools\').forEach(function(el){el.style.display=\'none\';});document.getElementById(\'RexTools'+repciId+'\').style.display=\'block\'" >' +
		  '<div class="item-content">' +
	    '<div class="rex'+tipostatus+'" id="rex' +repciId +'">' +
		  foldercontent +
		  '</div>' +
		  '</div>';
		  if (status=='1'){
			itemTemplate=itemTemplate + '<div id="RexTools'+repciId+'" class="rextools w3-container w3-cell w3-bottom w3-center " style="font-size:1.3em;display:none;padding-right:20px;padding-bottom:16px;"><img style="padding-right:10px" class="tool-item" src="assets/reminder.png" title="'+langtext[0].Recordatorio+'" onclick="app.AgregaRecordatorio('+repciId+')"><a style="padding-right:10px" onclick="app.AgregaTarea('+repciId+','+grupo+');" title="'+langtext[0].AgregarTarea+'"><i class="fa fa-clipboard tool-item" ></i></a><a style="padding-right:10px" onclick="app.AgregaCita('+repciId+')" title="'+langtext[0].Cita+'"><i class="fa fa-calendar tool-item" ></i></a><a style="padding-right:10px" onclick="AddDataClip('+repciId+');" title="'+langtext[0].AgregarDC+'"><i class="fa fa-paperclip tool-item"></i></a><a style="padding-right:10px" onclick="app.AgregaAnexo('+repciId+');" title="'+langtext[0].AgregarImg+'"><i class="fa fa-file tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a></div>';
		  }
		  else{
			itemTemplate=itemTemplate + '<div id="RexTools'+repciId+'" class="rextools w3-container w3-cell w3-bottom w3-center " style="font-size:1.3em;display:none;padding-right:20px;padding-bottom:16px;"><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+ langtext[0].iconOtherOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a></div>';
		  }
		  itemTemplate=itemTemplate + '</div>';

	  itemElem.innerHTML = itemTemplate;
	  return itemElem.firstChild;
	}
function getGrupoFromRexList(DCid){
	return DCid.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute('grupo');
}

	var ShowDcSemaforo = false;

  function	ShowDCinGrid(Dcid){ // verificar en ShowDC que este id sea de ese rex
		if (ShowDcSemaforo==true)
			return;
		ShowDcSemaforo = true;
		grupo = getGrupoFromRexList(Dcid);
		var Dctype = Dcid.textContent.split(' ')[0]; //suponiendo que la primera palabra es el codigo del DataClip y luego viene un espacio en blanco
		app.SetGrupoJson(grupo); // para asegurar que esta cargado el grupo adecuado a este DC
		var RexInGrid=Dcid.parentElement.parentElement.parentElement.parentElement.parentElement;
		var RexId = parseInt(Dcid.parentElement.parentElement.parentElement.id.substr(3));

		//var RexId = RexInGrid.querySelector('.vertical').innerText;
		
		var offset=1;
		var GridItems=grid.getItems();
		for(var i=1;i<GridItems.length;i++){// buscando cual es el rex que le corresponde a este DC
			if (GridItems[i]._element.id==RexInGrid.id){
				offset=i;
				break;
			}
		}
		if (offset+1>=GridItems.length)
			offset=-2;
		for(var i=1;i<GridItems.length;i++){ // buscando si ya esta este dc para borrarlo
			var DCID=0;
			if (RexId<0)
				DCID = -Dcid.value;
			else
				DCID = Dcid.value;	
	
			if (GridItems[i]._element.id==('DC'+DCID)){
			var DCExist=document.getElementById('DC'+DCID);
				removeFromGrid(DCExist); // borra el abuelo
				break;
			}
		}		
		generateDCforGridItem(RexId,Dcid.value,offset+1);
		ShowDcSemaforo = false;		
	}
	
	function ShowDCinGridById(Dcid,RexId){
		var GridItems=grid.getItems();
		var offset=1;
		var grupo = app.$refs.RexSelected.rexobj.grupo;

		for(var i=1;i<GridItems.length;i++){// buscando cual es el rex que le corresponde a este DC
			if (GridItems[i]._element.id=="RR"+RexId){
				var Rexx = document.getElementById("RR"+RexId);
				grupo = parseInt(Rexx.getAttribute("grupo"));			
				offset=i;
				break;
			}
		}
		if (offset+1>=GridItems.length)
			offset=-2;
			
		var DCExist=document.getElementById('DC'+Dcid);
		if (DCExist){
			grupo = parseInt(DCExist.getAttribute("grupo"));
			removeFromGrid(DCExist); // borra el abuelo
		}				
			
		/*for(var i=1;i<GridItems.length;i++){ // buscando si ya esta este dc para borrarlo
			if (GridItems[i]._element.id==('DC'+Dcid)){ //if (GridItems[i]._element.id==('DC'+Dcid.value)){
			var DCExist=document.getElementById('DC'+Dcid);
				removeFromGrid(DCExist); // borra el abuelo
				break;
			}
		}*/
		
		generateDCforGridItem(RexId,Dcid,offset+1);
		
	}
	
	
	function RemoveIfInGrid(Dcid){
		var GridItems=grid.getItems();
		for(var i=1;i<GridItems.length;i++){ // buscando si ya esta este dc para borrarlo
			if (GridItems[i]._element.id==('DC'+Dcid)){
				var DCExist=document.getElementById('DC'+Dcid);
				removeFromGrid(DCExist); // borra el abuelo
				break;
			}
		}	
	}
	
	function RemoveAllLocalnGrid(){
		var GridItems=grid.getItems();
		for(var i=GridItems.length-1;i>=1;i--){ // buscando si ya esta este dc para borrarlo
			var dummyId = GridItems[i]._element.id + "";
			if (dummyId.indexOf("-")!=-1){
				var ItemExist=document.getElementById(dummyId);
				removeFromGrid(ItemExist); // borra el item
			}
		}	
	}
	
	function generateDCforGridItem(RexId,DcId,offset){
	
		if (RexId<0)
			DcId=-DcId;
	  var itemElem = document.createElement('div');
	  var gridWidth=GridElementSize(600);
	  var foldercontent='<div class="w3-custom w3-border-black w3-display-topleft" style="position:relative;cursor:move;z-index:8;background-color:black; width:'+gridWidth+'px;height:20px;">';
		foldercontent+='<a id="closeDc'+DcId+'" onclick="removeFromGridEvent(document.getElementById(\'DC'+DcId+'\'),event);"><i class="fa fa-remove w3-button w3-custom" style="padding: 0px;padding-left: 5px;" ></i></a>';
		//foldercontent+='<i class="fa fa-address-card-o" style="padding: 0px"></i>;
		foldercontent+='</div>';
		if (RexId<0)
			foldercontent += '<div><iframe class="DCFrame" id="DataClipFrameX" RexId="'+RexId+'"  DcId="'+(-DcId)+'" width='+gridWidth+'px height=464px src = "api/DCFrame.html"></iframe></div>';	  
		else{
			//foldercontent += '<div><iframe class="DCFrame" id="DataClipFrameX" RexId="'+RexId+'"  width='+gridWidth+'px height=464px src = "api/DCFrameV2.asp?usr=' + this.userid + '&dcId=' + DcId + '"></iframe></div>';
			app.$refs.DcDets.getDcData(DcId).then(function () {
						grid.refreshItems().layout();
						var dcContent = app.$refs.DcDets.$el.innerHTML;
						var DcObj=app.$refs.DcDets.dcobj;
						if (DcObj.repciId==undefined || DcObj.repciId== '' || DcObj.repciId==0){
							//alert('viene limpia');
							app.$refs.DcDets.dcobj=null;
							app.$refs.DcDets.$forceUpdate();
							return; // es un dblclk disfrazado o una carrera critica
							}
						app.$refs.DcDets.CleanTemplate();
						app.$refs.DcDets.$forceUpdate();
						dcContent=dcContent.replace("id=\"linkcarpeta\"", "id=\"linkcarpeta\" onclick=\"app.$refs.DcDets.CargaCarpeta('"+RexId+"')\"" );
  	  
						foldercontent +=dcContent;
						 var itemTemplate = '' +
						  '<div class="item" id="DC' +DcId +'"  RexId="'+RexId+'" grupo="'+DcObj.grupo+'" height="490px" >' +
						  '<div class="item-content">' +
						  '<div  id="DataClip' +DcId +'" style="width:'+gridWidth+'px; height: 490px;"  onmouseenter="document.querySelectorAll(\'.rextools\').forEach(function(el){el.style.display=\'none\';});document.getElementById(\'DCTools'+DcId+'\').style.display=\'block\';document.getElementById(\'DCSelected'+DcId+'\').style.display=\'block\'" >' +
						  foldercontent +
						  '</div>' +
						  '</div>' +
						  '<div><a id="DCSelected'+DcId+'"  class="w3-container w3-display-left rextools" style="font-size:1.5em;display:none;" ><i onclick="SelectDC('+DcId+')" class="fa fa-check-circle" style="color:lightgrey;"></i></a></div>' +
						  '<div id="DCTools'+DcId+'" class="rextools w3-container w3-cell w3-bottom w3-center" style="font-size:1.3em;display:none;padding-right:20px;padding-bottom:16px;"><a class="PrevDC" title="'+langtext[0].PrevDC+'" style="padding-right:10px;display:none;"><i class="fa fa-arrow-circle-o-left tool-item" ></i></a><a class="EditDC" onclick="EditDC('+RexId+','+DcId+');" title="'+langtext[0].EditDC  +'" style="padding-right:10px;display:none;"><i class="fa fa-pencil tool-item" ></i></a><img class="tool-item selloDC" src="assets/stamp.png" title="'+langtext[0].EditStatus+'" style="height: 1.3em;" onclick="Sello('+RexId+','+DcId+');" style="padding-right:10px"><a class="PrintDC" onclick="printDiv(document.getElementById(\'DataClip'+DcId+'\'))" title="'+langtext[0].Imprimir+'" style="padding-left:10px;display:inline;"><i class="fa fa-print tool-item" ></i></a><a class="NextDC"  title="'+langtext[0].DCSaved+'" style="padding-left:10px;display:none;"><i class="fa fa-arrow-circle-o-right tool-item" ></i></a></div>' +
						  '</div>';
						  '</div>';
					  itemElem.innerHTML = itemTemplate;
					  grid.add([itemElem.firstChild],{index:offset});
					  setTimeout(function () {
										var tt=null;
										var offset=0;
										while((tt=document.getElementById('Dc'+DcId+'tuplas2' + offset))!=undefined){
											tt.innerHTML=app.$refs.DcDets.DetectDCLink(tt.innerHTML);
											offset++;
										}
										ActivaBotonesEnGrid(DcId,DcObj.PrevDC,DcObj.NextDC,DcObj.OriginalDC,DcObj.repcistatus,DcObj.status);
										grid.refreshItems().layout
										//PdfStuff
										if (DcObj.filepath.substr(-4)=='.pdf'){
											StartPdfLib(DcObj);											
										}
										
										//End of PdfStuff
										var DCExist=null;
										if (RexId<0)
											DCExist=document.getElementById('DC'+(-DcId));
										else
											DCExist=document.getElementById('DC'+DcId);
											
										var att = document.createAttribute("grupo");
										att.value = DcObj.grupo;
										DCExist.setAttribute(att);
										att = document.createAttribute("dctype");
										att.value = DcObj.DCType;
										DCExist.setAttribute(att);
										DCExist.scrollIntoView();
										DCExist.scrollIntoView(true);
										setTimeout(function () {
														window.scrollBy(0, -60);
													}, 500);	
										
										
										//grid.synchronize();
									}, 500);
					});
				return;			
		}	  
	  var itemTemplate = '' +
		  '<div class="item" id="DC' +DcId +'" height="490px" >' +
		  '<div class="item-content">' +
		  '<div  id="DataClip' +DcId +'" style="width:'+gridWidth+'px; height: 490px;"  onmouseenter="document.querySelectorAll(\'.rextools\').forEach(function(el){el.style.display=\'none\';});document.getElementById(\'DCTools'+DcId+'\').style.display=\'block\';document.getElementById(\'DCSelected'+DcId+'\').style.display=\'block\'" >' +
		  foldercontent +
		  '</div>' +
		  '</div>' +
		  '<div><a id="DCSelected'+DcId+'"  class="w3-container w3-display-left rextools" style="font-size:1.5em;display:none;" ><i onclick="SelectDC('+DcId+')" class="fa fa-check-circle" style="color:lightgrey;"></i></a></div>' +
		  '<div id="DCTools'+DcId+'" class="rextools w3-container w3-cell w3-bottom w3-center" style="font-size:1.3em;display:none;padding-right:20px;padding-bottom:16px;"><a class="PrevDC" title="'+langtext[0].PrevDC+'" style="padding-right:10px;display:none;"><i class="fa fa-arrow-circle-o-left tool-item" ></i></a><a class="zoomDC" onclick="ZoomInDcImageX('+DcId+')" title="Zoom" style="padding-right:10px"><i class="fa fa-search-plus tool-item" ></i></a><a class="EditDC" onclick="EditDC('+RexId+','+DcId+');" title="'+langtext[0].EditDC+'" style="padding-right:10px;display:none;"><i class="fa fa-pencil tool-item" ></i></a><img class="tool-item selloDC" src="assets/stamp.png" title="'+langtext[0].EditStatus+'" style="height: 1.3em;" onclick="Sello('+RexId+','+DcId+');" style="padding-right:10px"><a class="NextDC"  title="'+langtext[0].DCSaved+'" style="padding-left:10px;display:none;"><i class="fa fa-arrow-circle-o-right tool-item" ></i></a></div>' +
		  '</div>';
		  '</div>';
	  itemElem.innerHTML = itemTemplate;
	  grid.add([itemElem.firstChild],{index:offset});
	  setTimeout(function () {
						grid.refreshItems().layout();
						//grid.synchronize();
					}, 500);
	}
	
	function SelectDC(DcId){
		var DC=document.getElementById('DC'+DcId);
		if (DC=="undefined")
			return null;
		var DcSelected=DC.getAttribute("selected");
		if (DcSelected==null || DcSelected==""){
			DC.setAttribute("selected","true");
			var DCCheck=document.getElementById('DCSelected'+DcId);
			DCCheck.classList.remove("rextools");
			DCCheck.getElementsByClassName('fa-check-circle')[0].style.color="black"
			DC.getElementsByClassName("DataClipInst")[0].classList.add("DCSelected");
		}
		else{
			DC.removeAttribute("selected");
			var DCCheck=document.getElementById('DCSelected'+DcId);
			DCCheck.classList.add("rextools");
			DCCheck.getElementsByClassName('fa-check-circle')[0].style.color="lightgrey"
			DC.getElementsByClassName("DataClipInst")[0].classList.remove("DCSelected");
		}
	}
		
		
		
	function addRex(rr) {
		var repciIdToAdd = null;
		if (rr.rexobj.id!=undefined)
			repciIdToAdd = -rr.rexobj.id;
		else	
			repciIdToAdd = rr.rexobj.repciId;
		var RepciExist=document.getElementById('rex'+repciIdToAdd);
		if (RepciExist){ // si existe reemplazalo por el mas reciente
			removeFromGrid(RepciExist.parentElement.parentElement); // borra el abuelo
		}
		var item = generateGridItem(rr);
		grid.add([item],{index:1})
		if (repciIdToAdd<0){
			if (rr.rexobj.Images[0]=='DCImages/default'+rr.rexobj.grupo+'.jpg'){
				var DossierX=document.getElementById('RR'+repciIdToAdd);
				var FotoPortada=DossierX.getElementsByClassName('portada')[0];
				FotoPortada.src=rr.rexobj.Images[0];
			}
			else{
				db.DataClips.where('filename').equals(rr.rexobj.Images[0]).first(function (Dc){
																			var DossierX=document.getElementById('RR'+repciIdToAdd);
																			var FotoPortada=DossierX.getElementsByClassName('portada')[0];
																			FotoPortada.src=Dc.base64img;
																			});
			}
		}
		setTimeout(function () {
						grid.refreshItems().layout();
						location.href="#myPage";//muestra la carpeta que esta en el tope del grid
					}, 500);
	}
	function randomNumber(){
		return (Math.floor(Math.random() * 13));
	}
	
	function removeG(obj,e){ //el pin hace la llamada al remove del bisabuelo
		var objToRemove=obj.parentElement.parentElement.parentElement;
		removeFromGrid(objToRemove);
		e.stopPropagation();
	}
	function removeFromGrid(objToRemove){
		grid.remove([objToRemove],{removeElements: true});
		//objToRemove.remove();
		setTimeout(function () {
						grid.refreshItems().layout();
						//grid.synchronize();
					}, 500);
					
	}
	
	function removeFromGridEvent(objToRemove,e){
		removeFromGrid(objToRemove);
		//objToRemove.innerHTML='';	
	}
	function ZoomInDcImage(){
		document.getElementById('DataClipFrame').contentWindow.fullImage();
		document.getElementById('DataClipFrame').contentWindow.fullPdf();
	}
	function ZoomInDcImageX(DcId){
		try{document.getElementById('DataClip' + DcId).querySelector('#DataClipFrameX').contentWindow.fullImage();}catch(e){}
		//try{document.getElementById('DataClip' + DcId).querySelector('#DataClipFrameX').contentWindow.fullPdf();}catch(e){}
	}
	function ZoomIn(){
		alert('ZoomIn');
	}
var ImageZoomed=false;
var ImageHeight=0
var ActiveImage=null;
function fullImage(){
	var slides = document.getElementsByClassName("RexEdSlides");
	for (var i = 0; i < slides.length; i++) {
		if (slides[i].style.display == "block"){
			ActiveImage=document.getElementById('Foto'+(i+1));
			break;
		}
  }
	if (ActiveImage){
		magnify(ActiveImage,3);
	}		
}
function trackmouse(event){
	if (ImageZoomed){
		var x = event.clientX;
		var y = event.clientY;
		ActiveImage.style.top = "-" + (ImageHeight-y)/400*y + "px";
		ActiveImage.style.left =  "-" + (x-75) +"px";
	}
}
var DcContentHeight=0;
function normalImage(){
	if (ActiveImage){	
		ActiveImage.style.left = '0px';
		ActiveImage.style.top = '0px';
		ActiveImage.style.width = '100%';
		ImageHeight=ActiveImage.height;
		ImageZoomed=false;
		ActiveImage=null;
	}
}
function magnify(img, zoom) {
	var lupa = $('.img-magnifier-glass');
	if (lupa.length){ // pasa de lupa a sin lupa
		lupa.remove();
		return;
	}
  var img, glass, w, h, bw;
  img = document.getElementById(img.id);
  /*create magnifier glass:*/
  glass = document.createElement("DIV");
  glass.setAttribute("class", "img-magnifier-glass");
  glass.style.width="100px";
  /*insert magnifier glass:*/
  img.parentElement.insertBefore(glass, img);
  /*set background properties for the magnifier glass:*/
  glass.style.backgroundImage = "url('" + img.src + "')";
  glass.style.backgroundRepeat = "no-repeat";
  glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";
  bw = 3;
  w = glass.offsetWidth / 2;
  h = glass.offsetHeight / 2;
  /*execute a function when someone moves the magnifier glass over the image:*/
  glass.addEventListener("mousemove", moveMagnifier);
  img.addEventListener("mousemove", moveMagnifier);
  /*and also for touch screens:*/
  glass.addEventListener("touchmove", moveMagnifier);
  img.addEventListener("touchmove", moveMagnifier);
  function moveMagnifier(e) {
    var pos, x, y;
    /*prevent any other actions that may occur when moving over the image*/
    e.preventDefault();
    /*get the cursor's x and y positions:*/
    pos = getCursorPos(e);
    x = pos.x;
    y = pos.y;
    /*prevent the magnifier glass from being positioned outside the image:*/
    if (x > img.width - (w / zoom)) {x = img.width - (w / zoom);}
    if (x < w / zoom) {x = w / zoom;}
    if (y > img.height - (h / zoom)) {y = img.height - (h / zoom);}
    if (y < h / zoom) {y = h / zoom;}
    /*set the position of the magnifier glass:*/
    glass.style.left = (x - w) + "px";
    glass.style.top = (y - h) + "px";
    /*display what the magnifier glass "sees":*/
    glass.style.backgroundPosition = "-" + ((x * zoom) - w + bw) + "px -" + ((y * zoom) - h + bw) + "px";
  }
  function getCursorPos(e) {
    var a, x = 0, y = 0;
    e = e || window.event;
    /*get the x and y positions of the image:*/
    a = img.getBoundingClientRect();
    /*calculate the cursor's x and y coordinates, relative to the image:*/
    x = e.pageX - a.left;
    y = e.pageY - a.top;
    /*consider any page scrolling:*/
    x = x - window.pageXOffset;
    y = y - window.pageYOffset;
    return {x : x, y : y};
  }
}	

async function AddDataClip(RexId){
	if (RexId<0){
		var dummy = await CheckSyncRexId(RexId);
		if (dummy)
			return;
	}
	CloseSideBarIfSize(1290);	
	document.getElementById('DataClipRexId').value = RexId;
	var RexGridDiv=document.getElementById('RR'+RexId);
	var Grupo = RexGridDiv.getAttribute('grupo');
	document.getElementById('ModalDataClips').style.display='block';
	app.LoadAllDcsGrupoJson(Grupo);
	
}

function ReText(DClips){
	var NewDClips=DClips;
	if (app.DataClips.length>0){
		if (DClips.length>0){
			for (var xx=0;xx<DClips.length;xx++){
				for (var yy=0;yy<app.DataClips.length;yy++){
					if (DClips[xx].text.trim().toUpperCase()==app.DataClips[yy].Code.toUpperCase()){
							NewDClips[xx].text=app.DataClips[yy].Desc;
						break;
					}
				}
			}		
		}
	}
	return NewDClips;
}

function DescDataDCCode(DcCode){
	for (var yy=0;yy<app.DataClips.length;yy++){
		if (DcCode.toUpperCase()==app.DataClips[yy].Code.toUpperCase()){
			return(app.DataClips[yy].Desc);	
			break;
		}
	}
	return (DcCode);
}

function convertImgToDataURLviaCanvas(urlx, callback) {
  var img = document.createElement("img");//new Image();
  img.crossOrigin = 'Anonymous';
  img.onload = function() {
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    var dataURL;
    canvas.height = this.height;
    canvas.width = this.width;
    ctx.drawImage(this, 0, 0);
    dataURL = canvas.toDataURL();
    callback(dataURL);
    canvas = null;
  };
  img.src = urlx;
}
 </script>
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/web-animations/2.3.1/web-animations.min.js'></script> -->
<script src='js/web-animations.min.js'></script>
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js'></script> -->
<script src='js/hammer.min.js'></script>
<!-- <script src='https://unpkg.com/muuri@0.6.3/dist/muuri.min.js'></script> -->
<script src='js/muuri.min.js'></script>
<script >
	var grid = new Muuri('.grid', {
	  dragEnabled: true,
	  layout: {
		fillGaps: true
	  }
	});

	// When all items have loaded refresh their
	// dimensions and layout the grid.
	window.addEventListener('load', function () {
	  grid.refreshItems().layout();
	  // For a little finishing touch, let's fade in
	  // the images after all them have loaded and
	  // they are corrertly positioned.
	  //document.body.classList.add('images-loaded');
	});
	
</script>
<!-- <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script> -->
<script src="js/markerclusterer.js"></script>
<!--Esta linea de abajo debe quitarsele el comentario para que se vean los mapas -->
<!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCFyo5bb1eTkA2aIo_O5nd1pJ5hRws3jk&callback=initialize" type="text/javascript"></script>  -->

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCFyo5bb1eTkA2aIo_O5nd1pJ5hRws3jk&callback=initialize" type="text/javascript"></script> 

<script>

var geocoder;
var map;
var initialLocation;
var browserSupportFlag =  new Boolean();
var RexMarkerArray = [];
var markerCluster=null;

function codeAddress() {
    var address = "Venezuela, " + document.getElementById("Estado").value + ', ' + document.getElementById("Ciudad").value + ', ' + document.getElementById("Sector").value;
    if (geocoder) {
      geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map, 
              position: results[0].geometry.location
          });

	        if (document.getElementById("Sector").value != "") {
			  map.setZoom(15); 
		}
		else 
		        if (document.getElementById("Ciudad").value != "") {
				  map.setZoom(10); 
			}
			else
			        if (document.getElementById("Estado").value != "") {
					  map.setZoom(8); 
				}


        } else {
          alert("Geocode no funciono por..: " + status);
        }
      });
    }
  }

var initialZoomLevel =  13 //debe ser el definitivo

function handleNoGeolocation(errorFlag) {
   initialLocation = new google.maps.LatLng(10.450922645609001,-66.885688393893); 
  
 if (errorFlag == true) {
    contentString = langtext[0].errorGeoLocation;
  } else {
    contentString = langtext[0].errorBrowserNoSupportGeoloc;
  }
  map.setCenter(initialLocation);
}
var infowindow = null;
  function initializemap() {
    geocoder = new google.maps.Geocoder();
    infowindow = new google.maps.InfoWindow();


	if(navigator.geolocation) {
    browserSupportFlag = true;
    navigator.geolocation.getCurrentPosition(function(position) {
      initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		map.setCenter(initialLocation);
		map.setZoom(initialZoomLevel);
      
    }, function() {
      handleNoGeolocation(browserSupportFlag);
    });
    var latlng = initialLocation;//new google.maps.LatLng(10.450922645609001,-66.885688393893); 
    var myOptions = { 
      zoom:13 , 
      zoomControl:true,
	  zoomControlOptions: {
      style:google.maps.ZoomControlStyle.SMALL
	  }
	  ,center: latlng,
      scaleControl: true,
	  
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };


    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    /*map.enableKeyDragZoom({
            visualEnabled: true,
            visualPosition: google.maps.ControlPosition.LEFT,
            visualPositionOffset: new google.maps.Size(35, 0),
            visualPositionIndex: null,
            visualSprite: "http://maps.gstatic.com/mapfiles/ftr/controls/dragzoom_btn.png",
            visualSize: new google.maps.Size(20, 20),
            visualTips: {
             off: "Turn on",
             on: "Turn off"
            }
         });
*/

    x=0;

var mcOptions = {maxZoom: 15};

var new_bounds;

// Try W3C Geolocation method (Preferred)
  if(navigator.geolocation) {
    browserSupportFlag = true;
    navigator.geolocation.getCurrentPosition(function(position) {
      initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
      //contentString = "Estas aqui segun el W3C standard";
	  
	//Mosca con traduccion con estas coordenadas

	var locationA = {
		latitude : 4.1752707095517310,
		longitude : -77.985236056250020
	};
	var locationB = {
		latitude : 14.736415374600460,
		longitude : -56.891486056250020
	};
	var sw = new google.maps.LatLng(locationA.latitude, locationA.longitude);
	var ne = new google.maps.LatLng(locationB.latitude, locationB.longitude);
	var bounds = new google.maps.LatLngBounds();
	bounds.extend(sw);
	bounds.extend(ne);
	map.fitBounds(bounds);
	map.setCenter(initialLocation);
	map.setZoom(initialZoomLevel);
	

	//map.setCenter(initialLocation);
    //map.setZoom(initialZoomLevel);
      //infowindow.setContent(contentString);
      //infowindow.setPosition(initialLocation);
      //infowindow.open(map);
    }, function() {
      handleNoGeolocation(browserSupportFlag);
    });
  } else if (google.gears) {
    // Try Google Gears Geolocation
    browserSupportFlag = true;
    var geo = google.gears.factory.create('beta.geolocation');
    geo.getCurrentPosition(function(position) {
      initialLocation = new google.maps.LatLng(position.latitude,position.longitude);
      contentString = "Location found using Google Gears";
      map.setCenter(initialLocation);
      map.setZoom(initialZoomLevel);
      infowindow.setContent(contentString);
      infowindow.setPosition(initialLocation);
      infowindow.open(map);
    }, function() {
      handleNoGeolocation(browserSupportFlag);
    });
  } else {
    // Browser doesn't support Geolocation
    browserSupportFlag = false;
    handleNoGeolocation(browserSupportFlag);
  }
//  markerCluster = new MarkerClusterer(map, RexMarkerArray,{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
  markerCluster = new MarkerClusterer(map, RexMarkerArray,{imagePath: 'drawable/m'});
  markerCluster.setMaxZoom(initialZoomLevel);
 } 
 }
/* function hideBusqueda(){
     app.busquedaColapsada=true;
// $("#BusquedaItem").css( "visibility","collapse");
 }
 function showBusqueda(){
 $("#BusquedaItem").css( "visibility","visible");
 }*/

</script>
<script>
var slideIndex = 1;
var DcIndex = 1;

function ActivateSlides(){
	$('#FotoSlides').css('display','block');
	$('#DcSlides').css('display','none');
	InitSlides();
}

function CargaDefault(image){
	var path=image.src;
	var SplitFilePath=path.split('path=');
	if (SplitFilePath.length==2){
		var InexistingFile=SplitFilePath[1];
		var Components = InexistingFile.split('-');
		var Grupo = Components[1];
		var NumGrupo=Grupo.substr(1, 40);
		//alert("DCImages/Default"+ NumGrupo * ".jpg");
		image.src="DCImages/Default"+ NumGrupo + ".jpg";
	}
}

function InitSlides(){
	slideIndex =1;			
	SetToolBoxImages();
	showSlides(slideIndex);
}
function plusSlides(n) {
  showSlides(slideIndex += n);
}

function currentSlide(n) {
  showSlides(slideIndex = n);
}

function rotateImgZero(){
	var img=document.getElementById('Foto'+slideIndex);
	img.setAttribute('style','transform:rotate(0deg)');
}

function rotateImgLeft(){
	var img=document.getElementById('Foto'+slideIndex);
	img.setAttribute('style','transform:rotate(270deg)');
}

function rotateImgRight(){
	var img=document.getElementById('Foto'+slideIndex);
	img.setAttribute('style','transform:rotate(90deg)');
}

function showSlides(n) {
	try{
		var lupa = $('.img-magnifier-glass');
		if (lupa.length){ // pasa de lupa a sin lupa
			lupa.remove();
		}
	}catch(e){
	}

	$('#DcSlides').css('display','none');
	$('#FotoSlides').css('display','block');
  var i;
  try{
	  rotateImgZero();
	  var slides = document.getElementsByClassName("RexEdSlides");
	  var dots = document.getElementsByClassName("rexeddot");
	  if (n > slides.length) {slideIndex = 1}    
	  if (n < 1) {slideIndex = slides.length}
	  for (i = 0; i < slides.length; i++) {
		  slides[i].style.display = "none";  
	  }
	  var showExtras=(slides.length>2);
	  for (i = 0; i < dots.length; i++) {
		dots[i].className = dots[i].className.replace(" rexedactive", "");
	  }
	  slides[slideIndex-1].style.display = "block"; 
	  
	  if (showExtras){
			dots[slideIndex-1].className += " rexedactive";
			$('.redexnumbertext').css('display','block');
			$('.rexedprev').css('display','block');
			$('.rexednext').css('display','block');
		}
		else{
			$('.redexnumbertext').css('display','none');
			$('.rexedprev').css('display','none');
			$('.rexednext').css('display','none');
		}
	}
	catch(e){}
}
function plusDc(n) {
  showDc(DcIndex += n);
}


function ActivaBotones(PrevDC,NextDC,OriginalDC,repcistatus){
	try{
		if (PrevDC != undefined && PrevDC != 0){ 
			//alert("Prev " + PrevDC);
			$('.rexedprevDc').css('display','block');
			document.getElementById('rexedprevDc').setAttribute( "onClick", "prevDC(" + PrevDC + ")" );
			//$('.rexedprevDc').click(prevDC(PrevDC));		
		}
		else{
			//alert("Prev " + 0);
			$('.rexedprevDc').css('display','none');
			//$('.rexedprevDc').click();
		}
		if (NextDC != undefined && NextDC != 0){
			//alert("Next "+ NextDC);
			$('.rexednextDc').css('display','block');
			document.getElementById('rexednextDc').setAttribute( "onClick", "nextDC(" + NextDC + ")" );
			//$('.rexednextDc').click(nextDC(NextDC));
		}
		else{
			//alert("Next " + 0);
			$('.rexednextDc').css('display','none');	
			//$('.rexednextDc').click();
		}
		var statusDC = document.getElementById("DataClipFrame").contentWindow.document.getElementById('statusDC').value;
		if (statusDC>="0"){
			document.getElementById("EditDCButt").style.display="inline"; // se puede editar 
			document.getElementById("SelloDCButt").style.display="inline"; // se puede editar 
				
		}
		else{
			document.getElementById("EditDCButt").style.display="none"; // no se puede editar 	
			document.getElementById("SelloDCButt").style.display="none"; // se puede editar 
			
				
		}
		if (OriginalDC == 0 || OriginalDC == undefined){ // si es una copia, no dejes que modifique o selle
			if (statusDC>="0"){
				document.getElementById("EditDCButt").style.display="inline"; // se puede editar 
				document.getElementById("SelloDCButt").style.display="inline"; // se puede editar 
			}
			else{
				document.getElementById("EditDCButt").style.display="none"; // no se puede editar 	
				document.getElementById("SelloDCButt").style.display="none"; // se puede editar 
			}		
		}
		else{
			document.getElementById("EditDCButt").style.display="none"; // no se puede editar 	
			document.getElementById("SelloDCButt").style.display="none"; // se puede editar 
		}
		if (repcistatus!="1"){ // si no esta activo el dc entonces....
			document.getElementById("EditDCButt").style.display="none"; // no se puede editar 	
			document.getElementById("SelloDCButt").style.display="none"; // se puede editar 
		}
	}
	catch(e){
		var text=0;
	}
}


function ActivaBotonesEnGrid(dcId,PrevDC,NextDC,OriginalDC,repcistatus,dcstatus){
	var DcDiv=document.getElementById('DC'+dcId);
	var RexId=DcDiv.getAttribute('RexId');
	try{
		if (PrevDC != undefined && PrevDC != 0){ 
			//$('.PrevDC').css('display','inline');
			var PrevButt=DcDiv.querySelector('.PrevDC');
			PrevButt.setAttribute( "onClick", "LoadDCinGrid(" + RexId + "," + dcId + "," + PrevDC + ",-1)" )
			PrevButt.style.display='inline';
		}
		else{
			var PrevButt=DcDiv.querySelector('.PrevDC');		
			PrevButt.style.display='none';
			//$('.PrevDC').css('display','none');
		}
		if (NextDC != undefined && NextDC != 0){
			//$('.NextDC').css('display','inline');
			var NextButt=DcDiv.querySelector('.NextDC');
			NextButt.setAttribute( "onClick", "LoadDCinGrid(" + RexId + "," + dcId + "," + NextDC + ",+1)" );
			NextButt.style.display='inline';
		}
		else{
			//$('.NextDC').css('display','none');
			var NextButt=DcDiv.querySelector('.NextDC');
			NextButt.style.display='none';
		}
		
		var statusDC = dcstatus;
		//DcDiv.querySelector(".zoomDC").setAttribute( "onClick", "ZoomInDcImageX("+ dcId + ")" ); 		
		
		if (statusDC>="0"){
			DcDiv.querySelector(".EditDC").style.display="inline"; // se puede editar 
			DcDiv.querySelector(".selloDC").style.display="inline"; // se puede editar 		
		}
		else{
			DcDiv.querySelector(".EditDC").style.display="none"; // no se puede editar 	
			//vericar si muestra el sello o no.
			DcDiv.querySelector(".selloDC").style.display="none"; // no se puede editar 		
		}
		if (OriginalDC == 0 || OriginalDC == undefined){ // si es una copia, no dejes que modifique o selle
			if (statusDC>="0"){
				DcDiv.querySelector(".EditDC").style.display="inline"; // se puede editar 
				DcDiv.querySelector(".selloDC").style.display="inline"; // se puede editar 		
			}
			else{
				DcDiv.querySelector(".EditDC").style.display="none"; // no se puede editar 	
				//vericar si muestra el sello o no.
				DcDiv.querySelector(".selloDC").style.display="none"; // no se puede editar 		
			}		
		}
		else{
			DcDiv.querySelector(".EditDC").style.display="none"; // no se puede editar 	
			//vericar si muestra el sello o no.
			DcDiv.querySelector(".selloDC").style.display="none"; // no se puede editar 		
		}
		if (repcistatus!="1"){ // si no esta activo el dc entonces....
			DcDiv.querySelector(".EditDC").style.display="none"; // no se puede editar 	
			//vericar si muestra el sello o no.
			DcDiv.querySelector(".selloDC").style.display="none"; // no se puede editar 		
		}
	}
	catch(e){
		var text=0;
	}
}
function prevDC(id) {
  app.$refs.ModalRex.ShowDC(id);
}
function nextDC(id) {
  app.$refs.ModalRex.ShowDC(id);
}

function LoadDCinGrid(RexId,Dcid,LoadID,gridoffset){
	if (gridoffset == -1)
		gridoffset = 0; 
	var GridItems=grid.getItems();
	for(var i=1;i<GridItems.length;i++){ // buscando el DC para poner el que viene justa detras de el.
		if (GridItems[i]._element.id==('DC'+Dcid)){
			var DCExist=document.getElementById('DC'+LoadID);
			removeFromGrid(DCExist); // borra el abuelo
			generateDCforGridItem(RexId,LoadID,i+gridoffset);		
			//ChangeDCid(Dcid,LoadID);
			return;
			
		}
	}	
}


function ChangeDCid(OldDcid,NewDcId){
	var DCExist=document.getElementById('DC'+OldDcid);
	//no borrarlo, cargar el nuevo Frame
	DCExist.id='DC'+NewDcId;
	var DataCLipExist=document.getElementById('DataClip'+OldDcid);
	DataCLipExist.id='DataClip'+NewDcId
	DataCLipExist.onmouseenter=function(){
			document.querySelectorAll('.rextools').forEach(function(el){el.style.display='none';});
			document.getElementById('DCTools'+NewDcId).style.display='block';
			document.getElementById('DCSelected'+NewDcId).style.display='block'
		};
	var closeDC=document.getElementById('closeDc'+OldDcid);
	closeDC.id='closeDc'+NewDcId;
	closeDC.onclick=function(){
					removeFromGridEvent(document.getElementById('DC'+NewDcId),event);
				};
	
	var DCToolsExist=document.getElementById('DCTools'+OldDcid);
	DCToolsExist.id='DCTools'+NewDcId;
	app.$refs.DcDets.getDcData(DcId).then(function () {
				grid.refreshItems().layout();
				var dcContent = app.$refs.DcDets.$el.innerHTML;
				var DcObj=app.$refs.DcDets.dcobj;
				if (DcObj.repciId==undefined || DcObj.repciId== '' || DcObj.repciId==0){
					//alert('viene limpia');
					app.$refs.DcDets.dcobj=null;
					app.$refs.DcDets.$forceUpdate();
					return; // es un dblclk disfrazado o una carrera critica
					}
				app.$refs.DcDets.CleanTemplate();
				app.$refs.DcDets.$forceUpdate();
				dcContent=dcContent.replace("id=\"linkcarpeta\"", "id=\"linkcarpeta\" onclick=\"app.$refs.DcDets.CargaCarpeta('"+RexId+"')\"" );

				foldercontent +=dcContent;
				 var itemTemplate = '' +
				  '<div class="item" id="DC' +DcId +'"  RexId="'+RexId+'" grupo="'+DcObj.grupo+'" height="490px" >' +
				  '<div class="item-content">' +
				  '<div  id="DataClip' +DcId +'" style="width:'+gridWidth+'px; height: 490px;"  onmouseenter="document.querySelectorAll(\'.rextools\').forEach(function(el){el.style.display=\'none\';});document.getElementById(\'DCTools'+DcId+'\').style.display=\'block\';document.getElementById(\'DCSelected'+DcId+'\').style.display=\'block\'" >' +
				  foldercontent +
				  '</div>' +
				  '</div>' +
				  '<div><a id="DCSelected'+DcId+'"  class="w3-container w3-display-left rextools" style="font-size:1.5em;display:none;" ><i onclick="SelectDC('+DcId+')" class="fa fa-check-circle" style="color:lightgrey;"></i></a></div>' +
				  '<div id="DCTools'+DcId+'" class="rextools w3-container w3-cell w3-bottom w3-center" style="font-size:1.3em;display:none;padding-right:20px;padding-bottom:16px;"><a class="PrevDC" title="'+langtext[0].PrevDC+'" style="padding-right:10px;display:none;"><i class="fa fa-arrow-circle-o-left tool-item" ></i></a><a class="EditDC" onclick="EditDC('+RexId+','+DcId+');" title="'+langtext[0].EditDC+'" style="padding-right:10px;display:none;"><i class="fa fa-pencil tool-item" ></i></a><img class="tool-item selloDC" src="assets/stamp.png" title="'+langtext[0].EditStatus+'" style="height: 1.3em;" onclick="Sello('+RexId+','+DcId+');" style="padding-right:10px"><a class="NextDC"  title="'+langtext[0].DCSaved+'" style="padding-left:10px;display:none;"><i class="fa fa-arrow-circle-o-right tool-item" ></i></a></div>' +
				  '</div>';
				  '</div>';
			  itemElem.innerHTML = itemTemplate;
			  grid.add([itemElem.firstChild],{index:offset});
			  setTimeout(function () {
								var tt=null;
								var offset=0;
								while((tt=document.getElementById('Dc'+DcId+'tuplas2' + offset))!=undefined){
									tt.innerHTML=app.$refs.DcDets.DetectDCLink(tt.innerHTML);
									offset++;
								}
								ActivaBotonesEnGrid(DcId,DcObj.PrevDC,DcObj.NextDC,DcObj.OriginalDC,DcObj.repcistatus,DcObj.status);
								grid.refreshItems().layout
								
								var DCExist=null;
								if (RexId<0)
									DCExist=document.getElementById('DC'+(-DcId));
								else
									DCExist=document.getElementById('DC'+DcId);
									
								var att = document.createAttribute("grupo");
								att.value = DcObj.grupo;
								DCExist.setAttribute(att);
								att = document.createAttribute("dctype");
								att.value = DcObj.DCType;
								DCExist.setAttribute(att);
								DCExist.scrollIntoView();
								DCExist.scrollIntoView(true);
								setTimeout(function () {
												window.scrollBy(0, -60);
											}, 500);	
								
								
								//grid.synchronize();
							}, 500);
			});
	
	
	
	//.getElementsByClassName('DCFrame')[0].src = "api/DCFrameV2.asp?usr="+app.userid+"&dcId="+NewDcId;
}

function getTuplasSelectedDcs(){
	var retArray=[];
	var GridItems=grid.getItems();
	var Tuplas =[];				
	for(var i=1;i<GridItems.length;i++){// buscando los DCs seleccionados
		try{
			if (GridItems[i]._element.getAttribute('selected')=="true"){
				Tuplas =[];
				//var DcTable=GridItems[i]._element.children[0].querySelector('#DataClipFrameX').contentDocument.getElementById('DcTable');
				var DcTable=GridItems[i]._element.children[0].querySelector('#DcTable');
				for (var ii=0; ii < DcTable.tBodies[0].children.length; ii++){
					var tr = DcTable.tBodies[0].children[ii];
					var rethead = tr.cells[0].innerText;
					var value1 = tr.cells[2].innerText; // mosca si el campo en el DataClip es un table, vienen mas values
					var dclink = '';
					var dcPos = tr.cells[2].innerHTML.indexOf('ShowDCinGridById');
					if (dcPos!=-1){
						dclink='dc'+tr.cells[2].innerHTML.substr(dcPos+16,tr.cells[2].innerHTML.indexOf(')',dcPos+16)-dcPos-15);
						value1=value1 + dclink;
					}
					Tuplas.push(
						{
							"rethead":rethead.replace(':',''), // el rethead viene con : para presentarlo bien. hay que quitarselo
							"value1":value1
						}
					)
				}
				retArray.push(Tuplas);
			}
		}catch(e){};
		
	}
	var ArrayTuplas=[];
	var ReturnArays=[];
	for (var yy=0;yy<retArray.length;yy++){
		for (var zz=0;zz<retArray[yy].length;zz++){
			if (!ArrayTuplas[retArray[yy][zz].rethead])
				ArrayTuplas[retArray[yy][zz].rethead] = [retArray[yy][zz].value1];
			else
				ArrayTuplas[retArray[yy][zz].rethead].push(retArray[yy][zz].value1);
		}
		ReturnArays.push(ArrayTuplas);
		ArrayTuplas=[]
	}
	return (ReturnArays);
}
			
			
function currentDc(n) {
  showDc(DcIndex = n);
}
function showDc(n) {
  var i;
  var Dcs = document.getElementsByClassName("RexEdDcs");
  var dots = document.getElementsByClassName("rexeddotDc");
  if (n > Dcs.length) {DcIndex = 1}    
  if (n < 1) {DcIndex = Dcs.length}
  for (i = 0; i < Dcs.length; i++) {
      Dcs[i].style.display = "none";  
  }
  for (i = 0; i < dots.length; i++) {
      dots[i].className = dots[i].className.replace(" rexedactive", "");
  }
  Dcs[DcIndex-1].style.display = "block";  
   var showExtras=(Dcs.length>2);
  if (showExtras){
		dots[DcIndex-1].className += " rexedactive";
		$('.redexnumbertext').css('display','block');
		$('.rexedprevDc').css('display','block');
		$('.rexednextDc').css('display','block');
	}
	else{
		$('.redexnumbertext').css('display','none');
		$('.rexedprevDc').css('display','none');
		$('.rexednextDc').css('display','none');
	}
}

function EditDC(RexId,DcId){
	document.getElementById('DataClipRexId').value = RexId;
	document.getElementById('DCWebId').value = DcId;
	app.$refs.ModalRex.EditDC(RexId,DcId);
}

function Sello(RexId,DcId){
	document.getElementById('DataClipRexId').value = RexId;
	document.getElementById('DCWebId').value = DcId;
	app.Sello(RexId,DcId);
}

</script>
<script> <!-- Map stuff -->

            
function JumpMarker (marker){
	marker.setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(function(){marker.setAnimation(null);}, 750);
}
function openInfoWindow (marker) {
  var markerTitle = marker.get("titulo");

  var Foto = marker.get("picfiles");
  var Fecha = app.formateaFecha(marker.get("when_date"));
  var creator = marker.get("creator");
  var aicon = "aicons/user-" + creator + ".jpg" ;
  var onerroricon = "aicons/default" + randomNumber() + ".png" ;
  var group = marker.get("grupo");
  var repciId = marker.get("repciId");
  
  var groupname = "";
  var drag=marker.get("drag");
  var offset=marker.get("offset");
  
	var dragMark = drag? '<span class="w3-display-bottomright" style="padding: 4px;right:14px;cursor:pointer;"><a onclick="rePositionMarker('+offset+');this.style.display = \'none\';"><h2><i class="fa fa-map-marker" ></i><i class="fa fa-frown-o" ></i></h2></a></span>': '';

        var contentString = '<div class ="infoWindowRex" >'+
						'<div class="infoWindowContainer">'+
							'<a onclick="WorkOnRex('+repciId+');" style="cursor:pointer;" ><img  id="infowindowIMG'+repciId+'" class="portada" style="max-width: 100%;" src="api/thumb.asp?path='+Foto[0] + '" alt="Cover" onerror="this.onerror=null;this.src=\'DCImages/default'+ group + '.jpg'+'\'"></a>'+
						'</div>'+
						'<h3 class="infoWindowTitulo" align="center">'+markerTitle+'</h3>'+
						'<p class="infoWindowVertical">'+ repciId +'</p>'+
						'<p class="infoWindowFecharex" >'+Fecha+'</p>'+
						'<img class="infoWindowRexicon" src="ricons/'+group+'.png" alt="icon" title="'+groupname+'">'+
						'<img class="infoWindowAuthoricon w3-circle" src="'+aicon+'" onerror="this.src=\''+onerroricon+'\'" alt="" :title="'+creator+'">'+
						dragMark+
						//'<div class="listcontainer" :items="rexobj.Dcs" ><ol><li v-for="Dc in rexobj.Dcs"><a href="#">{{Dc.text}}</a></li></ol></div>
					'</div>';	
	
	
  infowindow.setContent(contentString);
  infowindow.open(map, marker);
  if (repciId<0){
	db.DataClips.where('filename').equals(Foto[0]).first(function (Dc){
																var FotoPortada=document.getElementById('infowindowIMG'+repciId);
																FotoPortada.src=Dc.base64img;
																});
  }
}

function WorkOnRex(rexId){
	app.$refs.ModalRex.getRexData(rexId);
}

function CheckOnRex(rexid,obj){
		if (obj.className.includes("muuri-item-dragging")){
			obj.classList.remove("dragging");
		}
		else{
			WorkOnRex(rexId);
		}
}

function InitEditor(){
	document.getElementById('ModalRexEditor').style.display='block';
	w3_close();
	app.loadusersdadogrupo(app.$refs.ModalRex.rexobj.grupo);
	var ModEd=document.getElementById('ModalRexEditor');
	var dossier= ModEd.querySelector(".w3-col");
	var RexStatus=app.$refs.ModalRex.rexobj.status;
	try{
		dossier.classList.remove('rex');
		dossier.classList.remove('rexhistorico');
	if (RexStatus=='1')
		dossier.classList.add('rex');
	else
		if (RexStatus=='2')
			dossier.classList.add('rexhistorico');
	}
	catch(e){}	
	SetToolBoxImages();
	ActivateSlides();
}

function SetToolBoxImages(){
	try{
		var RexStatus=app.$refs.ModalRex.rexobj.status;
		var repciId = app.$refs.ModalRex.rexobj.repciId;
		var status=RexStatus;
		if (RexStatus=='1')
			document.getElementById('tools').innerHTML='<img class="tool-item" src="assets/reminder.png" title="'+langtext[0].Recordatorio+'" onclick="app.AgregaRecordatorio('+app.$refs.ModalRex.rexobj.repciId +')"><a onclick="app.AgregaCita('+app.$refs.ModalRex.rexobj.repciId +')" title="'+langtext[0].Cita+'"><i class="fa fa-calendar tool-item" ></i></a><a onclick="app.AgregaTarea('+app.$refs.ModalRex.rexobj.repciId +','+app.$refs.ModalRex.rexobj.grupo+');" title="'+langtext[0].AgregarTarea+'"><i class="fa fa-clipboard tool-item" ></i></a><a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><img class="tool-item" src="assets/rot-left.png" title="'+langtext[0].RotIzq+'" onclick="rotateImgLeft()"><img class="tool-item" src="assets/rot-right.png" title="'+langtext[0].RotDer+'" onclick="rotateImgRight()"><a onclick="fullImage();" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a onclick="AddDataClip('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarDC+'"><i class="fa fa-paperclip tool-item"></i></a><a onclick="app.AgregaAnexo('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarImg+'"><i class="fa fa-file tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>';
		if (RexStatus=='2')
			document.getElementById('tools').innerHTML='</i></a><a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><img class="tool-item" src="assets/rot-left.png" title="'+langtext[0].RotIzq+'" onclick="rotateImgLeft()"><img class="tool-item" src="assets/rot-right.png" title="'+langtext[0].RotDer+'" onclick="rotateImgRight()"><a onclick="fullImage();" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>';
	}
	catch(e){}
}
function SetToolBoxDataClips(){
	try{
		var RexStatus=app.$refs.ModalRex.rexobj.status;
		var repciId = app.$refs.ModalRex.rexobj.repciId;
		var status=RexStatus;
		
		if (RexStatus=='1')
			document.getElementById('tools').innerHTML='<img class="tool-item" src="assets/reminder.png" title="'+langtext[0].Recordatorio+'" onclick="app.AgregaRecordatorio('+app.$refs.ModalRex.rexobj.repciId +')"><a onclick="app.AgregaCita('+app.$refs.ModalRex.rexobj.repciId +')" title="'+langtext[0].Cita+'"><i class="fa fa-calendar tool-item" ></i></a><a onclick="app.AgregaTarea('+app.$refs.ModalRex.rexobj.repciId +','+app.$refs.ModalRex.rexobj.grupo+');" title="'+langtext[0].AgregarTarea+'"><i class="fa fa-clipboard tool-item" ></i></a><a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><a onclick="ZoomInDcImage()" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a onclick="AddDataClip('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarDC+'"><i class="fa fa-paperclip tool-item" ></i></a><a onclick="app.AgregaAnexo('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarImg+'"><i class="fa fa-file tool-item" ></i></a><a id="EditDCButt" onclick="EditDC(0,0);" title="'+langtext[0].EditDC+'"><i class="fa fa-pencil tool-item" ></i></a><img  id="SelloDCButt"  class="tool-item" src="assets/stamp.png" title="'+langtext[0].EditStatus+'" style="height: 1.3em;" onclick="Sello('+app.$refs.ModalRex.rexobj.repciId+','+app.$refs.ModalRex.ActiveDC+');"><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>'
		if (RexStatus=='2')
			document.getElementById('tools').innerHTML='<a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><a onclick="ZoomInDcImage()" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>'
	}
	catch(e){}
}
function SetToolBoxCarpetas(){
	try{
		var RexStatus=app.$refs.ModalRex.rexobj.status;
		var repciId = app.$refs.ModalRex.rexobj.repciId;
		var status=RexStatus;
		
		if (RexStatus=='1')
			document.getElementById('Carpeta_tools').innerHTML='<img class="tool-item" src="assets/reminder.png" title="'+langtext[0].Recordatorio+'" onclick="app.AgregaRecordatorio('+app.$refs.ModalRex.rexobj.repciId +')"><a onclick="app.AgregaCita('+app.$refs.ModalRex.rexobj.repciId +')" title="'+langtext[0].Cita+'"><i class="fa fa-calendar tool-item" ></i></a><a onclick="app.AgregaTarea('+app.$refs.ModalRex.rexobj.repciId +','+app.$refs.ModalRex.rexobj.grupo+');" title="'+langtext[0].AgregarTarea+'"><i class="fa fa-clipboard tool-item" ></i></a><a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><img class="tool-item" src="assets/rot-left.png" title="'+langtext[0].RotIzq+'" onclick="rotateImgLeft()"><img class="tool-item" src="assets/rot-right.png" title="'+langtext[0].RotDer+'" onclick="rotateImgRight()"><a onclick="fullImage();" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a onclick="AddDataClip('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarDCs+'"><i class="fa fa-paperclip tool-item"></i></a><a onclick="app.AgregaAnexo('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarImg+'"><i class="fa fa-file tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>';
		if (RexStatus=='2')
			document.getElementById('Carpeta_tools').innerHTML='<a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><img class="tool-item" src="assets/rot-left.png" title="'+langtext[0].RotIzq+'" onclick="rotateImgLeft()"><img class="tool-item" src="assets/rot-right.png" title="'+langtext[0].RotDer+'" onclick="rotateImgRight()"><a onclick="fullImage();" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a style="padding-right:10px" onclick="app.OtrasOps('+repciId+','+status+');" title="'+langtext[0].OtrasOps+'"><i class="fa fa-ellipsis-v tool-item" ></i></a>';
	}
	catch(e){}
		
}
function SetToolBoxDataClips_Grid(){
	try{
		document.getElementById('DCGrid_tools').innerHTML='<img class="tool-item" src="assets/reminder.png" title="'+langtext[0].Recordatorio+'" onclick="app.AgregaRecordatorio('+app.$refs.ModalRex.rexobj.repciId +')"><a onclick="app.AgregaCita('+app.$refs.ModalRex.rexobj.repciId +')" title="'+langtext[0].Cita+'"><i class="fa fa-calendar tool-item" ></i></a><a onclick="app.AgregaTarea('+app.$refs.ModalRex.rexobj.repciId +','+app.$refs.ModalRex.rexobj.grupo+');" title="'+langtext[0].AgregarTarea+'"><i class="fa fa-clipboard tool-item" ></i></a><a onclick="InitModalOrdenarDC()" title="'+langtext[0].OrdenarDCs+'"><i class="fa fa-list-ol tool-item" ></i></a><a onclick="ZoomInDcImage()" title="Zoom"><i class="fa fa-search-plus tool-item" ></i></a><a onclick="AddDataClip('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarDC+'"><i class="fa fa-paperclip tool-item" ></i></a><a onclick="app.AgregaAnexo('+app.$refs.ModalRex.rexobj.repciId +');" title="'+langtext[0].AgregarImg+'"><i class="fa fa-file tool-item" ></i></a><a id="EditDCButt" onclick="EditDC(0,0);" title="'+langtext[0].EditDC+'"><i class="fa fa-pencil tool-item" ></i></a><img id="SelloDCButt"  class="tool-item" src="assets/stamp.png" title="'+langtext[0].EditStatus+'" style="height: 1.3em;" onclick="Sello('+app.$refs.ModalRex.rexobj.repciId+','+app.$refs.ModalRex.ActiveDC+');">'
	}
	catch(e){
	}
}
function rePositionMarker(offset){
	var marker = RexMarkerArray[offset];
	var orgLat = RexMarkerArray[offset].get("orglat");
	var orgLong = RexMarkerArray[offset].get("orglong");
	
	var location = new google.maps.LatLng(orgLat,orgLong);

	marker.setPosition(location);
        marker.set("drag",false);
        app.CantMarkersDragged--;
}
function rePositionMarkerArray(){
    infowindow.close();
    for (var xx=0;xx<RexMarkerArray.length;xx++){
        var marker = RexMarkerArray[xx];
        var orgLat = RexMarkerArray[xx].get("orglat");
	var orgLong = RexMarkerArray[xx].get("orglong");	
	var location = new google.maps.LatLng(orgLat,orgLong);

	marker.setPosition(location);
        marker.set("drag",false);       
    }
    app.CantMarkersDragged=0;
    closeNav();//en el caso que sea llamado desde el menu responsive tipo celular
}
function findMarkerOffset(repciId){
	var RexxId = null;
	var rexFound = false;
	var Roffset = null;
	for(var xx=0;xx<RexMarkerArray.length;xx++){
		RexxId = RexMarkerArray[xx].get("repciId");
		if (rexFound=(repciId==RexxId)){
			Roffset=xx;
			break;
		}
	}
	return (Roffset);
}
function addMarkerToRexMarkerArray(location,image,r){						
	var marker = new google.maps.Marker({ 
			position: location,  
			map: map,
			icon: image,
			draggable: true,
			title: r.titulo,
			zIndex: RexMarkerArray.length
		});
	marker.set("offset", RexMarkerArray.length);
	if (r.id!=undefined)
		marker.set("repciId", -r.id);
	else
		marker.set("repciId", r.repciId);
	marker.set("grupo", r.grupo);
	marker.set("titulo", r.titulo);
	marker.set("when_date", r.when_date);
	marker.set("creator", r.creator);
	marker.set("picfiles", r.picfiles);
	//marker.set("picfiles", r.Images);
	marker.set("orglat",r.latitud);
	marker.set("orglong",r.longitud);

	marker.set("drag",false);
	
	marker.setMap(map);
	google.maps.event.addListener(marker, 'click', function() {
		openInfoWindow(this);
	});
	google.maps.event.addListener(marker, "dragend", function(){
		if(!marker.get("drag")) {// para que la cuenta de bien si haces drag varias veces sobre el mismo
			marker.set("drag",true);
			app.CantMarkersDragged++;
		}
	});
	RexMarkerArray.push(marker); // para poder borrarlos despues y agruparlos con cluster....
	markerCluster.addMarker(marker);
	marker.setPosition(location);// el usurio pudo hacer drag sobre este marker
	app.CantMarkers=RexMarkerArray.length;
	return (marker);
}
function TimelyOperationStarts(){
	$('#anigif').css('visibility', 'visible');
}
function TimelyOperationEnds(){
	$('#anigif').css('visibility', 'hidden');
}
function CleanMap() {
  markerCluster.clearMarkers();
  if (RexMarkerArray) {
    for (i in RexMarkerArray) {
      RexMarkerArray[i].setMap(null);
    }
    RexMarkerArray.length = 0;
	RexMarkerArray=[];
	app.CantMarkersDragged=0;
    app.CantMarkers=0;
  }
}

</script>
<script>
function insertAfter(newNode, referenceNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}

function successCamera(stream){
  // The success function receives an argument which points to the webcam stream
  var imgCam=document.getElementById("DCcamera");
  imgCam.style.display="inline";
 
}

function errorCamera(){
  var imgCam=document.getElementById("DCcamera");
  imgCam.style.display="none"; 
  //imgCam.src="";
}

var SelectedArray=[];		


async function newDCSelected(DataClip){
		CloseSideBarIfSize(600);
		longTimeAcceptDC(false);
		if (DataClip.tituloDC!=undefined)
			document.getElementById('retHeadTituloDC').value = DataClip.tituloDC;
		else
			document.getElementById('retHeadTituloDC').value = '';
					
		SelectedArray=getTuplasSelectedDcs(); // Dime si hay Dcs seleccionados		
		var OperDc = document.getElementById('operacionesDC');		
		var ImportButt = document.getElementById('ImportSelected');		 
		if (SelectedArray.length>0){		
			ImportButt.onclick=function(){		
					ArrayToDom(SelectedArray[0],document.getElementById('DCContainer'));		
				};		
			OperDc.style.display="block";		
		}		
		else{		
			OperDc.style.display="none";		
			ImportButt.onclick=null;		
		}		
		
		document.getElementById('DcFormContainer').scrollTop = 0;
		var JsonSelectedDC;
		var InputElem;
		JsonSelectedDC=DataClip;
		//CleanDCContainer();
		var container = document.getElementById("DCContainer");
		//clean dataclipeditor
		att = document.createAttribute("autosave");
		att.value = "false";
		if (JsonSelectedDC.AutoSave=='true'){
			att.value = "true";			
		}
		container.setAttributeNode(att);		
		while (container.firstChild) {
			container.removeChild(container.firstChild);
		}
		var offsetid=0;
		app.SelectedDC=DataClip.Code;
		att = document.createAttribute("required");
		
		checkIfCameraExists();
			
		/*if (navigator.getUserMedia) { 
		   navigator.getUserMedia({video:true}, successCamera, errorCamera);
		} else { 
		   errorCamera();
		}*/
		var imgCam=document.getElementById("DCCameraButt");
		if (JsonSelectedDC.fotostatus=="req"){
			imgCam.src="drawable/ic_action_camerareq.png";
			att.value = "true";
			imgCam.setAttributeNode(att);
		}
		else{
			imgCam.src="drawable/ic_action_camera.png";			
			att.value = "false";
			imgCam.setAttributeNode(att);
		}
		
		for (i=0;i<JsonSelectedDC.DcStructure.length;i++){
			InputElem = JsonSelectedDC.DcStructure[i];
			offsetid=await InsertField(InputElem,container,offsetid,"elem");
			offsetid++;
		}
		container.appendChild(document.createElement("br"));
		divCond = document.createElement("DIV");
		att = document.createAttribute("style");
		att.value = "display:none;";
		divCond.setAttributeNode(att); 
		att = document.createAttribute("id");
		att.value = "Conditionals";
		divCond.setAttributeNode(att); 		
		container.appendChild(divCond);
		att = document.createAttribute("id");
		att.value = "Conditionals";
		divCond.setAttributeNode(att); 		
		var LastOK = document.createElement("a");
		att = document.createAttribute("id");
		att.value = "DC_accept2";
		LastOK.setAttributeNode(att);
		att = document.createAttribute("onclick");
		att.value = "this.onclick=null;accept_DC('DCContainer');";
		LastOK.setAttributeNode(att);
		att = document.createAttribute("class");
		att.value = "w3-bar-item w3-button w3-right";
		LastOK.setAttributeNode(att);
		var ImageOK = document.createElement("img");
		att = document.createAttribute("src");
		att.value = "drawable/ic_action_accept.png";
		ImageOK.setAttributeNode(att);
		att = document.createAttribute("style");
		att.value = "height: 2.5em; width: auto;";
		ImageOK.setAttributeNode(att);
		LastOK.appendChild(ImageOK);
		container.appendChild(LastOK);
		SearchLock();
		//container.appendChild(document.createElement("hr"));		
		
	}
// OR ||
async function CondDCSelected(StringJson){
		var Conditionals = document.getElementById("Conditionals");
		Conditionals.style.display='block';
		//clean Conditionals
		while (Conditionals.firstChild) {
			Conditionals.removeChild(Conditionals.firstChild);
		}  
		var CondStructure=JSON.parse(StringJson);
		var offsetid = 0;
		for (i=0;i<CondStructure.length;i++){
			var InputElem = CondStructure[i];
			if (InputElem.type=="RadioVC"){
				break;//no es un concepto recursivo por ahora
			}
			
			offsetid=await InsertField(InputElem,Conditionals,offsetid,"condelem"); // en el caso de radio buttons o selects, se incrementa el offsetid en la funcion
			offsetid++;
		}
		Conditionals.appendChild(document.createElement("br"));
	}
	
async function bringCheckVals(Url){
	let response = await fetch(Url, {
	  headers: {
		'Accept': 'application/json, text/plain, */*',
		'Content-Type': 'application/json'
	  }
	});
	let res = await response.json();
	return res;
}	
	
async function InsertField(InputElem,container,offset,NameOfElements){
		var offsetid=offset;
		var isreq = "";
		//InputElem.style.display='';
		if (InputElem.req == "true"){
			isreq = "(Req)";
		}
		if (InputElem.type == "Edt" || InputElem.type == "EdtML" || InputElem.type == "EdtPR" || InputElem.type == "EdtAlert" || InputElem.type == "Int" || InputElem.type == "Num" || InputElem.type == "Telf" || InputElem.type == "Email" || InputElem.type == "ShortInt" || InputElem.type == "Date" || InputElem.type == "Time" || InputElem.type == "FingerPrintScan" ){
			var reqText = "";
			if (InputElem.req=="true")
				reqText = " *"
			var label = document.createTextNode(InputElem.desc + reqText);
			var labelelem = document.createElement("label");
			labelelem.appendChild(label);
			var att = document.createAttribute("for");
			att.value = NameOfElements + offsetid;
			labelelem.setAttributeNode(att); 
			att = document.createAttribute("class");
			att.value = "w3-text-custom";
			labelelem.setAttributeNode(att);
			
			var input = null;
			if (InputElem.type == "EdtML"){
				input = document.createElement("textarea");
				input.setAttribute('maxlength', 500);
				input.setAttribute('cols',20);
				input.setAttribute('rows', 5);
			}
			else
				input = document.createElement("input");
					
			att = document.createAttribute("class");
			if (InputElem.type == "EdtAlert"){
				att.value = "w3-input w3-border w3-red";
				//InputElem.style.display='none';
				if (InputElem.biometricpass=="true"){
					var att2 = document.createAttribute("biometricpass");
					att2.value = "true";
					input.setAttributeNode(att2);
				}
			}
			else
				att.value = "w3-input w3-border w3-light-grey";
			input.setAttributeNode(att); 

			att = document.createAttribute("placeholder");
			att.value = InputElem.desc;
			input.setAttributeNode(att); 

			att = document.createAttribute("id");
			att.value = NameOfElements + (offsetid);
			input.setAttributeNode(att); 

			att = document.createAttribute("dctype");
			att.value = InputElem.type;
			input.setAttributeNode(att); 
			
			if (InputElem.unique!=undefined){
				att = document.createAttribute("unique");
				att.value = InputElem.unique;
				input.setAttributeNode(att); 
			}
			
			att = document.createAttribute("DCgroup");
			att.value = "true";
			input.setAttributeNode(att); 

			att = document.createAttribute("rethead");
			att.value = InputElem.rethead;// + isreq; // ya que existe el atributo required, no es necesario agregar (Req), de paso es un fastidio para el RDS
			input.setAttributeNode(att); 

			att = document.createAttribute("name");
			att.value = InputElem.rethead;
			input.setAttributeNode(att); 
			if (InputElem.FingerPrintTemplate=='true'){
				att = document.createAttribute("FingerPrintTemplate");
				att.value = "true";
				input.setAttributeNode(att);
			}
			if (InputElem.type == "EdtPR" || InputElem.type == "EdtAlert" || InputElem.type == "FingerPrintScan" || InputElem.type == "DCLink"){ // no se pueden editar
				att = document.createAttribute("disabled");
				att.value = "true";
				input.setAttributeNode(att);
			}
			if (InputElem.type == "Int" ||InputElem.type == "ShortInt" || InputElem.type == "Num"){
				att = document.createAttribute("type");
				att.value = "number";
				input.setAttributeNode(att);
				if (InputElem.FingerPrintID=='true'){
					att = document.createAttribute("FingerPrintID");
					att.value = "true";
					input.setAttributeNode(att);
				}
			}

			if (InputElem.type == "FingerPrintScan"){
				att = document.createAttribute("type");
				att.value = "FPReg";
				input.setAttributeNode(att); 		
				input.style.width = "100%";
				input.style.display = "inline";
				
				var OperacionCoreBio = 'R'; // por default la operacion es registro
				if (InputElem.operacion!=undefined && InputElem.operacion=="delete")
					OperacionCoreBio = 'D';
				att = document.createAttribute("operacion");
				att.value = OperacionCoreBio;
				input.setAttributeNode(att); 		
				
				if (OperacionCoreBio=='R'){
					var tipof='V'; // por default is considered Visitor
					if (InputElem.supervisor != undefined && InputElem.supervisor == "true")
						tipof = 'S';
					att = document.createAttribute("tipoFP");
					att.value = tipof;
					input.setAttributeNode(att); 	
				}					
			}

			if (InputElem.type == "Telf"){
				att = document.createAttribute("type");
				att.value = "tel";
				input.setAttributeNode(att); 
			}
			if (InputElem.type == "Date"){
				att = document.createAttribute("type");
				att.value = "date";
				input.setAttributeNode(att); 
			}				
			if (InputElem.type == "Time"){
				att = document.createAttribute("type");
				att.value = "time";
				input.setAttributeNode(att); 
			}				
			if (InputElem.type == "Email"){
				att = document.createAttribute("type");
				att.value = "email";
				input.setAttributeNode(att); 
			}
			if (InputElem.req == "true") {
				att = document.createAttribute("required");
				//att.value = "";
				input.setAttributeNode(att); 
			}
			try{
				if (InputElem.value!=''){
					input.value=InputElem.value;
				}
			}
			catch(e){
			}
			if (InputElem.type == "Date" && InputElem.value == 'now'){
				var d=new Date();
				var nowdate = d.getFullYear() + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" + ("0"+d.getDate()).slice(-2);		
				input.value=nowdate;	
			}
			if (InputElem.type == "Time" && InputElem.value == 'now'){
				var d=new Date();
				var nowtime = ("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);
				input.value=nowtime;
			}
			if (InputElem.type == "EdtAlert"){
				labelelem.style.display='none';
				input.style.display='none';
			}
			else
				if (InputElem.type == "FingerPrintScan"){
					input.style.display='inline';
				}
				else{
					labelelem.style.display='';
					input.style.display='';
				}
			container.appendChild(labelelem);
			container.appendChild(input);
		
				
			if (InputElem.Source!=null && InputElem.Source!=""){
				var Source = InputElem.Source;
				var TableField= Source.split(".");												
				if (TableField.length==3){
					DCSearch = TableField[0];
					Table=TableField[1];
					Field = TableField[2].replace('(Req)','');
					var Url= "api/SourceDC.asp?u="+app.userid+"&t="+Table+"&f="+Field+"&d="+DCSearch;
					if (DCSearch=='thisDossier'){
						var RexID = document.getElementById('DataClipRexId').value;
						Url = Url + '&r=' + RexID;//app.$refs.RexSelected.rexobj.repciId;
					}
					let response = await fetch(Url, {
					  headers: {
						'Accept': 'application/json, text/plain, */*',
						'Content-Type': 'application/json'
					  }
					})
					let res = await response.json();
					for (var key in res) {
						if (res.hasOwnProperty(key)) {
							var item = res[key];
							var val = item.desc;
							item.value=item.value.replace(/\/\/n/g,'\n'); //limpia los //n
							input.value = item.value.slice(0,item.value.indexOf('dc(')-1);																
						}
					}				
				}									
			}
				
				////////////////////////////////////////////
				
				
		}
		else{
			if (InputElem.type == "RadioV" || InputElem.type == "RadioVC" || InputElem.type == "Radio" || InputElem.type == "Check"){
				var listvalues = InputElem.value;
				var reqText = "";
				if (InputElem.req=="true")
					reqText = " *"
				var label = document.createTextNode(InputElem.desc + reqText);
				var labelelem = document.createElement("label");
				att = document.createAttribute("class");
				att.value = "w3-text-custom";
				labelelem.setAttributeNode(att);
				
				labelelem.appendChild(label);
				container.appendChild(labelelem);
				container.appendChild(document.createElement("br"));
				
				for (var x=0; x<listvalues.length; x++){
					var val = listvalues[x];
					var input = document.createElement("input");
					var att = document.createAttribute("type");
					if (InputElem.type == "Check")
						att.value = "checkbox";
					else
						att.value = "radio";
					input.setAttributeNode(att); 
					att = document.createAttribute("name");
					att.value = InputElem.rethead;
					input.setAttributeNode(att); 
					
					att = document.createAttribute("id");
					att.value = NameOfElements + (offsetid);
					input.setAttributeNode(att); 
					
					
					att = document.createAttribute("rethead");
					att.value = InputElem.rethead;// + isreq;
					input.setAttributeNode(att);
					att = document.createAttribute("placeholder");
					att.value = InputElem.desc;
					input.setAttributeNode(att);
					att = document.createAttribute("dctype");
					att.value = InputElem.type;
					input.setAttributeNode(att); 
					att = document.createAttribute("DCgroup");
					att.value = "true";
					input.setAttributeNode(att);				
					att = document.createAttribute("value");
					att.value = val.desc;
					input.setAttributeNode(att); 
					att = document.createAttribute("class");
					att.value = "w3-radio";
					input.setAttributeNode(att); 
					if (InputElem.req=="true"){
						att = document.createAttribute("required");
						input.setAttributeNode(att); 
					}

					if (InputElem.type == "RadioVC" ){
						att = document.createAttribute("CondStruct");
						att.value = JSON.stringify(val.DcStructure);
						input.setAttributeNode(att);
						input.onclick=function(){
							CondDCSelected(this.getAttribute("CondStruct"));
						}
					}
					var label = document.createTextNode(val.desc);
					input.style.marginLeft = "10px";
					container.appendChild(input);
					container.appendChild(label);
					if (InputElem.type != "Radio") 
						container.appendChild(document.createElement("br"));
				}
				try{
					if (InputElem.StartFile!=null && InputElem.StartFile!=""){
						var remotefilename="assets/json/" + InputElem.StartFile + ".json";
						$.ajax({
							url : remotefilename,
							type : 'GET',
							async: false,
							success: function(data) { 
									//alert(data);
									var JArray = JSON.parse(data); 
									for (var key in JArray) {
											if (JArray.hasOwnProperty(key)) {
												var item = JArray[key];
												var val = item.desc;
												
												var input = document.createElement("input");
												var att = document.createAttribute("type");
												if (InputElem.type == "Check")
													att.value = "checkbox";
												else
													att.value = "radio";
												input.setAttributeNode(att); 
												att = document.createAttribute("name");
												att.value = NameOfElements + offsetid++;
												input.setAttributeNode(att); 
												att = document.createAttribute("rethead");
												att.value = InputElem.rethead;// + isreq;
												input.setAttributeNode(att); 
												att = document.createAttribute("dctype");
												att.value = InputElem.type;
												input.setAttributeNode(att);
												att = document.createAttribute("placeholder");
												att.value = InputElem.desc;
												input.setAttributeNode(att);													
												att = document.createAttribute("DCgroup");
												att.value = "true";
												input.setAttributeNode(att); 
												
												att = document.createAttribute("value");
												att.value = val;
												input.setAttributeNode(att); 
												if (InputElem.req=="true"){
													att = document.createAttribute("required");
													input.setAttributeNode(att); 
												}
												var label = document.createTextNode(val);
												input.style.marginLeft = "10px";
												container.appendChild(input);
												container.appendChild(label);
												if (InputElem.type != "Radio") 
													container.appendChild(document.createElement("br"));													
											}
										}
								   },
							error: function() { alert(langtext[0].errorRDSRadioCheck); }
						});
					}
				}
				catch(err){
					alert (err.message);
				}
				if (InputElem.type == "Radio") 
					container.appendChild(document.createElement("br"));													
				//offsetid++;
				////Source de Radios y Checks
				if (InputElem.Source!=null && InputElem.Source!=""){
					var Source = InputElem.Source;
					var TableField= Source.split(".");												
					if (TableField.length==3){
						DCSearch = TableField[0];
						Table=TableField[1];
						Field = TableField[2].replace('(Req)','');
						var Url= "api/SourceDC.asp?u="+app.userid+"&t="+Table+"&f="+Field+"&d="+DCSearch;
						if (DCSearch=='thisDossier'){
							var RexID = document.getElementById('DataClipRexId').value;
							Url = Url + '&r=' + RexID;//app.$refs.RexSelected.rexobj.repciId;
						}
						var res = await bringCheckVals(Url);
						var checkArray = $("input[rethead="+InputElem.rethead+"]");
						if (checkArray.length==0){
							//debo crear los campos de este field con resaltada
							for (var key in res) {
								////////////////////
								var val = res[key];
								var inputR = document.createElement("input");
								var att = document.createAttribute("type");
								if (InputElem.type == "Check")
									att.value = "checkbox";
								else
									att.value = "radio";
								inputR.setAttributeNode(att); 
								att = document.createAttribute("name");
								att.value = InputElem.rethead;
								inputR.setAttributeNode(att);
								
								att = document.createAttribute("id");
								att.value = NameOfElements + (offsetid);
								inputR.setAttributeNode(att); 
								
								att = document.createAttribute("rethead");
								att.value = InputElem.rethead;// + isreq;
								inputR.setAttributeNode(att);
								att = document.createAttribute("placeholder");
								att.value = InputElem.desc;
								inputR.setAttributeNode(att);
								att = document.createAttribute("dctype");
								att.value = InputElem.type;
								inputR.setAttributeNode(att); 
								att = document.createAttribute("DCgroup");
								att.value = "true";
								inputR.setAttributeNode(att);				
								att = document.createAttribute("value");
								att.value = val.value;
								inputR.setAttributeNode(att); 
								att = document.createAttribute("class");
								att.value = "w3-radio";
								inputR.setAttributeNode(att); 
								if (InputElem.req=="true"){
									att = document.createAttribute("required");
									inputR.setAttributeNode(att); 
								}
								var label = document.createTextNode(val.desc);
								inputR.style.marginLeft = "10px";
								container.appendChild(inputR);
								container.appendChild(label);
								if (InputElem.type != "Radio") 
									container.appendChild(document.createElement("br"));
								////////////////////
							}
						}
						for (var key in res) {
							if (res.hasOwnProperty(key)) {
								var item = res[key];
								var val = item.desc;
								for (zz=0;zz<checkArray.length;zz++){
									var input =checkArray[zz];
									if (input.value==item.desc){
										//item.value=item.value.replace(/\/\/n/g,'\n'); //limpia los //n
										//input.value = item.value.slice(0,item.value.indexOf('dc(')-1);	
										input.checked=true;
									}
								}
							}
						}
										
									
					}									
				}
				
				
				
				////
			}
			else{
				if (InputElem.type == "RIF" || InputElem.type == "IDBANKVE" ){
					var reqText = "";
					if (InputElem.req=="true")
						reqText = " *"
					var label = document.createTextNode(InputElem.desc + reqText)
					var labelelem = document.createElement("label");
					labelelem.appendChild(label);
					container.appendChild(labelelem);
					container.appendChild(document.createElement("br"));
					var att = document.createAttribute("class");
					att.value = "w3-text-custom";
					labelelem.setAttributeNode(att);
		
					var RifDiv = document.createElement("div");
					att = document.createAttribute("type");
					att.value = "RIF";
					RifDiv.setAttributeNode(att); 
					if (InputElem.unique!=undefined){
						att = document.createAttribute("unique");
						att.value = InputElem.unique;
						RifDiv.setAttributeNode(att); 
					}
					att = document.createAttribute("name");
					att.value = InputElem.rethead;
					RifDiv.setAttributeNode(att); 
					att = document.createAttribute("rethead");
					att.value = InputElem.rethead;// + isreq;
					RifDiv.setAttributeNode(att); 
					att = document.createAttribute("placeholder");
					att.value = InputElem.desc;
					RifDiv.setAttributeNode(att);
					att = document.createAttribute("dctype");
					att.value = InputElem.type;
					RifDiv.setAttributeNode(att); 
					att = document.createAttribute("DCgroup");
					att.value = "true";
					RifDiv.setAttributeNode(att); 
					
					att = document.createAttribute("id");
					att.value = NameOfElements + offsetid;
					RifDiv.setAttributeNode(att); 
					if (InputElem.req=="true"){
						att = document.createAttribute("required");
						RifDiv.setAttributeNode(att); 
					}
					
					var selectList = document.createElement("select");
					selectList.id = "RIF1";
					selectList.style.width = "50px";
					
					RifDiv.appendChild(selectList);
					var option = document.createElement("option");
					option.value = "J";
					option.text = "J";
					selectList.appendChild(option);
					option = document.createElement("option");
					option.value = "V";
					option.text = "V";
					selectList.appendChild(option);
					option = document.createElement("option");
					option.value = "E";
					option.text = "E";
					selectList.appendChild(option);
					option = document.createElement("option");
					option.value = "G";
					option.text = "G";
					selectList.appendChild(option);
					if (InputElem.type == "IDBANKVE"){
						option = document.createElement("option");
						option.value = "R";
						option.text = "R";
						selectList.appendChild(option);
						option = document.createElement("option");
						option.value = "M";
						option.text = "M";
						selectList.appendChild(option);
					}
					var inputNums = document.createElement("input");
					inputNums.id = "RIF2";
					/*
					att = document.createAttribute("class");
					att.value = "w3-input";
					inputNums.setAttributeNode(att); 
					*/
					att = document.createAttribute("placeholder");
					att.value = "9999999";
					inputNums.setAttributeNode(att)
					inputNums.style.width="90px";
					att = document.createAttribute("type");
					att.value = "number";
					inputNums.setAttributeNode(att);
					inputNums.maxLength=8;
					RifDiv.appendChild(document.createTextNode("-"));
					RifDiv.appendChild(inputNums);						
					RifDiv.appendChild(document.createTextNode("-"));
					var inputDigit = document.createElement("input");
					inputDigit.id = "RIF3";
					/*
					att = document.createAttribute("class");
					att.value = "w3-input";
					inputDigit.setAttributeNode(att); 
					*/

					att = document.createAttribute("placeholder");
					att.value = "9";
					inputDigit.setAttributeNode(att)
					inputDigit.style.width="30px";
					att = document.createAttribute("type");
					att.value = "number";
					inputDigit.setAttributeNode(att);
					inputDigit.maxLength=1;
					RifDiv.appendChild(inputDigit);
					container.appendChild(RifDiv);						
				}
				else{
					if (InputElem.type == "Spin" || InputElem.type == "DCLink"){
						//container.appendChild(document.createTextNode(InputElem.rethead));
						var listvalues = InputElem.value;
						var reqText = "";
						if (InputElem.req=="true")
							reqText = " *"
						var input = document.createElement("label");
						var att = document.createAttribute("class");
						att.value = "w3-text-custom";
						input.setAttributeNode(att);

						input.value = InputElem.desc;
						input.appendChild(document.createTextNode(InputElem.desc + reqText));
						container.appendChild(input);
						container.appendChild(document.createElement("br"));
						var selectList = document.createElement("select");
						att = document.createAttribute("type");
						att.value = InputElem.type;
						att = document.createAttribute("class");
						att.value = "w3-input";
						selectList.setAttributeNode(att); 
						att = document.createAttribute("name");
						att.value = InputElem.rethead;
						selectList.setAttributeNode(att); 
						att = document.createAttribute("rethead");
						att.value = InputElem.rethead;// + isreq;
						selectList.setAttributeNode(att); 
						att = document.createAttribute("placeholder");
						att.value = InputElem.desc;
						selectList.setAttributeNode(att);
						att = document.createAttribute("dctype");
						att.value = InputElem.type;
						selectList.setAttributeNode(att); 
						att = document.createAttribute("DCgroup");
						att.value = "true";
						selectList.setAttributeNode(att); 
						selectList.id = NameOfElements + offsetid;
						if (InputElem.req=="true"){
							att = document.createAttribute("required");
							selectList.setAttributeNode(att); 
						}
						container.appendChild(selectList);
						if (InputElem.SourceOf!=null && InputElem.SourceOf !=""){
							att = document.createAttribute("SourceOf");
							att.value = InputElem.SourceOf;
							selectList.setAttributeNode(att);
							selectList.onchange=function(){RdsLoad(this.getAttribute('SourceOf'),this.options[this.selectedIndex].value);};
						}
						try{
							if (InputElem.StartFile!=null && InputElem.StartFile!=""){
								var remotefilename="assets/json/" + InputElem.StartFile + ".json";
								$.ajax({
									url : remotefilename,
									type : 'GET',
									async: false,
									success: function(data) { 
											//alert(data);
											var JArray = JSON.parse(data); 
											for (var key in JArray) {
													if (JArray.hasOwnProperty(key)) {
														var item = JArray[key];
														var val = item.desc;
														var opt = document.createElement("option");
														opt.value = item.value;
														opt.text = val;
														selectList.appendChild(opt);
														//alert(item.desc + "---" + item.value );
													}
												}
										   },
									error: function() { alert(langtext[0].errorGetJsonSpin); }
								});
							}
							if (InputElem.Source!=null && InputElem.Source!=""){
								if (InputElem.CopyToSource!=null && InputElem.CopyToSource=='true'){
									att = document.createAttribute("CopyToSource");
									att.value = 'true';
									selectList.setAttributeNode(att); 										
								}
								if (InputElem.SourceStatus!=null ){
									att = document.createAttribute("SourceStatus");
									att.value = InputElem.SourceStatus;
									selectList.setAttributeNode(att); 										
								}
								if (InputElem.SourceNotInThisDC!=null ){
									att = document.createAttribute("SourceNotInThisDC");
									att.value = InputElem.SourceNotInThisDC;
									selectList.setAttributeNode(att); 										
								}
								var Source = InputElem.Source;
								var TableField= Source.split(".");												
								if (TableField.length==3){
									DCSearch = TableField[0];
									Table=TableField[1];
									Field = TableField[2].replace('(Req)','');
									var Url= "api/SourceDC.asp?u="+app.userid+"&t="+Table+"&f="+Field+"&d="+DCSearch;
									if (InputElem.SourceStatus!=null){
										Url = Url + "&s=" + InputElem.SourceStatus;							
									}
									if (InputElem.SourceNotInThisDC!=null){
										Url = Url + "&nitdc=" + InputElem.SourceStatus +"&nitdct=" + app.SelectedDC + "&nitdcf=" + InputElem.rethead;							
									}
									if (DCSearch=='thisDossier'){
										var RexID = document.getElementById('DataClipRexId').value;
										Url = Url + '&r=' + RexID;//app.$refs.RexSelected.rexobj.repciId;
									}
									fetch(Url, {
									  headers: {
										'Accept': 'application/json, text/plain, */*',
										'Content-Type': 'application/json'
									  }
									}).then(res=>res.json())
											.then(res => {
													//if (InputElem.req=='false'){
													//		var opt = document.createElement("option");
													//		opt.value = "";
													//		opt.text = "";
													//		selectList.appendChild(opt);
													//}
													selectList.onchange=function(){RdsLoadDC(this.options[this.selectedIndex].value);};
													var val = "";
													var opt = document.createElement("option");
													opt.value = "";
													opt.text = langtext[0].Selecciona;
													//selectList.appendChild(opt); a peticion de Isa, no agregar Seleciona...
													for (var key in res) {
														if (res.hasOwnProperty(key)) {
															var item = res[key];
															var val = item.desc;
															var opt = document.createElement("option");
															opt.value = item.value;
															opt.text = val;
															selectList.appendChild(opt);
															if (selectList.getAttribute('valueToBe')==item.value){
																selectList.selectedIndex=selectList.length-1;
																//RdsLoadDC(selectList.options[selectList.selectedIndex].value);
															}																
														}
													}
													if (selectList.length==2){
														selectList.selectedIndex=1; //el primer elemento de la lista es "Selecicona..."
													}
													RdsLoadDC(selectList.options[selectList.selectedIndex].value);
													selectList.removeAttribute('valueToBe');
												});
								}									
							}
						}
						catch(err){
							alert (err.message);
						}
						
						for (var x=0; x<listvalues.length; x++){
							var val = listvalues[x].desc;
							var opt = document.createElement("option");
							opt.value = val;
							opt.text = val;
							selectList.appendChild(opt);
						}
					}	
					else{
						if (InputElem.type == "Txt"||InputElem.type  == "Url"){
							var label = document.createTextNode(InputElem.desc)
							var labelelem = document.createElement("label");
							labelelem.appendChild(label);
							container.appendChild(labelelem);
							//container.appendChild(document.createElement("br"));
						}
						else{
							if (InputElem.type == "Separator"){
								var input = document.createElement("HR");
								input.name = InputElem.rethead;
								att = document.createAttribute("rethead");
								att.value = InputElem.rethead + isreq;
								input.setAttributeNode(att); 
								att = document.createAttribute("name");
								att.value = InputElem.rethead;
								input.setAttributeNode(att); 
								att = document.createAttribute("dctype");
								att.value = InputElem.type;
								input.setAttributeNode(att); 
								att = document.createAttribute("DCgroup");
								att.value = "true";
								input.setAttributeNode(att); 
								att = document.createAttribute("value");
								att.value = InputElem.desc;
								input.setAttributeNode(att);
								
								var label = document.createTextNode(InputElem.desc);
								input.style.marginLeft = "10px";
								container.appendChild(input);
								input.style.borderTopStyle="1px solid #ff9800;"
								container.appendChild(label);
								//container.appendChild(document.createElement("br"));
							}
							else{
								if (InputElem.type == "SrcTxt"){
									var SearchDiv=document.createElement("div");
									att = document.createAttribute("class");
									att.value = "w3-input";
									SearchDiv.setAttributeNode(att);
									var reqText = "";
									if (InputElem.req=="true")
										reqText = " *"
									var label = document.createTextNode(InputElem.desc + reqText);
									var labelelem = document.createElement("label");
									labelelem.appendChild(label);
									var att = document.createAttribute("for");
									att.value = NameOfElements + offsetid;
									labelelem.setAttributeNode(att); 
									att = document.createAttribute("class");
									att.value = "w3-text-custom";
									labelelem.setAttributeNode(att);
									var input = document.createElement("input");
									att = document.createAttribute("class");
									att.value = "w3-border";
									input.setAttributeNode(att); 

									att = document.createAttribute("placeholder");
									att.value = InputElem.desc;
									input.setAttributeNode(att); 

									att = document.createAttribute("id");
									att.value = NameOfElements + offsetid;
									input.setAttributeNode(att); 

									att = document.createAttribute("dctype");
									att.value = InputElem.type;
									input.setAttributeNode(att); 

									att = document.createAttribute("DCgroup");
									att.value = "true";
									input.setAttributeNode(att); 

									att = document.createAttribute("rethead");
									att.value = InputElem.rethead + isreq;
									input.setAttributeNode(att); 

									att = document.createAttribute("name");
									att.value = InputElem.rethead;
									input.setAttributeNode(att); 
									input.style.width = "80%";
									att = document.createAttribute("type");
									att.value = "search";
									input.setAttributeNode(att);
									att = document.createAttribute("lockiffound");
									att.value = InputElem.lockiffound;
									input.setAttributeNode(att);
									if (InputElem.req == "true") {
										att = document.createAttribute("required");
										input.setAttributeNode(att); 
									}
									if (InputElem.typesearch == "exact") {
										att = document.createAttribute("typesearch");
										att.value = InputElem.typesearch;
										input.setAttributeNode(att); 
									}
									var SearchButton = document.createElement("button");
									SearchButton.innerHTML = '<i class="fa fa-search" style="padding: 4px"></i>';
									att = document.createAttribute("searchin");
									att.value = NameOfElements + offsetid;
									SearchButton.setAttributeNode(att);
									SearchDiv.appendChild(input);
									SearchDiv.appendChild(SearchButton);
									var SpinSearch = document.createElement("span");
									SpinSearch.innerHTML = '<i class="fa fa-spinner fa-spin" style="padding: 4px"></i>';
									att = document.createAttribute("id");
									att.value = 'Wait' + NameOfElements + offsetid;
									SpinSearch.setAttributeNode(att);
									SpinSearch.style.display='none';
									SearchDiv.appendChild(SpinSearch);
									SearchButton.addEventListener ("click", function(e) {
											e.preventDefault(); // Cancel the native event
											e.stopPropagation();//
											var searchin;
											if (e.target.tagName=='BUTTON'){ // le dio enter
												searchin = e.target.previousElementSibling;//document.getElementById(this.getAttribute("searchin"));
											}
											else{//le dio enter al texto
												searchin = e.target.parentElement.previousElementSibling;//document.getElementById(this.getAttribute("searchin"));
											}
											cleanDom(container,searchin.id);
											var waitobj=searchin.nextElementSibling.nextElementSibling;
											waitobj.style.display='';//el spin de que esta haciendo una operacion
											var user=app.userid;
											var s=searchin.value;
											var SearchRH=searchin.getAttribute("rethead");
											var ListSearch = SearchRH.split(","); // Puedes buscar en varias tablas o Dcs a la vez
											for (zz=0;zz<ListSearch.length;zz++){
												var TableField= ListSearch[zz].split(".");
												var Table=TableField[0];
												var Field = TableField[1];
												var DCSearch = '';	
												if (TableField.length==3){
													DCSearch = TableField[0];
													Table=TableField[1];
													Field = TableField[2].replace('(Req)','');
												}
												var typesearch='like';
												if (searchin.getAttribute('typesearch')=='exact')
													typesearch='exact'
												var Url= "api/rdsCF.php?u="+user+"&s="+s+"&t="+Table+"&f="+Field+"&d="+DCSearch+"&ts="+typesearch;
												if (Table=='HttpGet'){
													Url='';
													for (tt=1;tt<TableField.length-1;tt++){
														Url=Url+TableField[tt];
														if (tt<TableField.length-2){
															Url=Url+'.';
														}
													}
													Url='https://'+Url+s;
												}
												httpGetRdsdata(Url,container,waitobj);														
											}
											//alert("search " + searchin.value + " in " + searchin.getAttribute("rethead"));
										},false);
										input.addEventListener ('keypress', function (e) {
											if (e.keyCode === 13){
												e.preventDefault(); // Cancel the native event
												e.stopPropagation();//												
												//alert(e.target.value);
												var searchin=e.target;
												cleanDom(container,searchin.id);
												var waitobj=searchin.nextElementSibling.nextElementSibling;
												waitobj.style.display='';//el spin de que esta haciendo una operacion
												var user=app.userid;
												var s=searchin.value;
												var SearchRH=searchin.getAttribute("rethead");
												var ListSearch = SearchRH.split(","); // Puedes buscar en varias tablas o Dcs a la vez
												for (zz=0;zz<ListSearch.length;zz++){
													var TableField= ListSearch[zz].split(".");
													var Table=TableField[0];
													var Field = TableField[1];
													var DCSearch = '';	
													if (TableField.length==3){
														DCSearch = TableField[0];
														Table=TableField[1];
														Field = TableField[2].replace('(Req)','');
													}
													var typesearch='like';
													if (searchin.getAttribute('typesearch')=='exact')
														typesearch='exact'
													var Url= "api/rdsCF.php?u="+user+"&s="+s+"&t="+Table+"&f="+Field+"&d="+DCSearch+"&ts="+typesearch;
													if (Table=='HttpGet'){
														Url='';
														for (tt=1;tt<TableField.length-1;tt++){
															Url=Url+TableField[tt];
															if (tt<TableField.length-2){
																Url=Url+'.';
															}
														}
														Url='https://'+Url+s;
													}
														
													httpGetRdsdata(Url,container,waitobj);
														
												}
											}
										});
										
									container.appendChild(labelelem);
									container.appendChild(SearchDiv);
								}
								else{
									if (InputElem.type == "Table"){
										//container.appendChild(document.createTextNode(InputElem.rethead));
										var Tablevalues = InputElem.value;
										var ColHeads = InputElem.colheads;
										var reqText = "";
										if (InputElem.req=="true")
											reqText = " *"
										var input = document.createElement("label");
										input.value = InputElem.desc;
										input.appendChild(document.createTextNode(InputElem.desc + reqText));
										var att = document.createAttribute("class");
										att.value = "w3-text-custom";
										input.setAttributeNode(att);
										
										container.appendChild(input);
										container.appendChild(document.createElement("br"));
										var Table = document.createElement("Table");
										att = document.createAttribute("type");
										att.value = "Table";
										att = document.createAttribute("class");
										att.value = "w3-table w3-striped w3-border w3-hoverable w3-card-4 w3-tiny";
										Table.setAttributeNode(att); 
										att = document.createAttribute("name");
										att.value = InputElem.rethead;
										Table.setAttributeNode(att); 
										att = document.createAttribute("rethead");
										att.value = InputElem.rethead + isreq;
										Table.setAttributeNode(att); 
										att = document.createAttribute("dctype");
										att.value = InputElem.type;
										Table.setAttributeNode(att); 
										att = document.createAttribute("DCgroup");
										att.value = "true";
										Table.setAttributeNode(att); 
										Table.id = NameOfElements + offsetid;
										container.appendChild(Table);
										$('#'+Table.id).data('ColHeads',ColHeads);//guardar la estructura de ColHeads en caso de RDSLoad
										 var tblBody = document.createElement("tbody");

										if (ColHeads.length >0){
											 var row = document.createElement("tr");
											 var att = document.createAttribute("class");
												att.value = "w3-custom";
											 row.setAttributeNode(att); 
											for (var x=0; x<ColHeads.length; x++){
												var Coldesc = ColHeads[x].desc;
												var Colrethead = ColHeads[x].rethead;
												var Coltype = ColHeads[x].type;
												var cell = document.createElement("th");
												var cellText = document.createTextNode(Coldesc);
												cell.appendChild(cellText);
												row.appendChild(cell);
												tblBody.appendChild(row);
											}
										}
										for (var x=0; x<Tablevalues.length; x++){
											var row = document.createElement("tr");
											for (var y=0; y<ColHeads.length;y++){
												var cell = document.createElement("td");
												var Colrethead = ColHeads[y].rethead;
												var ColType = ColHeads[y].type;
												if (ColType=="Txt"){
													var cellText = document.createTextNode(eval('Tablevalues[x].'+Colrethead));
													cell.appendChild(cellText);
												}
												if (ColType=="Num"||ColType=="Int"||ColType == "ShortInt"||ColType == "Telf"||ColType == "Date"||ColType == "Time"||ColType == "Email"){
													var input = document.createElement("input");
													att = document.createAttribute("class");
													att.value = "w3-input w3-border w3-light-grey";
													input.setAttributeNode(att); 
													input.value=eval('Tablevalues[x].'+Colrethead);

													if (ColType == "Int" ||ColType == "ShortInt" || ColType == "Num"){
														att = document.createAttribute("type");
														att.value = "number";
														input.setAttributeNode(att); 
													}
													if (ColType == "Telf"){
														att = document.createAttribute("type");
														att.value = "tel";
														input.setAttributeNode(att); 
													}
													if (ColType == "Date"){
														att = document.createAttribute("type");
														att.value = "date";
														input.setAttributeNode(att); 
													}				
													if (ColType == "Time"){
														att = document.createAttribute("type");
														att.value = "time";
														input.setAttributeNode(att); 
													}				
													if (ColType == "Email"){
														att = document.createAttribute("type");
														att.value = "email";
														input.setAttributeNode(att); 
													}	
													cell.appendChild(input);
												}
												row.appendChild(cell);
											}
											tblBody.appendChild(row);												
										}
										Table.appendChild(tblBody);
									}
									else{
										var label = document.createTextNode(InputElem.desc)
										var labelelem = document.createElement("label");
										labelelem.appendChild(label);
										container.appendChild(labelelem);
										//container.appendChild(document.createElement("br"));
									}
								}		
							}
						}
					}
				}
			}
		}
		return offsetid;// en caso de que cambie
	}
	
	function RdsLoad(SourceOf,RemoteJsonFile){
    var remotefilename="assets/json/" + RemoteJsonFile + ".json";
    
    var Dest = document.getElementsByName(SourceOf); 
	if (Dest[0].getAttribute('dctype')=='Spin' || Dest[0].getAttribute('dctype')=='DCLink' ){
		try{
			Dest[0].innerHTML = "";
		}
		catch(err){}
	}
	if (Dest[0].getAttribute('dctype')=='Table'){
		try{
			for (var xx=1;xx<Dest[0].rows.length;x++)
				Dest[0].deleteRow(1);
		}
		catch(err){}
	}
    $.ajax({
        url : remotefilename,
        type : 'GET',
        async: false,
        success: function(data) { 
                //alert(data);
                var JArray = JSON.parse(data); 
				if (Dest[0].getAttribute('dctype')=='Spin' || Dest[0].getAttribute('dctype')=='DCLink' ){		
					for (var key in JArray) {
						if (JArray.hasOwnProperty(key)) {
							var item = JArray[key];
							var val = item.desc;
							var opt = document.createElement("option");
							opt.value = item.value;
							opt.text = val;
							Dest[0].appendChild(opt);
							//alert(item.desc + "---" + item.value );
						}
					}
				}
				if (Dest[0].getAttribute('dctype')=='Table'){
					var ColHeads = $('#'+Dest[0].id).data('ColHeads');		
					var tblBody=Dest[0].tBodies[0];
					for (var x=0; x<JArray.length; x++){
						var row = document.createElement("tr");
						for (var y=0; y<ColHeads.length;y++){
							var cell = document.createElement("td");
							var Colrethead = ColHeads[y].rethead;
							var ColType = ColHeads[y].type;
							if (ColType=="Txt"){
								var cellText = document.createTextNode(eval('JArray[x].'+Colrethead));
								cell.appendChild(cellText);
							}
							if (ColType == "Url"){
								var a = document.createElement('a');
								var linkText = document.createTextNode(eval('JArray[x].'+Colrethead));
								a.appendChild(linkText);
								a.href = JArray[x].url;
								cell.appendChild(a);
							}
							if (ColType=="Num"||ColType=="Int"||ColType == "ShortInt"||ColType == "Telf"||ColType == "Date"||ColType == "Time"||ColType == "Email"){
								var input = document.createElement("input");
								att = document.createAttribute("class");
								att.value = "w3-input w3-border w3-light-grey";
								input.setAttributeNode(att); 
								input.value=eval('JArray[x].'+Colrethead);
									
								if (ColType == "Int" ||ColType == "ShortInt" || ColType == "Num"){
									att = document.createAttribute("type");
									att.value = "number";
									input.setAttributeNode(att); 
								}
								if (ColType == "Telf"){
									att = document.createAttribute("type");
									att.value = "tel";
									input.setAttributeNode(att); 
								}
								if (ColType == "Date"){
									att = document.createAttribute("type");
									att.value = "date";
									input.setAttributeNode(att); 
								}				
								if (ColType == "Time"){
									att = document.createAttribute("type");
									att.value = "time";
									input.setAttributeNode(att); 
								}				
								if (ColType == "Email"){
									att = document.createAttribute("type");
									att.value = "email";
									input.setAttributeNode(att); 
								}	
								cell.appendChild(input);
							}
							row.appendChild(cell);
						}
						tblBody.appendChild(row);											
					}
					Dest[0].appendChild(tblBody);
				}
		
               },
        error: function() { alert(langtext[0].errorGetAssetsJson); }
    });
    
	}
	
function RdsLoadDC(dcRef){
	var container = document.getElementById("DCContainer");
	var RexDc=getDC_Rex(dcRef)
	var DcId=RexDc[0];
	if (isNaN(DcId))
		return;
	
	var RexId =RexDc[1];
	$.ajax({
        url : 'api/rdsCF.php?u='+app.userid+'&d=dc&t=Vacuna&dcid=' +DcId,
        type : 'GET',
        async: false,
        success: function(data) {
				if (data.length==0){
					alert(langtext[0].NotFound);
					return null;
				}
				JsonToDom(data,container);
				container = document.getElementById("Conditionals");
				if (container.style.display=='block'){
					JsonToDom(data,container);				
				}
                return data;
               },
        error: function() { alert(langtext[0].errorRds); return null; }
    }); 
	}
	
	function httpGetRdsdata(theUrl,DomContainer,wait)
	{
		SearchLock();
		$.ajax({
        url : theUrl,
        type : 'GET',
        async: false,
        success: function(data) {
				if (data.length==0){
					//alert('No se encontro');
					SearchLockIfFound();
					setTimeout(function () {							
						wait.style.display='none';
					}, 500);
					return null;
				}
				document.getElementById('DCImage').src="";
				if (data[0].DCFoto!=undefined)
					if (data[0].DCFoto!='')
						ShowRdsImage(data[0].DCFoto);
					if (data[0].DCFotobase64!='')
						ShowRdsImagebase64(data[0].DCFotobase64);					
				JsonToDom(data,DomContainer);
				SearchLockIfFound();
				
				setTimeout(function () {							
					wait.style.display='none';
				}, 1000);		
                return data;
                //var JArray = JSON.parse(data); 
               },
        error: function(err) { 
							setTimeout(function () {							
								wait.style.display='none';
								SearchLockIfFound(); // puedes editar los campos que estan en lockiffound
							}, 500); 
							return null; 
						  }
		});
	}
	function isArray(what) {
		return Object.prototype.toString.call(what) === '[object Array]';
	}
	
	function JsonToDom(JsonStr,Domcontainer){
		var obj = JsonStr[0];
		var visitado=[];
		for (var key in obj){
			var attrName = key;
			var attrValue = obj[key];
			for (var xx=0;xx<Domcontainer.children.length;xx++){
				if (attrName==Domcontainer.children[xx].getAttribute("rethead")){
					var DCType = Domcontainer.children[xx].getAttribute("DCType");
					
					if (DCType!=null){
						switch (DCType){
							case 'EdtAlert':
								if (attrValue!=''){
									Domcontainer.children[xx].style.display='';
									try{
										Domcontainer.children[xx-1].style.display='';
									}catch(error){}
									//if (Domcontainer.children[xx].getAttribute("biometricpass")=="true")
									//	alert('Aprobacion de seguridad necesaria');									
								}
							case 'Edt':
							case 'EdtPR':
							case 'EdtML':
							case 'Num':
							case 'Int':
							case 'ShortInt':
							case 'Email':
							case 'Date':
							case 'Time':
							case 'Telf':
							//case 'FingerPrintScan': //No deberia de traerse el FingerPrintScan previo
								attrValue=attrValue.replace(/\/\/n/g,'\n'); 
								Domcontainer.children[xx].value=CleanDCLink(attrValue);
								Domcontainer.children[xx].title=Domcontainer.children[xx].value;
								break;
							case 'RIF':
							case 'IDBANKVE':
								var RifArr=attrValue.split('-');
								document.getElementById('RIF1').value=RifArr[0];
								document.getElementById('RIF2').value=RifArr[1];
								document.getElementById('RIF3').value=RifArr[2];
								break;
							case 'DCLink':
								var SelectList = Domcontainer.children[xx];
								var val = attrValue[0];
								var opt = document.createElement("option");
								opt.value = val;
								opt.text = CleanDCLink(val);
								SelectList.appendChild(opt);
								Domcontainer.children[xx].value=attrValue[0];
								break;
							case 'Spin':
								//Domcontainer.children[xx].value=attrValue;
								for (var mm=0;mm<Domcontainer.children[xx].options.length;mm++){
									var testObj = Domcontainer.children[xx].options[mm].value;
									if (testObj.slice(0,testObj.indexOf('dc(')-1)!=''){
										if (testObj.slice(0,testObj.indexOf('dc(')-1)==attrValue){
											Domcontainer.children[xx].value=testObj;
											break;
										}
									}
									else{
										if (testObj==attrValue){
											Domcontainer.children[xx].value=testObj;
											break;
										}
									}
								}
								break;
							case 'RadioV':
							case 'RadioVC':
							case 'Radio':
								if (Domcontainer.children[xx].value==attrValue){
									Domcontainer.children[xx].checked=true;
									Domcontainer.children[xx].click();
									if (DCType=='RadioVC'){
										CondDCSelected(Domcontainer.children[xx].getAttribute("CondStruct"));
										var CondContainer = document.getElementById("Conditionals");
										//var TuplasCond = Tuplas.slice(xx+1,CondContainer.children.length);
										JsonToDom(JsonStr,CondContainer);
									}
								}
								break;
							case 'Check':
								//limpia los valores actuales
								if (visitado.indexOf(attrName)==-1){ // para que lo haga una sola vez
									$("input[rethead="+attrName+"]:checked").prop('checked',false); 
									if (Array.isArray(attrValue)){
										var ArrayChecks=$("input[rethead="+attrName+"]");
										for (var xx2=0; xx2< ArrayChecks.length;xx2++){	
											for (var yy=0; yy< attrValue.length;yy++){
												if (CleanDCLink(ArrayChecks[xx2].value)==CleanDCLink(attrValue[yy]))
													ArrayChecks[xx2].checked=true;
											}
										}
									}
									else
										if (Domcontainer.children[xx].value==attrValue){
											Domcontainer.children[xx].checked=true;	
										}
									visitado.push(attrName);
								}
								break;
							case 'Table':
								break;
						}
					}
					//if (DCType!='Check')
					//	break;
				}
			}
			//alert(attrName + ':' + attrValue);
		}
	}
	
	function ArrayToDom(Tuplas,Domcontainer){
		for (var key in Tuplas){
			var attrName = key;
			try{
				if (attrName.slice(attrName.length-5,attrName.length)=='(Req)')
					attrName = attrName.slice(0,attrName.length-5);
			}
			catch(e){}
			var attrValue = Tuplas[key];
			for (var xx=0;xx<Domcontainer.children.length;xx++){
				var Req='';
				if (attrName==Domcontainer.children[xx].getAttribute("rethead") || (attrName+'(Req)')==Domcontainer.children[xx].getAttribute("rethead")){ // en caso de que alguien cambie un campo de requerido a no requerido
					var DCType = Domcontainer.children[xx].getAttribute("DCType");
					
					if (DCType!=null){
						switch (DCType){
							case 'EdtML':								
							case 'Edt':
							case 'EdtPR':
							case 'EdtAlert':
							case 'Num':
							case 'Int':
							case 'ShortInt':
							case 'Email':
							case 'Date':
							case 'Time':
							case 'Telf':
							case 'FingerPrintScan':
								attrValue[0]=attrValue[0].replace(/\/\/n/g,'\n'); 
								Domcontainer.children[xx].value=CleanDCLink(attrValue[0]);
								break;
							case 'RIF':
							case 'IDBANKVE':
								var RifArr=attrValue[0].split('-');
								document.getElementById('RIF1').value=RifArr[0];
								document.getElementById('RIF2').value=RifArr[1];
								document.getElementById('RIF3').value=RifArr[2];
								break;
								
							case 'DCLink':
								var SelectList = Domcontainer.children[xx];
								var val = attrValue[0];
								var opt = document.createElement("option");
								opt.value = val;
								opt.text = CleanDCLink(val);
								SelectList.appendChild(opt);
								Domcontainer.children[xx].value=attrValue[0];
								break;
							case 'Spin':
								Domcontainer.children[xx].value=attrValue[0];
								if (Domcontainer.children[xx].length==0){//esta vacio
									Domcontainer.children[xx].setAttribute("valueToBe", attrValue[0]);
								}
								break;
							case 'RadioV':
							case 'RadioVC':
							case 'Radio':
							case 'Check':
								for (var val in attrValue){
									if (CleanDCLink(Domcontainer.children[xx].value)==CleanDCLink(attrValue[val])){
										Domcontainer.children[xx].checked=true;
										
										if (DCType=='RadioVC'){
											CondDCSelected(Domcontainer.children[xx].getAttribute("CondStruct"));
											var CondContainer = document.getElementById("Conditionals");
											//var TuplasCond = Tuplas.slice(xx+1,CondContainer.children.length);
											ArrayToDom(Tuplas,CondContainer);
										}
									}
								}
								break;
							case 'Table':
								break;
						}
					}
					//if (DCType!='Check')
					//	break;
				}
			}
			//alert(attrName + ':' + attrValue);
		}
	}
	
function hideKeyboard() {
  //this set timeout needed for case when hideKeyborad
  //is called inside of 'onfocus' event handler
  setTimeout(function() {

    //creating temp field
    var field = document.createElement('input');
    field.setAttribute('type', 'text');
    //hiding temp field from peoples eyes
    //-webkit-user-modify is nessesary for Android 4.x
    field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
    document.body.appendChild(field);

    //adding onfocus event handler for out temp field
    field.onfocus = function(){
      //this timeout of 200ms is nessasary for Android 2.3.x
      setTimeout(function() {

        field.setAttribute('style', 'display:none;');
        setTimeout(function() {
          document.body.removeChild(field);
          document.body.focus();
        }, 14);

      }, 200);
    };
    //focusing it
    field.focus();

  }, 50);
}

var RexArrayTS = [];
var DCArrayTS = [];
var TuplasArrayTS = [];

async function SaveDcToServer(){ //esto est� aqui en caso de que estes en safari y no se puedan enviar mensajes de sincronizacin al service worker.
	var toktok='666123';
	RexArrayTS = [];
	DCArrayTS = [];
	TuplasArrayTS=[];
	
	//iOS safari, no soporta Promise.all nativamente, por eso el poco de awaits por todos lados
	
	await db.rexs.where("repciId").equals("").toArray(function(ra){RexArrayTS=ra;});
	await db.DataClips.where("repciId").below(0).toArray(function(dcs){DCArrayTS=dcs;});
	await db.Tuplas.where("idDC").below(0).toArray(function(tps){TuplasArrayTS=tps;});
	for (var rr=0;rr<RexArrayTS.length;rr++){
		if (RexArrayTS[rr].Dcs="undefined")
			RexArrayTS[rr].Dcs=[];
		for(var dd=0;dd<DCArrayTS.length;dd++){
			if (RexArrayTS[rr].id==-DCArrayTS[dd].repciId){
				RexArrayTS[rr].Dcs.push(DCArrayTS[dd]);
				var dcIndex = RexArrayTS[rr].Dcs.length - 1;
				if (RexArrayTS[rr].Dcs[dcIndex].Tuplas="undefined")
					RexArrayTS[rr].Dcs[dcIndex].Tuplas=[];
				for(var tt=0;tt<TuplasArrayTS.length;tt++){
					if (RexArrayTS[rr].Dcs[dcIndex].id==-(TuplasArrayTS[tt].idDC))
						RexArrayTS[rr].Dcs[dcIndex].Tuplas.push(TuplasArrayTS[tt]);					
				}
			}
		}
	}
	for (var rr=0;rr<RexArrayTS.length;rr++){
		if (RexArrayTS[rr].syncing==undefined || RexArrayTS[rr].syncing== false) {
			db.rexs.update(RexArrayTS[rr].id, {syncing: true,syncDateStart: new Date()});
			fetch('api/saveRex.php', {
			  method: 'POST',
			  headers: {
				'Accept': 'application/json, text/plain, */*',
				'Content-Type': 'application/json'
			  }
			  ,body: JSON.stringify(RexArrayTS[rr])
			}).then(res=>res.json())
					.then(res => {							
							 db.rexs.where('id').equals(res.LocalRexID).modify(function(rx){
													rx.repciId = res.repciID;
													rx.syncing = false;
													rx.syncDateEnd = new Date();
											}).then(function(){
												ActualizaUI();
											});
							 res.Dcs.map(dca=> {
											db.DataClips.where('id').equals(dca.LocalDcID).modify(function(dc){
													dc.DCWebId = dca.idDC;
													dc.base64img = ""; //libera el espacio de la foto, ya est� arriba.
												});
											db.Tuplas.where('idDC').equals(-(dca.LocalDcID)).modify(function(tup) {
													tup.idDC = dca.LocalDcID;
												});												
											});																				
						});
		}
	}
	console.log('Saving DC to server OK ')	
}
	
const parseJwt = (token) => {
  try {
    return JSON.parse(atob(token.split('.')[1]));
  } catch (e) {
    return null;
  }
};	
	

function getId(){
	return document.getElementById('FingerPrintId').value;
}

function setId(val){
	document.getElementById('FingerPrintId').value=val;
}

function setTemplate(val){
	document.getElementById('FingerPrintTemplate').value=val;
}

function setBase64Image(val){
	var DcImage=document.getElementById('DCImage');
	DcImage.src=val;
	document.getElementById('DCImage').style.display='block';
}


function ScanResults(Id,Template,Base64Image){
	if (Id!=getId()){
		alert(langtext[0].errorIdNotRespondigFP);
	}
	setTemplate(Template);
	setBase64Image(Base64Image);
	var Dcc=document.getElementById('DCContainer');
	var ImageSource=document.getElementById('ImgSource');
	ImageSource.value="FPS";
	var ArrayElements=Dcc.elements;
	for (var xx=0;xx<ArrayElements.length;xx++){
		if (ArrayElements[xx].getAttribute('FingerPrintTemplate')=='true'){
			ArrayElements[xx].value=Template;
			break;
		}
	}
	setId('');
	setTemplate('');
}

function ExpandChart(elem){
	var oldClase='';
	var newClase='';
	if (elem.parentElement.parentElement.parentElement.parentElement.classList.contains('w3-quarter')){
		oldClase='w3-quarter';
		newClase='w3-half';
	}
	if (elem.parentElement.parentElement.parentElement.parentElement.classList.contains('w3-half')){
		oldClase='w3-half';
		newClase='w3-threequarter';
	}
	elem.parentElement.parentElement.parentElement.parentElement.classList.remove(oldClase);
	elem.parentElement.parentElement.parentElement.parentElement.classList.add(newClase);
	app.DrawDashboard(1,true);
	app.DrawDashboard(2,true);
	app.DrawDashboard(3,true);
}

function ShrinkChart(elem){
	var oldClase='';
	var newClase='';
	if (elem.parentElement.parentElement.parentElement.parentElement.classList.contains('w3-threequarter')){
		oldClase='w3-threequarter';
		newClase='w3-half';
	}
	if (elem.parentElement.parentElement.parentElement.parentElement.classList.contains('w3-half')){
		oldClase='w3-half';
		newClase='w3-quarter';
	}
	elem.parentElement.parentElement.parentElement.parentElement.classList.add(newClase);
	elem.parentElement.parentElement.parentElement.parentElement.classList.remove(oldClase);
	app.DrawDashboard(1,true);
	app.DrawDashboard(2,true);
	app.DrawDashboard(3,true);
}

function SecurityDCFilter(RexToFilter,GrJson,SecPerfiles){
	if (GrJson.data.id==RexToFilter.grupo){
		var perfildeusuario='';
		for (xx=0;xx<SecPerfiles.length;xx++){
			if (SecPerfiles[xx].grupo==RexToFilter.grupo){
				perfildeusuario=SecPerfiles[xx].perfil;
				//alert('Perfil de usuario en grupo '+ RexToFilter.grupo + ' es ' + perfildeusuario);
				break;
			}
		}
		if (perfildeusuario==''){
			alert(langtext[0].errorNoProfileSet);
			return false;
		}
		for (xx=RexToFilter.Dcs.length-1;xx>=0;--xx){
			var DCTypeToFilter=RexToFilter.Dcs[xx].DCType;
			for (yy=0;yy<GrJson.data.logs[0].DCs.length;yy++){
				if (GrJson.data.logs[0].DCs[yy].Code.toUpperCase()==DCTypeToFilter.toUpperCase()){
					try{
						if (!GrJson.data.logs[0].DCs[yy].read.includes(perfildeusuario))
							RexToFilter.Dcs.splice(xx,1);
						}
						catch(e){}
					break;
				}
			}
			if (yy==GrJson.data.logs[0].DCs.length)//si no est� en los Dcs normales, verifica en Totales
				try{
					if (GrJson.data.Totales[0].DC==DCTypeToFilter){
						try{
							if (!GrJson.data.Totales[0].read.includes(perfildeusuario))
								RexToFilter.Dcs.splice(xx,1);
						}
						catch(e){}
					}	
				}
				catch(error) {
				  console.log(error);
				}

		}
	}
	else{
		//alert('Grupo not on sync');
		return false;
	}
	return RexToFilter;
}

function SecurityDCFilterList(Dcs,GrJson,SecPerfiles){
	var perfildeusuario='';
	for (xx=0;xx<SecPerfiles.length;xx++){
		if (SecPerfiles[xx].grupo==GrJson.data.id){
			perfildeusuario=SecPerfiles[xx].perfil;
			//alert('Perfil de usuario en grupo '+ RexToFilter.grupo + ' es ' + perfildeusuario);
			break;
		}
	}
	if (perfildeusuario==''){
		alert(langtext[0].errorNoProfileSet);
		return false;
	}
	for (xx=Dcs.length-1;xx>=0;--xx){
		var InArrayOrTotals = false;
		var DCTypeToFilter=Dcs[xx].Code;
		for (yy=0;yy<GrJson.data.logs[0].DCs.length;yy++){
			if (GrJson.data.logs[0].DCs[yy].Code.toUpperCase()==DCTypeToFilter.toUpperCase()){
				try{
					if (!GrJson.data.logs[0].DCs[yy].read.includes(perfildeusuario)){
						Dcs.splice(xx,1);
						InArrayOrTotals=true;
					}
				}
				catch(e){}
				break;
			}
		}
		if (yy==GrJson.data.logs[0].DCs.length)//si no est� en los Dcs normales, verifica en Totales
			try{
				if (GrJson.data.Totales[0].DC==DCTypeToFilter){
					try{
						if (!GrJson.data.Totales[0].read.includes(perfildeusuario)){
							Dcs.splice(xx,1);
							InArrayOrTotals=true;
						}
					}
					catch(e){}
				}
			}
			catch(error) {
				  console.log(error);
				}
		if (yy==GrJson.data.logs[0].DCs.length && !InArrayOrTotals){//si no est� en los Dcs normales, sacalo
			Dcs.splice(xx,1);		
		}
	}	
	return Dcs;
}

function ShowRdsImage(filepath){
	var Image=document.getElementById('DCImage');
	//var ImageSource=document.getElementById('ImgSource');
	Image.src="api/thumb.asp?path="+filepath;									
	Image.style.display="block";
	document.getElementById('ImgSource').value="";
	//PermiteBorrarImagen();
}

function ShowRdsImagebase64(ImageBase64){
	var Image=document.getElementById('DCImage');
	//var ImageSource=document.getElementById('ImgSource');
	Image.src=ImageBase64;									
	Image.style.display="block";
	document.getElementById('ImgSource').value="";
	//PermiteBorrarImagen();
}

function cleanDom(Domcontainer,apartirde){
	try{
		for (var xx=0;xx<Domcontainer.children.length;xx++){
			var DCType = Domcontainer.children[xx].getAttribute("DCType");		
			if (DCType!=null){
				if (parseInt(Domcontainer.children[xx].id.substr(4)) > parseInt(apartirde.substr(4))){ // 4 es porque todos comienzan con la palabra elem que tiene longitud 4
					switch (DCType){
						case 'EdtAlert':
							Domcontainer.children[xx].style.display='none';
							try{
								Domcontainer.children[xx-1].style.display='none';
							}catch(error){}				
						case 'Edt':
						case 'EdtPR':
						case 'EdtML':
						case 'Num':
						case 'Int':
						case 'ShortInt':
						case 'Email':
						case 'Date':
						case 'Time':
						case 'Telf':					 
							Domcontainer.children[xx].value='';
							break;
						case 'RIF':
						case 'IDBANKVE':
							document.getElementById('RIF1').value='';
							document.getElementById('RIF2').value='';
							document.getElementById('RIF3').value='';
							break;
						case 'DCLink':
							Domcontainer.children[xx].value='';
							break;
						case 'Spin':
							Domcontainer.children[xx].options[0].selected='selected';
							break;

						case 'RadioV':
						case 'RadioVC':
						case 'Radio':
						case 'Check':
							Domcontainer.children[xx].checked=false;
							break;
						case 'Table':
							break;
					}
				}
			}

		}
	}catch(e){}
}

function ResultFPOPText(opresult){
	switch (opresult) {
		case "0":
			return "OK";
			break;
		case "-1":
			return langtext[0].PorLic;
			break;
		case "-2":
			return langtext[0].NotReg;
			break;
		case "-3":
			return langtext[0].NoFPScanner;
			break;	
		case "-4":
			return langtext[0].errorCaptura;
			break;
		case "-5":
			return langtext[0].errorGeneralFP;
			break;
		case "-6":
			return langtext[0].errorCapturaImagenTemplate;
			break;
		case "-7":
			return langtext[0].errorBDConnect;
			break;
		case "-8":
			return langtext[0].noConnectNServer;
			break;
		case "-9":
			return langtext[0].FPCanceled;
			break;
		case "-10":
			return langtext[0].errorNserver;
			break;
		case "-11":
			return langtext[0].incorrectParameters;
			break;
		case "-12":
			return langtext[0].FPRegistrada;
			break;
		case "-13":
			return langtext[0].FPIdRegistrado;
			break;
		case "-14":
			return langtext[0].noRegistroDeFPEnNserver;
			break;
		}
	return langtext[0].unknownError;
}

function SearchLock(){
	var SrcObj = $('[dctype="SrcTxt"]')[0]; //mosca solo un SrcTxt por ahora
	if (SrcObj==undefined){
		return;
	}
	if (SrcObj.getAttribute('required')==null)
		return;
	var LockListStr=SrcObj.getAttribute('lockiffound');
	if (LockListStr==undefined)
		return;
	var LockArray = LockListStr.split(',');
	for (var ll=0;ll<LockArray.length;ll++){
		var LockObj=$('[rethead="'+LockArray[ll]+'"]');
		for (var lo=0;lo<LockObj.length;lo++){
			if (LockObj[lo]!=undefined)
				LockObj[lo].disabled=true;
		}		
	}
}

function SearchLockIfFound(){
	var SrcObj = $('[dctype="SrcTxt"]')[0]; //mosca solo un SrcTxt por ahora
	if (SrcObj==undefined){
		return;
	}
	var SearchValue = SrcObj.value;
	var SeachRethead = SrcObj.getAttribute('rethead').split(',')[0].split('.').pop();
	if (SrcObj.getAttribute('required')==null)
		return;
	var LockListStr=SrcObj.getAttribute('lockiffound');
	if (LockListStr==undefined)
		return;
	var LockArray = LockListStr.split(',');
	
	for (var ll=0;ll<LockArray.length;ll++){
		var LockObj=$('[rethead="'+LockArray[ll]+'"]');
		for (var lo=0;lo<LockObj.length;lo++){
			if (LockObj[lo]!=undefined){
				if (LockObj[lo].getAttribute('DcType')!='EdtPr' && LockObj[lo].getAttribute('DcType')!='FingerPrintScan')	// estos deben estar siempre disabled
					if (LockObj[lo].getAttribute('DcType')=='Radio' || LockObj[lo].getAttribute('DcType')=='RadioV' || LockObj[lo].getAttribute('DcType')=='RadioVC' )
						LockObj[lo].disabled= ($("input[rethead='"+LockArray[ll]+"']:checked").val()!=undefined);
					else
						LockObj[lo].disabled= (LockObj.val()!='');
			}
		}
	}
	// a poner lo que buscaste en el campo que solicitaste
	var BlkObj = $('[rethead="'+SeachRethead+'"]')[0]; 
	if (BlkObj.value=='')
		BlkObj.value = SearchValue;
	BlkObj.disabled=true; // no lo puedes tocar
	
}
function BlockUnique(Container){
	for (var xx=0;xx<Container.children.length;xx++){
		if (Container.children[xx].getAttribute("unique")=='true'){
			Container.children[xx].disabled=true;
			break;//solo debe haber uno
		}
	}
}		

function loggout(confirma){
	if (confirma)
		if (!confirm(langtext[0].quieresLogout))
			return;
	grid.remove( grid.getItems(), {removeElements: true} );
	document.getElementById('Login_User').value='';
	document.getElementById('Login_PWD').value='';
	document.getElementById('splashscreen').style.display='block';
	document.getElementById('splashscreen').style.opacity="100";
	app.rexs= [];
	app.CantRexs=0;
	app.CantMarkersDragged=0;
	app.CantMarkers=0;
	app.users =[];
	app.chartusers= [];
	app.usersX =[];
	app.grupos =[];
	app.gruposChart= [];
	app.ShowGrupo= [];
	app.GrupoCounter=[];
	app.GrupoPerfil=[];
	app.Tareas=[];
	app.Recordatorios=[];
	app.Citas=[];
	app.Vencimientos=[];
	app.CantNoSyncs=0;
	//iconosgrupo: [],
	app.gruposelected= 0;
	app.grupochartselected= 0;
	app.nombreGrupo='';
	app.enTitulo='';
	app.usuarioselected='T';
	app.statusselected=1;
	app.usuarioschartselected='T';
	app.timeselected='0';
	app.RexSelected=null;
	app.TituloSelected='';
	app.UserName='';
	app.TextoChart='';
	app.userid='';
	app.token='';
	app.GrupoJson={};
	app.ChartJson={};
	app.Carpetas=[];
	app.CarpetaSeleccionada="T";
	app.ChartDCSeleccionado="T";
	app.ChartFieldSeleccionado="T";
	app.ChartDcs=[];
	app.CamposDcs=[];
	app.sellochartselected=0;
	app.selchartstatus="1";
	app.sellos=[];
	app.logs=[];
	app.DataClips=[];
	app.dateFormat='D MMM';
	app.inputDateOne='';
	app.inputDateTwo='';
	var otrodate=new Date();
	otrodate.setYear(otrodate.getFullYear()-1);
	app.buttonDateOne=otrodate;
	app.buttonDateTwo=new Date();
	app.buttonChartDateOne=new Date();
	app.buttonChartDateTwo='';
	app.inlineDateOne='';
	app.sundayDateOne='';
	app.sundayFirst=false;
	app.alignRight=false;
	app.trigger=false;
	app.busquedaColapsada=false;
	app.DetallesColapsados=true;
	app.DetallesChartColapsados=false;
	app.RexsColapsados=false;
	app.ChartColapsado=true;
	app.TipoGrafico=1;
	app.DashBoard1=1;
	app.DashBoard2=2;
	app.TipoChart='Bar';
	app.TipoChart1='Bar';
	app.TipoChart2='Pie';
	app.SelectedDC='';
	app.currentLongitud=0.0;
	app.currentLatitud=0.0;
	app.currentIP='';
	app.currentGPSOrigin='';
	app.Tuplas=[];
	app.showCols=[];
	app.SellosDisponibles=[];
	app.JWT='';
	app.CurrentRexStatus=0;
	app.RexStatus=0;
	app.CurrentTitle='';
	initRexs();
}
function CleanPwds(){
	document.getElementById('Login_PWDOrg').value='';
	document.getElementById('Login_PWD1').value='';
	document.getElementById('Login_PWD2').value='';
}

function printDiv(DivToPrint) { 
            var divContents = DivToPrint.innerHTML; 
			params  = 'width='+screen.width;
			 params += ', height='+screen.height;
			 params += ', top=0, left=0'
			 params += ', fullscreen="yes"';
			 params += ', directories=no';
			 params += ', location=no';
			 params += ', menubar=no';
			 params += ', resizable=no';
			 params += ', scrollbars=no';
			 params += ', status=no';
			 params += ', toolbar=no';
            var a = window.open('', '', params); 
            a.document.write('<html>'); 
			a.document.write('<link rel="stylesheet" href="assets/css/buscarexs.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/w3.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/w3-theme-black.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/font-awesome.min.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/buscarexs.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/rex.css">');
			a.document.write('<link rel="stylesheet" href="assets/css/dcdetails.css">');
			a.document.write('<style>.dccolumn {overflow:unset;border-style: none;border-color: lightgray;}</style>');
			a.document.write('<style>* {-webkit-print-color-adjust: exact !important;   /* Chrome, Safari */color-adjust: exact !important;/*Firefox*/}</style>');
            a.document.write('<body onload="document.getElementById(\'chart_div\').children[0].style.width=\'100%\';">'); 
			a.document.write('<div id="chart_div" style="width:100%;height:100%;border:none;overflow:none">'); 
			a.document.write(divContents); 
			a.document.write('</div>'); 
			a.document.write('</body></html>'); 
            a.document.close();
			setTimeout(function () {
				 a.print();
			}, 1000);
           
}

function linkify(inputText) {
    var replacedText, replacePattern1, replacePattern2, replacePattern3;

	var TextToLinkify = inputText;
	if (TextToLinkify.indexOf('//n')){
		TextToLinkify=TextToLinkify.replace(/\/\/n/g," "); //cambia los //n a espacios en blanco
	}

    //URLs starting with http://, https://, or ftp://
    //replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    replacePattern1 = /((https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    replacedText = TextToLinkify.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

    //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
    replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
    replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

    //Change email addresses to mailto:: links.
    replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
    //replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1" target="_blank">$1</a>');
	replacedText = replacedText.replace(replacePattern3, '<a onClick="javascript:window.open(\'mailto:$1\', \'mail\');event.preventDefault()" href="mailto:mail@domain.com" >$1</a>');

    return replacedText;
}

function ShowDCinLink(dcLink){
	dcLink.onclick = null;
	ShowDCinGrid(dcLink);
	setTimeout(	function(){
				dcLink.onclick = function(){
							ShowDCinLink(dcLink);			
						}}, 3000);	
}
</script>
<script src="js/draggable.js"></script>

</body>
</html>
